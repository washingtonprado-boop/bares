<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#d4a574">
    <title>Sistema de Gest√£o - Bar Premium</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #d4a574;
            --primary-dark: #b8915f;
            --primary-light: #e8c9a0;
            --secondary: #1a1a1a;
            --accent: #4a9d4e;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --background: #0f0f0f;
            --surface: #1a1a1a;
            --surface-light: #2a2a2a;
            --text: #ffffff;
            --text-secondary: #888888;
            --border: #333333;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        /* MODO CLARO */
        [data-theme="light"] {
            --primary: #d4a574;
            --primary-dark: #b8915f;
            --primary-light: #f5e6d3;
            --secondary: #f5f5f5;
            --accent: #4a9d4e;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-light: #ffffff;
            --text: #2c3e50;
            --text-secondary: #6c757d;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        /* Transi√ß√£o suave ao mudar tema */
        body, 
        div, 
        button, 
        input, 
        select, 
        textarea {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(-100%); 
            }
            to { 
                transform: translateX(0); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }
        
        @keyframes shine {
            0% { 
                background-position: -200% center; 
            }
            100% { 
                background-position: 200% center; 
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Glass morphism */
        .glass {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Bot√µes modernos */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #000;
            box-shadow: 0 4px 15px rgba(212, 165, 116, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(212, 165, 116, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent), #45a049);
            color: #fff;
            box-shadow: 0 4px 15px rgba(74, 157, 78, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: #fff;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* Cards modernos */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--primary);
        }
        
        /* Input moderno */
        .input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        }
        
        .input::placeholder {
            color: var(--text-secondary);
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: var(--primary);
            color: #000;
        }
        
        .badge-success {
            background: var(--accent);
            color: #fff;
        }
        
        .badge-danger {
            background: var(--danger);
            color: #fff;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useRef } = React;

const firebaseConfig = {
    apiKey: "AIzaSyBC2DuHu1P0fKUOJpm_PpWAGiKkEEPyMu8",
    authDomain: "bares-bae14.firebaseapp.com",
    databaseURL: "https://bares-bae14-default-rtdb.firebaseio.com",
    projectId: "bares-bae14",
    storageBucket: "bares-bae14.firebasestorage.app",
    messagingSenderId: "581436771219",
    appId: "1:581436771219:web:b60519997b643b86fc7666"
};

let db;
try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('‚úÖ Firebase conectado');
} catch (e) {
    console.error('‚ùå Firebase erro:', e);
}

// Verificar se QRCode est√° dispon√≠vel
setTimeout(() => {
    if (window.QRCode) {
        console.log('‚úÖ Biblioteca QRCode carregada');
    } else {
        console.error('‚ùå Biblioteca QRCode n√£o carregada!');
    }
}, 1000);

// Sons diferenciados por tipo de evento
const playSound = (type = 'default') => {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const gain = ctx.createGain();
        gain.connect(ctx.destination);

        const sounds = {
            // üîî Novo pedido - dois bipes agudos
            pedido: [
                {freq:880, start:0,    dur:0.12, vol:0.3},
                {freq:1100,start:0.18, dur:0.12, vol:0.3},
            ],
            // üìû Chamada de gar√ßom - tr√™s bipes m√©dios
            chamada: [
                {freq:660, start:0,    dur:0.1,  vol:0.35},
                {freq:660, start:0.15, dur:0.1,  vol:0.35},
                {freq:880, start:0.30, dur:0.18, vol:0.4},
            ],
            // üõµ Delivery chegou - bipe grave longo
            delivery: [
                {freq:440, start:0,    dur:0.2,  vol:0.35},
                {freq:550, start:0.25, dur:0.2,  vol:0.35},
                {freq:660, start:0.50, dur:0.3,  vol:0.4},
            ],
            // üìÖ Reserva - som suave duplo
            reserva: [
                {freq:523, start:0,    dur:0.15, vol:0.25},
                {freq:659, start:0.2,  dur:0.15, vol:0.25},
            ],
            // ‚úÖ Conta fechada - som de sucesso
            fechamento: [
                {freq:523, start:0,    dur:0.1,  vol:0.25},
                {freq:659, start:0.12, dur:0.1,  vol:0.25},
                {freq:784, start:0.24, dur:0.2,  vol:0.3},
            ],
            // default - bipe simples
            default: [
                {freq:800, start:0,    dur:0.5,  vol:0.3},
            ],
        };

        const seq = sounds[type] || sounds.default;
        seq.forEach(({freq, start, dur, vol}) => {
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.frequency.value = freq;
            g.gain.setValueAtTime(vol, ctx.currentTime + start);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + start + dur);
            osc.start(ctx.currentTime + start);
            osc.stop(ctx.currentTime + start + dur + 0.05);
        });
    } catch(e) {}
};

const INITIAL_CONFIG = {
    barName: 'Meu Bar',
    logo: null,
    masterPin: '0000',
    adminPin: '9999',
    balcaoPin: '8888',
    currency: 'R$',
    tables: 12
};

const INITIAL_PRODUCTS = [
    {id: 1, name: 'Cerveja', price: 12, image: 'üç∫', category: 'Bebidas', active: true},
    {id: 2, name: 'Caipirinha', price: 15, image: 'üçπ', category: 'Bebidas', active: true},
    {id: 3, name: 'Batata Frita', price: 28, image: 'üçü', category: 'Comidas', active: true},
    {id: 4, name: 'Espetinho', price: 8, image: ' ‰∏≤', category: 'Comidas', active: true},
    {id: 5, name: 'Caldo', price: 12, image: 'üç≤', category: 'Comidas', active: true},
    {id: 6, name: 'Caldeir√£o', price: 45, image: 'ü•ò', category: 'Comidas', active: true},
    {id: 7, name: 'A√ßa√≠', price: 18, image: 'üçá', category: 'Sobremesas', active: true},
    {id: 8, name: 'Sorvete', price: 10, image: 'üç¶', category: 'Sobremesas', active: true},
];

const INITIAL_WAITERS = [
    {id: 1, name: 'Jo√£o', pin: '1234', active: true, sales: 0},
    {id: 2, name: 'Maria', pin: '2345', active: true, sales: 0},
];

function PasswordInput({value, onChange, placeholder, style, maxLength, onKeyPress}) {
    const [show, setShow] = useState(false);
    return (
        <div style={{position:'relative'}}>
            <input 
                type={show ? 'text' : 'password'} 
                value={value} 
                onChange={onChange} 
                onKeyPress={onKeyPress}
                placeholder={placeholder} 
                maxLength={maxLength} 
                style={style} 
            />
            <button type="button" onClick={() => setShow(!show)} style={{position:'absolute',right:'1rem',top:'50%',transform:'translateY(-50%)',background:'transparent',border:'none',cursor:'pointer',fontSize:'1.3rem'}}>
                {show ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
            </button>
        </div>
    );
}

function App() {
    const [view, setView] = useState('login');
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [config, setConfig] = useState(INITIAL_CONFIG);
    const [products, setProducts] = useState([]);
    const [waiters, setWaiters] = useState([]);
    const [tables, setTables] = useState([]);
    const [sales, setSales] = useState([]);
    const prevTables = useRef([]);
    
    // Estado do tema (modo claro/escuro)
    const [theme, setTheme] = useState(() => {
        // Carregar tema salvo ou usar escuro como padr√£o
        return localStorage.getItem('theme') || 'dark';
    });
    
    // Aplicar tema ao documento
    useEffect(() => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }, [theme]);
    
    // Fun√ß√£o para alternar tema
    const toggleTheme = () => {
        setTheme(prev => prev === 'dark' ? 'light' : 'dark');
    };
    
    useEffect(() => {
        if (!db) {setLoading(false); return;}
        
        db.ref('config').on('value', s => {
            if (s.val()) setConfig(s.val());
            else db.ref('config').set(INITIAL_CONFIG);
        });
        
        db.ref('products').on('value', s => {
            if (s.val()) setProducts(Object.keys(s.val()).map(k => ({...s.val()[k], id: k})));
            else {
                const obj = {};
                INITIAL_PRODUCTS.forEach(p => obj[p.id] = p);
                db.ref('products').set(obj);
            }
        });
        
        db.ref('sales').on('value', s => {
            if (s.val()) {
                setSales(Object.values(s.val()).sort((a, b) => b.timestamp - a.timestamp));
            }
        });
        
        db.ref('waiters').on('value', s => {
            if (s.val()) setWaiters(Object.values(s.val()));
            else {
                const obj = {};
                INITIAL_WAITERS.forEach(w => obj[w.id] = w);
                db.ref('waiters').set(obj);
            }
        });
        
        db.ref('tables').on('value', s => {
            if (s.val()) {
                const newT = Object.values(s.val());
                if (prevTables.current.length > 0) {
                    newT.forEach(nt => {
                        const ot = prevTables.current.find(t => t.id === nt.id);
                        // Novo pedido pendente
                        if (ot && nt.pending && ot.pending && nt.pending.length > ot.pending.length) {
                            playSound('pedido');
                        }
                        // Chamada de gar√ßom
                        if (ot && nt.callWaiter && !ot.callWaiter) {
                            playSound('chamada');
                        }
                        // Conta fechada (status livre quando era ocupada)
                        if (ot && ot.status === 'ocupada' && nt.status === 'livre') {
                            playSound('fechamento');
                        }
                    });
                }
                prevTables.current = newT;
                setTables(newT);
            } else {
                const obj = {};
                for (let i = 1; i <= INITIAL_CONFIG.tables; i++) {
                    obj[i] = {
                        id: i,
                        status: 'livre',
                        waiter: null,
                        customerName: null,
                        customerPin: null,
                        total: 0,
                        subtotal: 0,
                        tip: 0,
                        orders: [],
                        pending: [],
                        callWaiter: false
                    };
                }
                db.ref('tables').set(obj);
            }
        });
        
        setTimeout(() => setLoading(false), 800);
    }, []);
    
    const prevDeliveries = useRef([]);
    const prevReservas = useRef([]);
    
    useEffect(() => {
        // Som de novo delivery
        const refD = db.ref('deliveries');
        refD.on('value', s => {
            if (s.val()) {
                const list = Object.values(s.val());
                if (prevDeliveries.current.length > 0 && list.length > prevDeliveries.current.length) {
                    playSound('delivery');
                }
                prevDeliveries.current = list;
            }
        });
        // Som de nova reserva
        const refR = db.ref('reservas');
        refR.on('value', s => {
            if (s.val()) {
                const list = Object.values(s.val());
                if (prevReservas.current.length > 0 && list.length > prevReservas.current.length) {
                    playSound('reserva');
                }
                prevReservas.current = list;
            }
        });
        return () => { refD.off(); refR.off(); };
    }, []);

    if (loading) return <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center'}}><h2 style={{color:'#d4a574'}}>Carregando...</h2></div>;
    
    const props = {config, products, waiters, tables, sales, user, setUser, setView, theme, toggleTheme};
    
    if (view === 'login') return <Login {...props} />;
    if (view === 'master') return <Master {...props} />;
    if (view === 'admin') return <Admin {...props} />;
    if (view === 'balcao') return <Balcao {...props} />;
    if (view === 'waiter') return <Waiter {...props} />;
    if (view === 'customer') return <Customer {...props} />;
}

// Componente de Altern√¢ncia de Tema
function ThemeToggle({theme, toggleTheme, style = {}}) {
    return (
        <button
            onClick={toggleTheme}
            style={{
                padding: '0.8rem',
                background: 'var(--surface)',
                border: '2px solid var(--border)',
                borderRadius: '50%',
                color: 'var(--text)',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.3rem',
                width: '45px',
                height: '45px',
                transition: 'all 0.3s ease',
                boxShadow: '0 2px 8px var(--shadow)',
                ...style
            }}
            onMouseEnter={e => {
                e.currentTarget.style.transform = 'scale(1.1) rotate(15deg)';
                e.currentTarget.style.borderColor = 'var(--primary)';
            }}
            onMouseLeave={e => {
                e.currentTarget.style.transform = 'scale(1) rotate(0deg)';
                e.currentTarget.style.borderColor = 'var(--border)';
            }}
            title={theme === 'dark' ? 'Mudar para modo claro' : 'Mudar para modo escuro'}
        >
            {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
        </button>
    );
}

// ‚îÄ‚îÄ‚îÄ Card√°pio P√∫blico (acesso via QR, sem login) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function CardapioPublico({config, tables, setUser, setView, theme, toggleTheme}) {
    const [products, setProducts] = useState([]);
    const [catFilter, setCatFilter] = useState('Todos');

    useEffect(() => {
        db.ref('products').on('value', s => {
            if (s.val()) setProducts(Object.values(s.val()).filter(p=>p.active));
        });
        return () => db.ref('products').off();
    }, []);

    const categories = ['Todos', ...new Set(products.map(p=>p.category))];
    const filtered = products.filter(p => catFilter==='Todos' || p.category===catFilter);

    return (
        <div style={{minHeight:'100vh',background:'var(--background)',color:'var(--text)'}}>
            {/* Header */}
            <div style={{background:'var(--surface)',padding:'1.5rem',textAlign:'center',borderBottom:'3px solid #d4a574',position:'sticky',top:0,zIndex:100}}>
                <div style={{position:'absolute',top:'1rem',right:'1rem'}}>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                </div>
                {config.logo && <img src={config.logo} alt={config.barName} style={{maxHeight:'80px',marginBottom:'0.5rem'}} />}
                <h1 style={{fontSize:'1.8rem',fontWeight:'900',color:'#d4a574',margin:0}}>{config.barName}</h1>
                <p style={{color:'var(--text-secondary)',margin:'0.3rem 0 0',fontSize:'0.9rem'}}>üìã Card√°pio</p>
            </div>

            {/* Filtro categorias */}
            <div style={{padding:'1rem 1.5rem',overflowX:'auto',display:'flex',gap:'0.6rem',background:'var(--surface)',borderBottom:'1px solid var(--border)'}}>
                {categories.map(c=>(
                    <button key={c} onClick={()=>setCatFilter(c)} style={{
                        padding:'0.5rem 1.2rem',
                        background: catFilter===c ? '#d4a574' : 'var(--background)',
                        border:`2px solid ${catFilter===c ? '#d4a574' : 'var(--border)'}`,
                        borderRadius:'20px',
                        color: catFilter===c ? '#000' : 'var(--text)',
                        fontWeight:'700',cursor:'pointer',whiteSpace:'nowrap',fontSize:'0.9rem'
                    }}>{c}</button>
                ))}
            </div>

            {/* Grid de produtos */}
            <div style={{padding:'1.5rem',maxWidth:'900px',margin:'0 auto'}}>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(160px,1fr))',gap:'1.2rem'}}>
                    {filtered.map(p=>(
                        <div key={p.id} style={{
                            background:'var(--surface)',
                            borderRadius:'16px',
                            border:'2px solid var(--border)',
                            padding:'1.2rem',
                            textAlign:'center',
                            boxShadow:'0 4px 12px var(--shadow)'
                        }}>
                            <div style={{fontSize:'3rem',marginBottom:'0.8rem'}}>
                                {p.imageType==='upload'
                                    ? <img src={p.image} style={{width:'60px',height:'60px',borderRadius:'10px',objectFit:'cover'}} />
                                    : p.image}
                            </div>
                            <div style={{fontWeight:'800',fontSize:'1rem',marginBottom:'0.4rem'}}>{p.name}</div>
                            <div style={{color:'#d4a574',fontWeight:'900',fontSize:'1.2rem'}}>{config.currency} {parseFloat(p.price).toFixed(2)}</div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Rodap√© */}
            <div style={{textAlign:'center',padding:'2rem',color:'var(--text-secondary)',fontSize:'0.85rem',borderTop:'1px solid var(--border)'}}>
                <p>Para fazer seu pedido, informe ao gar√ßom ou use o link da sua mesa.</p>
            </div>
        </div>
    );
}

function Login({config, tables, waiters, setUser, setView, theme, toggleTheme}) {
    const [mode, setMode] = useState('staff');
    const [pin, setPin] = useState('');
    const [mesa, setMesa] = useState('');
    const [nome, setNome] = useState('');
    const [ask, setAsk] = useState(false);
    const [cardapioPublico, setCardapioPublico] = useState(false);
    
    // Detectar acesso via QR Code
    useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const mesaParam = urlParams.get('mesa');
        const cardapioParam = urlParams.get('cardapio');
        
        // Card√°pio p√∫blico via QR
        if (cardapioParam === '1') {
            setCardapioPublico(true);
            return;
        }
        
        if (mesaParam) {
            // Cliente veio via QR Code
            setMode('customer');
            setMesa(mesaParam);
            
            // Verificar status da mesa
            const table = tables.find(t => t.id === parseInt(mesaParam));
            if (table) {
                if (table.status === 'livre') {
                    // Mesa livre, pedir nome
                    setAsk(true);
                } else {
                    // Mesa ocupada, n√£o pode acessar via QR Code
                    alert('‚ùå Esta mesa j√° est√° ocupada! Por favor, solicite ajuda ao gar√ßom.');
                    // Limpar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
    }, [tables]);
    
    const go = () => {
        // Primeiro verifica sistema de usu√°rios
        db.ref('users').once('value').then(snapshot => {
            const users = snapshot.val();
            if (users) {
                const user = Object.values(users).find(u => u.pin === pin && u.active);
                if (user) {
                    // Usu√°rio encontrado no novo sistema
                    if (user.role === 'waiter') {
                        // Para gar√ßons, precisa buscar o waiterId
                        const waiter = waiters.find(w => w.pin === pin && w.active);
                        if (waiter) {
                            setUser({name:user.name, role:'waiter', waiterId:waiter.id});
                            setView('waiter');
                        } else {
                            setUser({name:user.name, role:user.role});
                            setView(user.role);
                        }
                    } else {
                        setUser({name:user.name, role:user.role});
                        setView(user.role);
                    }
                    return;
                }
            }
            
            // Fallback para sistema antigo (compatibilidade)
            if (pin === '0000') {setUser({name:'Master',role:'master'}); setView('master');}
            else if (pin === '9999') {setUser({name:'Admin',role:'admin'}); setView('admin');}
            else if (pin === '8888') {setUser({name:'Balc√£o',role:'balcao'}); setView('balcao');}
            else {
                const w = waiters.find(x => x.pin === pin && x.active);
                if (w) {setUser({name:w.name,role:'waiter',waiterId:w.id}); setView('waiter');}
                else alert('‚ùå PIN incorreto!');
            }
        });
    };
    
    // Card√°pio p√∫blico (acesso via QR sem login)
    if (cardapioPublico) {
        return <CardapioPublico config={config} tables={tables} setUser={setUser} setView={setView} theme={theme} toggleTheme={toggleTheme} />;
    }
    
    return (
        <div className="fade-in" style={{
            minHeight:'100vh',
            display:'flex',
            alignItems:'center',
            justifyContent:'center',
            padding:'2rem',
            background:'linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)',
            position:'relative',
            overflow:'hidden'
        }}>
            {/* Background decorativo */}
            <div style={{
                position:'absolute',
                top:'-50%',
                right:'-20%',
                width:'600px',
                height:'600px',
                background:'radial-gradient(circle, rgba(212,165,116,0.05) 0%, transparent 70%)',
                borderRadius:'50%',
                pointerEvents:'none'
            }}></div>
            <div style={{
                position:'absolute',
                bottom:'-30%',
                left:'-10%',
                width:'400px',
                height:'400px',
                background:'radial-gradient(circle, rgba(74,157,78,0.03) 0%, transparent 70%)',
                borderRadius:'50%',
                pointerEvents:'none'
            }}></div>
            
            <div className="glass" style={{
                maxWidth:'480px',
                width:'100%',
                padding:'3rem',
                borderRadius:'24px',
                boxShadow:'0 20px 60px rgba(0,0,0,0.5)',
                position:'relative',
                zIndex:1
            }}>
                {/* Bot√£o de Tema */}
                <div style={{position:'absolute',top:'1.5rem',right:'1.5rem',zIndex:10}}>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                </div>
                
                {/* Logo e Nome do Bar */}
                <div style={{textAlign:'center',marginBottom:'3rem'}}>
                    {config.logo ? (
                        <div style={{
                            marginBottom:'1.5rem',
                            background:'rgba(212,165,116,0.05)',
                            padding:'1.5rem',
                            borderRadius:'20px',
                            display:'inline-block'
                        }}>
                            <img src={config.logo} alt={config.barName} style={{
                                maxWidth:'280px',
                                height:'auto',
                                maxHeight:'180px',
                                objectFit:'contain',
                                filter:'drop-shadow(0 4px 10px rgba(212,165,116,0.3))'
                            }} />
                        </div>
                    ) : (
                        <div style={{
                            fontSize:'5rem',
                            marginBottom:'1rem',
                            filter:'drop-shadow(0 4px 10px rgba(212,165,116,0.3))'
                        }}>üç∫</div>
                    )}
                    <h1 className="gradient-text" style={{
                        fontSize:'2.5rem',
                        marginBottom:'0.5rem',
                        fontWeight:'900',
                        letterSpacing:'-0.5px'
                    }}>{config.barName}</h1>
                    <p style={{
                        color:'var(--text-secondary)',
                        fontSize:'0.95rem',
                        fontWeight:'500'
                    }}>Sistema de Gest√£o</p>
                </div>
                
                {/* Tabs de sele√ß√£o */}
                <div style={{
                    display:'grid',
                    gridTemplateColumns:'1fr 1fr',
                    gap:'0.75rem',
                    marginBottom:'2.5rem',
                    padding:'0.5rem',
                    background:'var(--surface)',
                    borderRadius:'14px'
                }}>
                    <button 
                        onClick={() => {setMode('staff');setAsk(false);}} 
                        className={mode==='staff' ? 'btn-primary' : ''}
                        style={{
                            padding:'1rem',
                            background:mode==='staff' ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'transparent',
                            border:'none',
                            borderRadius:'10px',
                            color:mode==='staff' ? '#000' : 'var(--text-secondary)',
                            fontWeight:'700',
                            fontSize:'0.95rem',
                            cursor:'pointer',
                            transition:'all 0.3s ease',
                            boxShadow: mode==='staff' ? '0 4px 15px rgba(212,165,116,0.3)' : 'none'
                        }}
                    >
                        üëë EQUIPE
                    </button>
                    <button 
                        onClick={() => {setMode('customer');setAsk(false);}} 
                        className={mode==='customer' ? 'btn-success' : ''}
                        style={{
                            padding:'1rem',
                            background:mode==='customer' ? 'linear-gradient(135deg, var(--accent), #45a049)' : 'transparent',
                            border:'none',
                            borderRadius:'10px',
                            color:mode==='customer' ? '#fff' : 'var(--text-secondary)',
                            fontWeight:'700',
                            fontSize:'0.95rem',
                            cursor:'pointer',
                            transition:'all 0.3s ease',
                            boxShadow: mode==='customer' ? '0 4px 15px rgba(74,157,78,0.3)' : 'none'
                        }}
                    >
                        üë• CLIENTE
                    </button>
                </div>
                
                {mode === 'staff' && !ask && (
                    <div className="slide-in">
                        <PasswordInput 
                            value={pin} 
                            onChange={e => setPin(e.target.value)} 
                            onKeyPress={e => {if (e.key === 'Enter') go();}}
                            placeholder="Digite seu PIN" 
                            maxLength={4} 
                            style={{
                                width:'100%',
                                padding:'1.2rem 1.5rem',
                                background:'var(--surface)',
                                border:'2px solid var(--border)',
                                borderRadius:'12px',
                                color:'var(--text)',
                                fontSize:'1.1rem',
                                textAlign:'center',
                                marginBottom:'1.5rem',
                                letterSpacing:'0.3rem',
                                fontWeight:'600',
                                transition:'all 0.3s ease'
                            }} 
                        />
                        <button 
                            onClick={go} 
                            className="btn btn-primary"
                            style={{
                                width:'100%',
                                marginBottom:'1.5rem'
                            }}
                        >
                            ENTRAR
                        </button>
                        <div style={{
                            padding:'1.2rem',
                            background:'rgba(212,165,116,0.05)',
                            borderRadius:'12px',
                            border:'1px solid rgba(212,165,116,0.1)'
                        }}>
                            <p style={{color:'var(--text-secondary)',fontSize:'0.8rem',marginBottom:'0.8rem',fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.5px'}}>Perfis de Acesso</p>
                            <div style={{display:'grid',gap:'0.5rem'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>üëë Master</span>
                                    <span className="badge badge-primary">Acesso Total</span>
                                </div>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>‚öôÔ∏è Admin</span>
                                    <span className="badge badge-success">Gerenciamento</span>
                                </div>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>üí∞ Balc√£o</span>
                                    <span style={{
                                        padding:'0.4rem 0.8rem',
                                        borderRadius:'20px',
                                        fontSize:'0.85rem',
                                        fontWeight:'600',
                                        background:'#e67e22',
                                        color:'#fff'
                                    }}>Mesas & Pedidos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {mode === 'customer' && !ask && (
                    <div>
                        <input 
                            type="number" 
                            value={mesa} 
                            onChange={e => setMesa(e.target.value)} 
                            onKeyPress={e => {
                                if (e.key === 'Enter') {
                                    const t = tables.find(x => x.id === parseInt(mesa));
                                    if (!t) {alert('‚ùå Mesa inv√°lida'); return;}
                                    if (t.status === 'livre') {
                                        setAsk(true);
                                    } else {
                                        // Mesa ocupada - mostrar mensagem amig√°vel antes de pedir senha
                                        if (confirm('‚ö†Ô∏è MESA OCUPADA\n\nEsta mesa j√° est√° em uso.\n\nüì± Se esta √© SUA mesa, clique em OK para inserir sua senha.\n\n‚ùå Se n√£o √© sua mesa, clique em CANCELAR.')) {
                                            const senha = prompt('üîê Digite a senha de 4 d√≠gitos da sua mesa:');
                                            if (!senha) return;
                                            
                                            if (t.customerPin && senha === t.customerPin) {
                                                // Senha correta
                                                sessionStorage.setItem('tableId', mesa);
                                                sessionStorage.setItem('customerPin', senha);
                                                setUser({tableId: parseInt(mesa)});
                                                setView('customer');
                                            } else {
                                                alert('‚ùå Senha incorreta!\n\nEsta mesa pertence a outro cliente.\nSolicite ajuda ao gar√ßom.');
                                            }
                                        }
                                    }
                                }
                            }}
                            placeholder="N√∫mero da Mesa" 
                            style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #444',borderRadius:'10px',color:'#fff',fontSize:'1.3rem',textAlign:'center',marginBottom:'1.5rem'}} 
                        />
                        <button onClick={() => {
                            const t = tables.find(x => x.id === parseInt(mesa));
                            if (!t) {alert('‚ùå Mesa inv√°lida'); return;}
                            if (t.status === 'livre') {
                                setAsk(true);
                            } else {
                                // Mesa ocupada - mostrar mensagem amig√°vel antes de pedir senha
                                if (confirm('‚ö†Ô∏è MESA OCUPADA\n\nEsta mesa j√° est√° em uso.\n\nüì± Se esta √© SUA mesa, clique em OK para inserir sua senha.\n\n‚ùå Se n√£o √© sua mesa, clique em CANCELAR.')) {
                                    const senha = prompt('üîê Digite a senha de 4 d√≠gitos da sua mesa:');
                                    if (!senha) return;
                                    
                                    if (t.customerPin && senha === t.customerPin) {
                                        // Senha correta
                                        sessionStorage.setItem('tableId', mesa);
                                        sessionStorage.setItem('customerPin', senha);
                                        setUser({tableId: parseInt(mesa)});
                                        setView('customer');
                                    } else {
                                        alert('‚ùå Senha incorreta!\n\nEsta mesa pertence a outro cliente.\nSolicite ajuda ao gar√ßom.');
                                    }
                                }
                            }
                        }} style={{width:'100%',padding:'1.3rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1.1rem'}}>ACESSAR</button>
                    </div>
                )}
                
                {ask && (
                    <div>
                        <div style={{textAlign:'center',marginBottom:'2rem',padding:'1.5rem',background:'rgba(74,157,78,0.1)',borderRadius:'10px'}}>
                            <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>üéâ</div>
                            <h3 style={{color:'#4a9d4e',fontSize:'1.5rem'}}>Mesa {mesa} Livre!</h3>
                        </div>
                        <input 
                            type="text" 
                            value={nome} 
                            onChange={e => setNome(e.target.value)} 
                            onKeyPress={e => {
                                if (e.key === 'Enter') {
                                    document.querySelector('input[type="password"]').focus();
                                }
                            }}
                            placeholder="Seu Nome" 
                            style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #444',borderRadius:'10px',color:'#fff',fontSize:'1.1rem',textAlign:'center',marginBottom:'1rem'}} 
                        />
                        <input 
                            type="password" 
                            value={pin} 
                            onChange={e => setPin(e.target.value)} 
                            onKeyPress={e => {
                                if (e.key === 'Enter') {
                                    if (!nome.trim()) return alert('Digite seu nome!');
                                    if (!pin || pin.length !== 4) return alert('Crie uma senha de 4 d√≠gitos!');
                                    
                                    const updateData = {
                                        status:'ocupada',
                                        customerName:nome,
                                        customerPin:pin,
                                        openedAt:Date.now()
                                    };
                                    
                                    db.ref(`tables/${mesa}`).update(updateData);
                                    sessionStorage.setItem('tableId', mesa);
                                    sessionStorage.setItem('customerPin', pin);
                                    setUser({tableId: parseInt(mesa)});
                                    setView('customer');
                                }
                            }}
                            placeholder="Senha (4 d√≠gitos)" 
                            maxLength="4" 
                            style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #444',borderRadius:'10px',color:'#fff',fontSize:'1.1rem',textAlign:'center',marginBottom:'1.5rem'}} 
                        />
                        <p style={{color:'#888',fontSize:'0.85rem',textAlign:'center',marginBottom:'1.5rem'}}>üí° Crie uma senha para acessar sua mesa novamente caso saia do app</p>
                        
                        <div style={{display:'flex',gap:'1rem'}}>
                            <button onClick={() => {setAsk(false);}} style={{flex:1,padding:'1.2rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>VOLTAR</button>
                            <button onClick={() => {
                                if (!nome.trim()) return alert('Digite seu nome!');
                                if (!pin || pin.length !== 4) return alert('Crie uma senha de 4 d√≠gitos!');
                                
                                const updateData = {
                                    status:'ocupada',
                                    customerName:nome,
                                    customerPin:pin,
                                    openedAt:Date.now()
                                };
                                
                                db.ref(`tables/${mesa}`).update(updateData);
                                sessionStorage.setItem('tableId', mesa);
                                sessionStorage.setItem('customerPin', pin);
                                setUser({tableId: parseInt(mesa)});
                                setView('customer');
                            }} style={{flex:2,padding:'1.2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>ABRIR MESA</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}


function Master({config, products, waiters, tables, sales, setView, theme, toggleTheme}) {
    const [tab, setTab] = useState('config');
    const [modal, setModal] = useState(null);
    const [edit, setEdit] = useState(null);
    
    // CORRE√á√ÉO: Sincronizar n√∫mero de mesas com config
    useEffect(() => {
        if (config.tables && tables.length > 0) {
            const currentCount = tables.length;
            const configCount = parseInt(config.tables);
            
            if (currentCount !== configCount) {
                const obj = {};
                
                // Preservar mesas existentes
                for (let i = 1; i <= configCount; i++) {
                    const existingTable = tables.find(t => t.id === i);
                    if (existingTable) {
                        obj[i] = existingTable;
                    } else {
                        obj[i] = {
                            id: i,
                            status: 'livre',
                            waiter: null,
                            customerName: null,
                            customerPin: null,
                            total: 0,
                            subtotal: 0,
                            tip: 0,
                            orders: [],
                            pending: [],
                            callWaiter: false
                        };
                    }
                }
                
                db.ref('tables').set(obj);
            }
        }
    }, [config.tables]);
    
    return (
        <div style={{minHeight:'100vh',background:'#0a0a0a'}}>
            <header style={{background:'var(--surface)',padding:'1.5rem',borderBottom:'2px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    {config.logo && <img src={config.logo} alt={config.barName} style={{maxWidth:'150px',height:'100px'}} />}
                    <h1 style={{color:'var(--primary)',fontSize:'1.8rem',fontWeight:'900'}}>üëë MASTER</h1>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                    <button onClick={() => setView('login')} style={{padding:'0.8rem 1.5rem',background:'var(--primary)',border:'none',borderRadius:'10px',color:'#000',fontWeight:'800',cursor:'pointer'}}>SAIR</button>
                </div>
            </header>
            
            <nav style={{background:'#0f0f0f',borderBottom:'2px solid #222',display:'flex',overflowX:'auto'}}>
                <button onClick={() => setTab('config')} style={{padding:'1.2rem 2rem',background:tab==='config'?'#1a1a1a':'transparent',border:'none',color:tab==='config'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>‚öôÔ∏è CONFIG</button>
                <button onClick={() => setTab('usuarios')} style={{padding:'1.2rem 2rem',background:tab==='usuarios'?'#1a1a1a':'transparent',border:'none',color:tab==='usuarios'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üë• USU√ÅRIOS</button>
                <button onClick={() => setTab('products')} style={{padding:'1.2rem 2rem',background:tab==='products'?'#1a1a1a':'transparent',border:'none',color:tab==='products'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üì¶ PRODUTOS</button>
                <button onClick={() => setTab('waiters')} style={{padding:'1.2rem 2rem',background:tab==='waiters'?'#1a1a1a':'transparent',border:'none',color:tab==='waiters'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üë®‚Äçüç≥ GAR√áONS</button>
                <button onClick={() => setTab('reservas')} style={{padding:'1.2rem 2rem',background:tab==='reservas'?'#1a1a1a':'transparent',border:'none',color:tab==='reservas'?'#3498db':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üìÖ RESERVAS</button>
                <button onClick={() => setTab('cardapio')} style={{padding:'1.2rem 2rem',background:tab==='cardapio'?'#1a1a1a':'transparent',border:'none',color:tab==='cardapio'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üìã CARD√ÅPIO QR</button>
                <button onClick={() => setTab('clientes')} style={{padding:'1.2rem 2rem',background:tab==='clientes'?'#1a1a1a':'transparent',border:'none',color:tab==='clientes'?'#9b59b6':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üèÜ CLIENTES</button>
                <button onClick={() => setTab('relatorios')} style={{padding:'1.2rem 2rem',background:tab==='relatorios'?'#1a1a1a':'transparent',border:'none',color:tab==='relatorios'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap'}}>üìä RELAT√ìRIOS</button>
            </nav>
            
            <main style={{padding:'2rem',maxWidth:'1200px',margin:'0 auto'}}>
                {tab === 'config' && <ConfigTab config={config} />}
                {tab === 'usuarios' && <UsersTab config={config} waiters={waiters} onAdd={() => setModal('user')} onEdit={(u) => {setEdit(u); setModal('user');}} />}
                {tab === 'products' && <ProductsTab products={products} config={config} onAdd={() => setModal('product')} onEdit={(p) => {setEdit(p); setModal('product');}} />}
                {tab === 'waiters' && <WaitersTab waiters={waiters} onAdd={() => setModal('waiter')} onEdit={(w) => {setEdit(w); setModal('waiter');}} />}
                {tab === 'reservas' && <ReservasTab config={config} tables={tables} onAdd={() => setModal('reserva')} />}
                {tab === 'cardapio' && <CardapioQRTab products={products} config={config} />}
                {tab === 'clientes' && <ClientesTab sales={sales} config={config} />}
                {tab === 'relatorios' && (
                    <div>
                        <h2 style={{color:'#d4a574',fontSize:'2rem',marginBottom:'2rem',fontWeight:'900'}}>üìä Relat√≥rios Gerenciais</h2>
                        
                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(250px,1fr))',gap:'1.5rem',marginBottom:'3rem'}}>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #d4a574',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üí∞</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Faturamento Atual</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#d4a574'}}>
                                    {config.currency} {tables.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #4a9d4e',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üìà</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Total Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#4a9d4e'}}>
                                    {config.currency} {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).reduce((sum, s) => sum + s.total, 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #3498db',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üèÜ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Total Geral</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#3498db'}}>
                                    {config.currency} {(sales || []).reduce((sum, s) => sum + s.total, 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #e67e22',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üßæ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Vendas Totais</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#e67e22'}}>
                                    {(sales || []).length}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #9b59b6',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üõµ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Vendas Delivery</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#9b59b6'}}>
                                    {(sales || []).filter(s => s.type === 'delivery').length}
                                </div>
                                <div style={{fontSize:'1rem',fontWeight:'700',color:'#9b59b6',marginTop:'0.3rem'}}>
                                    {config.currency} {(sales || []).filter(s => s.type === 'delivery').reduce((sum,s)=>sum+s.total,0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        {/* Relat√≥rio Delivery */}
                        {(sales||[]).filter(s=>s.type==='delivery').length > 0 && (
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem',border:'2px solid #9b59b6'}}>
                            <h3 style={{color:'#9b59b6',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üõµ Hist√≥rico Delivery</h3>
                            {(sales||[]).filter(s=>s.type==='delivery').slice(0,10).map(s=>(
                                <div key={s.id} style={{background:'#0a0a0a',padding:'1.2rem',borderRadius:'12px',marginBottom:'0.8rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <div>
                                        <div style={{fontWeight:'800',fontSize:'1.1rem'}}>{s.customerName}</div>
                                        <div style={{color:'#888',fontSize:'0.85rem'}}>üìû {s.customerPhone} ¬∑ üìç {s.address}</div>
                                        <div style={{color:'#888',fontSize:'0.85rem'}}>
                                            {s.payment === 'dinheiro' ? 'üíµ Dinheiro' : s.payment === 'pix' ? 'üí† PIX' : 'üí≥ Cart√£o'}
                                            {s.troco > 0 ? ` ¬∑ Troco p/ ${config.currency} ${s.troco.toFixed(2)}` : ''}
                                            ¬∑ {new Date(s.date).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}
                                        </div>
                                    </div>
                                    <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#9b59b6'}}>{config.currency} {s.total.toFixed(2)}</div>
                                </div>
                            ))}
                        </div>
                        )}
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#d4a574',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üë®‚Äçüç≥ Performance dos Gar√ßons</h3>
                            {waiters.filter(w => w.active).map(waiter => {
                                const waiterSales = (sales || []).filter(s => s.waiter === waiter.id);
                                const total = waiterSales.reduce((s, sale) => s + sale.total, 0);
                                const today = waiterSales.filter(s => {
                                    const saleDate = new Date(s.date);
                                    const todayDate = new Date();
                                    return saleDate.toDateString() === todayDate.toDateString();
                                });
                                return (
                                    <div key={waiter.id} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                        <div>
                                            <div style={{fontWeight:'800',fontSize:'1.3rem',marginBottom:'0.3rem'}}>{waiter.name}</div>
                                            <div style={{color:'#888'}}>
                                                {waiterSales.length} vendas total ‚Ä¢ {today.length} hoje
                                            </div>
                                        </div>
                                        <div style={{fontSize:'2rem',fontWeight:'900',color:'#d4a574'}}>
                                            {config.currency} {total.toFixed(2)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#d4a574',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üèÜ Top 10 Produtos</h3>
                            {(() => {
                                const productStats = {};
                                (sales || []).forEach(sale => {
                                    sale.orders.forEach(order => {
                                        if (!productStats[order.id]) {
                                            productStats[order.id] = {
                                                name: order.name,
                                                image: order.image,
                                                quantity: 0,
                                                revenue: 0
                                            };
                                        }
                                        productStats[order.id].quantity += order.quantity;
                                        productStats[order.id].revenue += order.price * order.quantity;
                                    });
                                });
                                
                                return Object.values(productStats)
                                    .sort((a, b) => b.revenue - a.revenue)
                                    .slice(0, 10)
                                    .map((product, i) => (
                                        <div key={i} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                            <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                                                <div style={{background:'#d4a574',color:'#000',width:'35px',height:'35px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'900'}}>{i+1}</div>
                                                <div style={{fontSize:'2.5rem'}}>{product.image}</div>
                                                <div>
                                                    <div style={{fontWeight:'800',fontSize:'1.2rem'}}>{product.name}</div>
                                                    <div style={{color:'#888'}}>{product.quantity} vendidos</div>
                                                </div>
                                            </div>
                                            <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#d4a574'}}>
                                                {config.currency} {product.revenue.toFixed(2)}
                                            </div>
                                        </div>
                                    ));
                            })()}
                        </div>
                    </div>
                )}
            </main>
            
            {modal === 'product' && <ProductModal edit={edit} config={config} onClose={() => {setModal(null); setEdit(null);}} />}
            {modal === 'waiter' && <WaiterModal edit={edit} onClose={() => {setModal(null); setEdit(null);}} />}
            {modal === 'user' && <UserModal edit={edit} onClose={() => {setModal(null); setEdit(null);}} />}
            {modal === 'reserva' && <ReservaModal tables={tables} config={config} onClose={() => setModal(null)} />}
        </div>
    );
}

function ConfigTab({config}) {
    const [d, setD] = useState(config);
    const save = () => {db.ref('config').set(d); alert('‚úÖ Salvo!');};
    
    const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('‚ùå Por favor, selecione uma imagem!');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // Criar canvas para redimensionar
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Dimens√µes fixas 300x200
                canvas.width = 300;
                canvas.height = 200;
                
                // Desenhar imagem redimensionada
                ctx.drawImage(img, 0, 0, 300, 200);
                
                // Converter para base64
                const base64 = canvas.toDataURL('image/png');
                setD({...d, logo: base64});
                alert('‚úÖ Logo carregada! Clique em SALVAR para confirmar.');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    
    const removeLogo = () => {
        if (confirm('Remover logo?')) {
            setD({...d, logo: null});
        }
    };
    
    return (
        <div style={{maxWidth:'600px'}}>
            <h2 style={{color:'#d4a574',fontSize:'2rem',marginBottom:'2rem'}}>Configura√ß√µes</h2>
            <div style={{display:'grid',gap:'1.5rem'}}>
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>Nome do Bar</label>
                    <input value={d.barName} onChange={e => setD({...d, barName: e.target.value})} style={{width:'100%',padding:'1rem',background:'#1a1a1a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                </div>
                
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>Logo do Bar (300x200px)</label>
                    {d.logo ? (
                        <div style={{background:'#1a1a1a',border:'2px solid #333',borderRadius:'10px',padding:'1.5rem',textAlign:'center'}}>
                            <img src={d.logo} alt="Logo" style={{maxWidth:'300px',height:'200px',marginBottom:'1rem'}} />
                            <div style={{display:'flex',gap:'1rem'}}>
                                <label style={{flex:1,padding:'1rem',background:'#3498db',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',textAlign:'center'}}>
                                    üì§ TROCAR LOGO
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} style={{display:'none'}} />
                                </label>
                                <button onClick={removeLogo} style={{flex:1,padding:'1rem',background:'#e74c3c',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>
                                    üóëÔ∏è REMOVER
                                </button>
                            </div>
                        </div>
                    ) : (
                        <label style={{display:'block',padding:'3rem',background:'#1a1a1a',border:'2px dashed #333',borderRadius:'10px',textAlign:'center',cursor:'pointer',transition:'all 0.3s'}}
                            onMouseEnter={e => e.currentTarget.style.borderColor = '#d4a574'}
                            onMouseLeave={e => e.currentTarget.style.borderColor = '#333'}
                        >
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üì∑</div>
                            <div style={{color:'#d4a574',fontWeight:'800',fontSize:'1.1rem',marginBottom:'0.5rem'}}>Clique para adicionar logo</div>
                            <div style={{color:'#888',fontSize:'0.85rem'}}>Recomendado: 300x200 pixels</div>
                            <input type="file" accept="image/*" onChange={handleLogoUpload} style={{display:'none'}} />
                        </label>
                    )}
                </div>
                
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>N√∫mero de Mesas (1-50)</label>
                    <input type="number" min="1" max="50" value={d.tables} onChange={e => setD({...d, tables: parseInt(e.target.value) || 1})} style={{width:'100%',padding:'1rem',background:'#1a1a1a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <p style={{color:'#888',fontSize:'0.85rem',marginTop:'0.5rem'}}>‚ö†Ô∏è Recarregue ap√≥s salvar</p>
                </div>
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>PIN Master</label>
                    <PasswordInput value={d.masterPin} onChange={e => setD({...d, masterPin: e.target.value})} maxLength={4} style={{width:'100%',padding:'1rem',background:'#1a1a1a',border:'1px solid #333',borderRadius:'10px',color:'#fff',fontSize:'1.5rem',textAlign:'center'}} />
                </div>
                <button onClick={save} style={{padding:'1.2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1.1rem'}}>üíæ SALVAR</button>
                
                {/* BOT√ÉO LIMPAR DADOS */}
                <div style={{marginTop:'2rem',padding:'1.5rem',background:'#2a1a1a',border:'2px solid #e74c3c',borderRadius:'12px'}}>
                    <h3 style={{color:'#e74c3c',fontSize:'1.3rem',marginBottom:'0.5rem'}}>‚ö†Ô∏è Zona de Perigo</h3>
                    <p style={{color:'#888',fontSize:'0.9rem',marginBottom:'1rem'}}>Use esta fun√ß√£o para limpar TODAS as vendas e resetar as mesas. Ideal para come√ßar o sistema do zero.</p>
                    <button 
                        onClick={() => {
                            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai APAGAR:\n\n‚Ä¢ Todas as vendas\n‚Ä¢ Todos os pedidos\n‚Ä¢ Todas as mesas ocupadas\n\nDeseja continuar?')) return;
                            
                            if (!confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nTem CERTEZA que deseja limpar TODOS os dados de vendas?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!')) return;
                            
                            // Limpar vendas
                            db.ref('sales').remove();
                            
                            // Resetar todas as mesas
                            const resetTables = {};
                            for (let i = 1; i <= config.tables; i++) {
                                resetTables[i] = {
                                    id: i,
                                    status: 'livre',
                                    waiter: null,
                                    orders: [],
                                    pending: [],
                                    total: 0,
                                    subtotal: 0,
                                    tip: 0,
                                    callWaiter: false
                                };
                            }
                            db.ref('tables').set(resetTables);
                            
                            alert('‚úÖ Dados limpos com sucesso!\n\n‚Ä¢ Vendas apagadas\n‚Ä¢ Mesas resetadas\n\nSistema pronto para come√ßar!');
                        }}
                        style={{
                            width:'100%',
                            padding:'1.2rem',
                            background:'#e74c3c',
                            border:'none',
                            borderRadius:'10px',
                            color:'#fff',
                            fontWeight:'800',
                            cursor:'pointer',
                            fontSize:'1.1rem'
                        }}
                    >
                        üóëÔ∏è LIMPAR TODAS AS VENDAS E RESETAR MESAS
                    </button>
                </div>
            </div>
        </div>
    );
}

function UsersTab({config, waiters, onAdd, onEdit}) {
    const [users, setUsers] = useState([]);
    
    useEffect(() => {
        // Carregar usu√°rios do Firebase
        db.ref('users').on('value', snapshot => {
            if (snapshot.val()) {
                setUsers(Object.values(snapshot.val()));
            } else {
                // Inicializar usu√°rios padr√£o
                const defaultUsers = {
                    master: {
                        id: 'master',
                        name: 'Master',
                        pin: config.masterPin || '0000',
                        role: 'master',
                        active: true,
                        canEdit: false // Master n√£o pode ser editado/exclu√≠do
                    },
                    admin: {
                        id: 'admin',
                        name: 'Admin',
                        pin: config.adminPin || '9999',
                        role: 'admin',
                        active: true,
                        canEdit: true
                    },
                    balcao: {
                        id: 'balcao',
                        name: 'Balc√£o',
                        pin: config.balcaoPin || '8888',
                        role: 'balcao',
                        active: true,
                        canEdit: true
                    }
                };
                db.ref('users').set(defaultUsers);
            }
        });
        
        return () => db.ref('users').off();
    }, []);
    
    const deleteUser = (userId) => {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        if (!user.canEdit) {
            alert('‚ùå Este usu√°rio n√£o pode ser exclu√≠do!');
            return;
        }
        
        if (!confirm(`‚ùå Excluir usu√°rio "${user.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) return;
        
        db.ref(`users/${userId}`).remove();
        alert('‚úÖ Usu√°rio exclu√≠do!');
    };
    
    const toggleActive = (userId) => {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        db.ref(`users/${userId}/active`).set(!user.active);
    };
    
    const roleNames = {
        master: 'üëë Master',
        admin: '‚öôÔ∏è Admin',
        balcao: 'üí∞ Balc√£o',
        waiter: 'üë®‚Äçüç≥ Gar√ßom',
        custom: 'üîß Personalizado'
    };
    
    const roleColors = {
        master: '#d4a574',
        admin: '#3498db',
        balcao: '#e67e22',
        waiter: '#4a9d4e',
        custom: '#9b59b6'
    };
    
    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                <h2 style={{color:'#d4a574',fontSize:'2rem',fontWeight:'900'}}>üë• Gerenciamento de Usu√°rios</h2>
                <button 
                    onClick={onAdd}
                    style={{
                        padding:'1rem 2rem',
                        background:'linear-gradient(135deg, #4a9d4e, #45a049)',
                        border:'none',
                        borderRadius:'12px',
                        color:'#fff',
                        fontWeight:'800',
                        cursor:'pointer',
                        fontSize:'1rem',
                        boxShadow:'0 4px 15px rgba(74,157,78,0.3)'
                    }}
                >
                    + NOVO USU√ÅRIO
                </button>
            </div>
            
            <div style={{display:'grid',gap:'1.5rem'}}>
                {users.map(user => (
                    <div 
                        key={user.id}
                        style={{
                            background:'#1a1a1a',
                            padding:'2rem',
                            borderRadius:'16px',
                            border:`2px solid ${roleColors[user.role] || '#333'}`,
                            display:'flex',
                            justifyContent:'space-between',
                            alignItems:'center',
                            opacity: user.active ? 1 : 0.5
                        }}
                    >
                        <div style={{flex:1}}>
                            <div style={{display:'flex',alignItems:'center',gap:'1rem',marginBottom:'0.5rem'}}>
                                <h3 style={{fontSize:'1.5rem',fontWeight:'900',margin:0}}>{user.name}</h3>
                                <span style={{
                                    padding:'0.4rem 1rem',
                                    background: roleColors[user.role] || '#666',
                                    borderRadius:'20px',
                                    fontSize:'0.85rem',
                                    fontWeight:'700',
                                    color: user.role === 'master' ? '#000' : '#fff'
                                }}>
                                    {roleNames[user.role] || user.role}
                                </span>
                                {!user.active && (
                                    <span style={{
                                        padding:'0.4rem 1rem',
                                        background:'#e74c3c',
                                        borderRadius:'20px',
                                        fontSize:'0.85rem',
                                        fontWeight:'700',
                                        color:'#fff'
                                    }}>
                                        INATIVO
                                    </span>
                                )}
                            </div>
                            <div style={{color:'#888',fontSize:'0.95rem'}}>
                                PIN: {user.pin ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'N√£o definido'}
                            </div>
                            <div style={{color:'#666',fontSize:'0.85rem',marginTop:'0.3rem'}}>
                                ID: {user.id}
                            </div>
                        </div>
                        
                        <div style={{display:'flex',gap:'1rem'}}>
                            {user.canEdit !== false && (
                                <>
                                    <button
                                        onClick={() => toggleActive(user.id)}
                                        style={{
                                            padding:'0.8rem 1.5rem',
                                            background: user.active ? '#6c757d' : '#4a9d4e',
                                            border:'none',
                                            borderRadius:'10px',
                                            color:'#fff',
                                            fontWeight:'800',
                                            cursor:'pointer',
                                            fontSize:'0.9rem'
                                        }}
                                    >
                                        {user.active ? '‚ùå DESATIVAR' : '‚úÖ ATIVAR'}
                                    </button>
                                    <button
                                        onClick={() => onEdit(user)}
                                        style={{
                                            padding:'0.8rem 1.5rem',
                                            background:'#3498db',
                                            border:'none',
                                            borderRadius:'10px',
                                            color:'#fff',
                                            fontWeight:'800',
                                            cursor:'pointer',
                                            fontSize:'0.9rem'
                                        }}
                                    >
                                        ‚úèÔ∏è EDITAR
                                    </button>
                                    <button
                                        onClick={() => deleteUser(user.id)}
                                        style={{
                                            padding:'0.8rem 1.5rem',
                                            background:'#e74c3c',
                                            border:'none',
                                            borderRadius:'10px',
                                            color:'#fff',
                                            fontWeight:'800',
                                            cursor:'pointer',
                                            fontSize:'0.9rem'
                                        }}
                                    >
                                        üóëÔ∏è EXCLUIR
                                    </button>
                                </>
                            )}
                            {user.canEdit === false && (
                                <div style={{
                                    padding:'0.8rem 1.5rem',
                                    background:'rgba(212,165,116,0.1)',
                                    border:'2px solid #d4a574',
                                    borderRadius:'10px',
                                    color:'#d4a574',
                                    fontWeight:'800',
                                    fontSize:'0.9rem'
                                }}>
                                    üîí PROTEGIDO
                                </div>
                            )}
                        </div>
                    </div>
                ))}
            </div>
            
            {users.length === 0 && (
                <div style={{
                    textAlign:'center',
                    padding:'4rem',
                    background:'#1a1a1a',
                    borderRadius:'16px',
                    border:'2px dashed #333'
                }}>
                    <div style={{fontSize:'4rem',marginBottom:'1rem'}}>üë•</div>
                    <h3 style={{fontSize:'1.5rem',marginBottom:'0.5rem'}}>Nenhum usu√°rio cadastrado</h3>
                    <p style={{color:'#888'}}>Clique em "NOVO USU√ÅRIO" para come√ßar</p>
                </div>
            )}
        </div>
    );
}

// Componente para renderizar √≠cone/imagem do produto
function ProductIcon({product, size = '3rem', style = {}}) {
    if (product.imageType === 'upload' && product.image && product.image.startsWith('data:')) {
        return (
            <img 
                src={product.image} 
                alt={product.name}
                style={{
                    width: size === '3rem' ? '60px' : size === '2rem' ? '40px' : size,
                    height: size === '3rem' ? '60px' : size === '2rem' ? '40px' : size,
                    objectFit: 'cover',
                    borderRadius: '8px',
                    ...style
                }}
            />
        );
    }
    return <div style={{fontSize: size, ...style}}>{product.image}</div>;
}

function ProductsTab({products, config, onAdd, onEdit}) {
    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
                <h2 style={{color:'#d4a574',fontSize:'2rem'}}>Produtos</h2>
                <button onClick={onAdd} style={{padding:'1rem 2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>+ NOVO</button>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'1.5rem'}}>
                {products.map(p => (
                    <div key={p.id} onClick={() => onEdit(p)} style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',cursor:'pointer',textAlign:'center'}}>
                        <div style={{marginBottom:'0.8rem',display:'flex',justifyContent:'center',alignItems:'center',minHeight:'60px'}}>
                            <ProductIcon product={p} />
                        </div>
                        <div style={{fontWeight:'800',marginBottom:'0.5rem'}}>{p.name}</div>
                        <div style={{color:'#d4a574',fontSize:'1.2rem',fontWeight:'900'}}>{config.currency} {p.price.toFixed(2)}</div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function WaitersTab({waiters, onAdd, onEdit}) {
    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
                <h2 style={{color:'#d4a574',fontSize:'2rem'}}>Gar√ßons</h2>
                <button onClick={onAdd} style={{padding:'1rem 2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>+ NOVO</button>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(250px,1fr))',gap:'1.5rem'}}>
                {waiters.map(w => (
                    <div key={w.id} onClick={() => onEdit(w)} style={{background:'#1a1a1a',padding:'2rem',borderRadius:'12px',border:'2px solid #333',cursor:'pointer',textAlign:'center'}}>
                        <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üë®‚Äçüç≥</div>
                        <div style={{fontWeight:'800',fontSize:'1.2rem',marginBottom:'0.5rem'}}>{w.name}</div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function ProductModal({edit, config, onClose}) {
    const [d, setD] = useState(edit || {id: Date.now(), name: '', price: 0, image: 'üç∫', imageType: 'emoji', category: 'Bebidas', active: true});
    const [showEmojiPicker, setShowEmojiPicker] = useState(false);
    
    const emojis = {
        'Bebidas': [
            // Cervejas e Chopp
            'üç∫', 'üçª', 
            // Vinhos e Champagne
            'üç∑', 'üçæ', 'ü•Ç',
            // Drinks e Coquet√©is
            'üç∏', 'üçπ', 'üßâ',
            // Bebidas Quentes
            '‚òï', 'üçµ', 'ü´ñ',
            // Refrigerantes e Sucos
            'ü•§', 'üßÉ', 'üßã',
            // Outras
            'ü•õ', 'üç∂', 'ü•É'
        ],
        'Comidas': [
            // Pizzas
            'üçï',
            // Carnes e Espetinhos
            'üçó', 'üçñ', 'ü•©', 'ü•ì', 'üç±',
            // Hamb√∫rgueres e Sandu√≠ches
            'üçî', 'ü•™', 'üå≠',
            // Batatas e Acompanhamentos
            'üçü', 'ü•î',
            // Pratos Quentes e Caldos
            'üç≤', 'ü•ò', 'üçú', 'üçù', 'üçõ',
            // Mexicano
            'üåÆ', 'üåØ', 'ü•ô', 'üßÜ',
            // Frutos do Mar
            'ü¶ê', 'üç§', 'ü¶ë', 'üêô', 'ü¶û', 'ü¶Ä', 'üêü', 'üê†', 'ü¶à', 'üç£', 'üç±',
            // Sushi e Japon√™s
            'üçô', 'üçö', 'ü•ü', 'üç¢',
            // Saladas
            'ü•ó', 'ü•ô',
            // Sobremesas
            'üç∞', 'üéÇ', 'üßÅ', 'üçÆ', 'üç©', 'üç™', 'üç´', 'üç¨', 'üç≠',
            // Sorvetes
            'üç¶', 'üçß', 'üç®',
            // Frutas
            'üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù',
            // Lanches
            'ü•®', 'ü•ñ', 'ü•ê', 'üßÄ', 'ü•ö',
            // Aperitivos
            'üå∞', 'ü•ú', 'üçø',
            // Outros
            'ü•ß', 'üçï', 'ü´ì', 'ü•ô'
        ]
    };
    
    const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('‚ùå Por favor, selecione uma imagem!');
            return;
        }
        
        // Limitar tamanho (500KB)
        if (file.size > 500000) {
            alert('‚ùå Imagem muito grande! M√°ximo 500KB.\n\nDica: Use sites como TinyPNG.com para comprimir.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // Criar canvas para redimensionar
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Dimens√µes fixas 100x100 para √≠cones
                canvas.width = 100;
                canvas.height = 100;
                
                // Desenhar imagem redimensionada
                ctx.drawImage(img, 0, 0, 100, 100);
                
                // Converter para base64
                const base64 = canvas.toDataURL('image/png');
                setD({...d, image: base64, imageType: 'upload'});
                alert('‚úÖ Imagem carregada! Clique em SALVAR para confirmar.');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    
    const removeImage = () => {
        if (confirm('Remover imagem e voltar para emoji?')) {
            setD({...d, image: 'üç∫', imageType: 'emoji'});
        }
    };
    
    const save = () => {db.ref(`products/${d.id}`).set(d); alert('‚úÖ Salvo!'); onClose();};
    const del = () => {if (confirm('Deletar?')) {db.ref(`products/${d.id}`).remove(); onClose();}};
    
    return (
        <div onClick={onClose} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'1rem',overflowY:'auto'}}>
            <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'600px',width:'100%',border:'2px solid #d4a574',maxHeight:'90vh',overflowY:'auto'}}>
                <h3 style={{color:'#d4a574',fontSize:'1.8rem',marginBottom:'2rem'}}>{edit ? 'Editar' : 'Novo'} Produto</h3>
                <div style={{display:'grid',gap:'1rem'}}>
                    <input placeholder="Nome" value={d.name} onChange={e => setD({...d, name: e.target.value})} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <input type="number" placeholder="Pre√ßo" value={d.price || ''} onChange={e => setD({...d, price: parseFloat(e.target.value) || 0})} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <select value={d.category} onChange={e => setD({...d, category: e.target.value})} style={{padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}}>
                        <option>Bebidas</option>
                        <option>Comidas</option>
                    </select>
                    
                    <div>
                        <label style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.5rem',display:'block',fontWeight:'700'}}>√çcone/Imagem do Produto:</label>
                        
                        {/* Preview do √≠cone atual */}
                        <div style={{
                            background:'#0a0a0a',
                            border:'2px solid #d4a574',
                            borderRadius:'12px',
                            padding:'1.5rem',
                            marginBottom:'1rem',
                            textAlign:'center'
                        }}>
                            <div style={{fontSize:'0.85rem',color:'#888',marginBottom:'0.5rem',fontWeight:'600'}}>
                                {d.imageType === 'upload' ? 'IMAGEM PERSONALIZADA' : 'EMOJI'}
                            </div>
                            {d.imageType === 'upload' ? (
                                <img src={d.image} alt="Produto" style={{width:'100px',height:'100px',objectFit:'cover',borderRadius:'8px'}} />
                            ) : (
                                <div style={{fontSize:'5rem'}}>{d.image}</div>
                            )}
                        </div>
                        
                        {/* Bot√µes de escolha */}
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                            <label style={{
                                padding:'1rem',
                                background:'linear-gradient(135deg, #3498db, #2980b9)',
                                border:'none',
                                borderRadius:'10px',
                                color:'#fff',
                                fontWeight:'800',
                                cursor:'pointer',
                                textAlign:'center',
                                transition:'all 0.3s',
                                display:'flex',
                                alignItems:'center',
                                justifyContent:'center',
                                gap:'0.5rem'
                            }}
                            onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-2px)'}
                            onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                üì§ ENVIAR IMAGEM
                                <input type="file" accept="image/*" onChange={handleImageUpload} style={{display:'none'}} />
                            </label>
                            <button 
                                onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                style={{
                                    padding:'1rem',
                                    background:'linear-gradient(135deg, #d4a574, #c89557)',
                                    border:'none',
                                    borderRadius:'10px',
                                    color:'#000',
                                    fontWeight:'800',
                                    cursor:'pointer',
                                    transition:'all 0.3s'
                                }}
                                onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-2px)'}
                                onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}
                            >
                                {showEmojiPicker ? '‚ñ≤ FECHAR EMOJIS' : 'üòÄ USAR EMOJI'}
                            </button>
                        </div>
                        
                        {d.imageType === 'upload' && (
                            <button 
                                onClick={removeImage}
                                style={{
                                    width:'100%',
                                    padding:'0.8rem',
                                    background:'#e74c3c',
                                    border:'none',
                                    borderRadius:'10px',
                                    color:'#fff',
                                    fontWeight:'800',
                                    cursor:'pointer',
                                    marginBottom:'1rem',
                                    fontSize:'0.9rem'
                                }}
                            >
                                üóëÔ∏è REMOVER IMAGEM
                            </button>
                        )}
                        
                        <div style={{
                            padding:'1rem',
                            background:'rgba(52,152,219,0.1)',
                            border:'1px solid rgba(52,152,219,0.3)',
                            borderRadius:'10px',
                            marginBottom:'1rem'
                        }}>
                            <div style={{fontSize:'0.85rem',color:'#3498db',fontWeight:'600',marginBottom:'0.3rem'}}>üí° Dicas:</div>
                            <ul style={{margin:0,paddingLeft:'1.5rem',color:'#888',fontSize:'0.8rem',lineHeight:'1.6'}}>
                                <li>Imagem m√°ximo 500KB</li>
                                <li>Ser√° redimensionada para 100x100px</li>
                                <li>Formatos: JPG, PNG, GIF, WebP</li>
                                <li>Prefira imagens quadradas</li>
                            </ul>
                        </div>
                        
                        {showEmojiPicker && (
                            <div style={{
                                marginTop:'1rem',
                                padding:'1.5rem',
                                background:'#0a0a0a',
                                borderRadius:'10px',
                                border:'1px solid #333'
                            }}>
                                <h4 style={{color:'#d4a574',marginBottom:'1rem'}}>
                                    {d.category === 'Bebidas' ? 'üç∫ Bebidas' : 'üçó Comidas'}
                                </h4>
                                <div style={{
                                    display:'grid',
                                    gridTemplateColumns:'repeat(auto-fill,minmax(50px,1fr))',
                                    gap:'0.5rem',
                                    maxHeight:'200px',
                                    overflowY:'auto'
                                }}>
                                    {emojis[d.category].map((emoji, i) => (
                                        <button
                                            key={i}
                                            onClick={() => {
                                                setD({...d, image: emoji, imageType: 'emoji'});
                                                setShowEmojiPicker(false);
                                            }}
                                            style={{
                                                padding:'0.8rem',
                                                background: d.image === emoji && d.imageType === 'emoji' ? '#d4a574' : '#1a1a1a',
                                                border:'2px solid #333',
                                                borderRadius:'8px',
                                                fontSize:'2rem',
                                                cursor:'pointer',
                                                transition:'all 0.2s'
                                            }}
                                            onMouseEnter={e => e.currentTarget.style.transform = 'scale(1.1)'}
                                            onMouseLeave={e => e.currentTarget.style.transform = 'scale(1)'}
                                        >
                                            {emoji}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
                <div style={{display:'flex',gap:'1rem',marginTop:'2rem'}}>
                    {edit && <button onClick={del} style={{padding:'1rem',background:'#e74c3c',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>DELETAR</button>}
                    <button onClick={onClose} style={{flex:1,padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                    <button onClick={save} style={{flex:1,padding:'1rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SALVAR</button>
                </div>
            </div>
        </div>
    );
}

function WaiterModal({edit, onClose}) {
    const [d, setD] = useState(edit || {id: Date.now(), name: '', pin: '', active: true, sales: 0});
    const save = () => {db.ref(`waiters/${d.id}`).set(d); alert('‚úÖ Salvo!'); onClose();};
    const del = () => {if (confirm('Deletar?')) {db.ref(`waiters/${d.id}`).remove(); onClose();}};
    
    return (
        <div onClick={onClose} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999}}>
            <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'450px',width:'100%',border:'2px solid #d4a574'}}>
                <h3 style={{color:'#d4a574',fontSize:'1.8rem',marginBottom:'2rem'}}>{edit ? 'Editar' : 'Novo'} Gar√ßom</h3>
                <div style={{display:'grid',gap:'1rem'}}>
                    <input placeholder="Nome" value={d.name} onChange={e => setD({...d, name: e.target.value})} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <PasswordInput placeholder="PIN" value={d.pin} onChange={e => setD({...d, pin: e.target.value})} maxLength={4} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff',fontSize:'1.5rem',textAlign:'center'}} />
                </div>
                <div style={{display:'flex',gap:'1rem',marginTop:'2rem'}}>
                    {edit && <button onClick={del} style={{padding:'1rem',background:'#e74c3c',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>DELETAR</button>}
                    <button onClick={onClose} style={{flex:1,padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                    <button onClick={save} style={{flex:1,padding:'1rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SALVAR</button>
                </div>
            </div>
        </div>
    );
}

function UserModal({edit, onClose}) {
    const [d, setD] = useState(edit || {
        id: Date.now().toString(),
        name: '',
        pin: '',
        role: 'custom',
        active: true,
        canEdit: true
    });
    
    const save = () => {
        if (!d.name.trim()) {
            alert('‚ùå Nome √© obrigat√≥rio!');
            return;
        }
        
        if (!d.pin || d.pin.length !== 4) {
            alert('‚ùå PIN deve ter 4 d√≠gitos!');
            return;
        }
        
        // Verificar se PIN j√° existe (exceto se estiver editando o mesmo usu√°rio)
        db.ref('users').once('value').then(snapshot => {
            const users = snapshot.val() || {};
            const pinExists = Object.values(users).some(u => 
                u.pin === d.pin && u.id !== d.id
            );
            
            if (pinExists) {
                alert('‚ùå Este PIN j√° est√° em uso! Escolha outro.');
                return;
            }
            
            // Salvar usu√°rio
            db.ref(`users/${d.id}`).set(d);
            alert('‚úÖ Usu√°rio salvo!');
            onClose();
        });
    };
    
    const del = () => {
        if (!d.canEdit) {
            alert('‚ùå Este usu√°rio n√£o pode ser exclu√≠do!');
            return;
        }
        
        if (confirm(`‚ùå Excluir usu√°rio "${d.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
            db.ref(`users/${d.id}`).remove();
            alert('‚úÖ Usu√°rio exclu√≠do!');
            onClose();
        }
    };
    
    const roleOptions = [
        {value: 'admin', label: '‚öôÔ∏è Admin', desc: 'Acesso total ao sistema'},
        {value: 'balcao', label: 'üí∞ Balc√£o', desc: 'Gerenciar mesas e pedidos'},
        {value: 'waiter', label: 'üë®‚Äçüç≥ Gar√ßom', desc: 'Ver apenas suas mesas'},
        {value: 'custom', label: 'üîß Personalizado', desc: 'Permiss√µes customizadas'}
    ];
    
    return (
        <div onClick={onClose} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'1rem'}}>
            <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'500px',width:'100%',border:'2px solid #d4a574',maxHeight:'90vh',overflowY:'auto'}}>
                <h3 style={{color:'#d4a574',fontSize:'1.8rem',marginBottom:'2rem',fontWeight:'900'}}>
                    {edit ? '‚úèÔ∏è Editar Usu√°rio' : '‚ûï Novo Usu√°rio'}
                </h3>
                
                <div style={{display:'grid',gap:'1.5rem'}}>
                    {/* Nome */}
                    <div>
                        <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>Nome do Usu√°rio</label>
                        <input 
                            placeholder="Ex: Jo√£o Silva" 
                            value={d.name} 
                            onChange={e => setD({...d, name: e.target.value})} 
                            style={{
                                width:'100%',
                                padding:'1rem',
                                background:'#0a0a0a',
                                border:'1px solid #333',
                                borderRadius:'10px',
                                color:'#fff',
                                fontSize:'1rem'
                            }} 
                        />
                    </div>
                    
                    {/* PIN */}
                    <div>
                        <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>PIN (4 d√≠gitos)</label>
                        <PasswordInput 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                            value={d.pin} 
                            onChange={e => setD({...d, pin: e.target.value})} 
                            maxLength={4} 
                            style={{
                                width:'100%',
                                padding:'1rem',
                                background:'#0a0a0a',
                                border:'1px solid #333',
                                borderRadius:'10px',
                                color:'#fff',
                                fontSize:'1.5rem',
                                textAlign:'center',
                                letterSpacing:'0.5rem'
                            }} 
                        />
                        <p style={{color:'#666',fontSize:'0.85rem',marginTop:'0.5rem'}}>üí° Use um PIN √∫nico que ningu√©m mais usa</p>
                    </div>
                    
                    {/* Perfil/Fun√ß√£o */}
                    <div>
                        <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>Perfil de Acesso</label>
                        <div style={{display:'grid',gap:'0.8rem'}}>
                            {roleOptions.map(role => (
                                <div
                                    key={role.value}
                                    onClick={() => setD({...d, role: role.value})}
                                    style={{
                                        padding:'1rem',
                                        background: d.role === role.value ? '#d4a574' : '#0a0a0a',
                                        border: `2px solid ${d.role === role.value ? '#d4a574' : '#333'}`,
                                        borderRadius:'10px',
                                        cursor:'pointer',
                                        transition:'all 0.3s'
                                    }}
                                >
                                    <div style={{
                                        fontWeight:'800',
                                        marginBottom:'0.3rem',
                                        color: d.role === role.value ? '#000' : '#fff'
                                    }}>
                                        {role.label}
                                    </div>
                                    <div style={{
                                        fontSize:'0.85rem',
                                        color: d.role === role.value ? '#333' : '#888'
                                    }}>
                                        {role.desc}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Status */}
                    <div>
                        <label style={{display:'flex',alignItems:'center',gap:'0.8rem',cursor:'pointer',padding:'1rem',background:'#0a0a0a',borderRadius:'10px',border:'1px solid #333'}}>
                            <input 
                                type="checkbox" 
                                checked={d.active} 
                                onChange={e => setD({...d, active: e.target.checked})}
                                style={{width:'20px',height:'20px',cursor:'pointer'}}
                            />
                            <div>
                                <div style={{fontWeight:'800',color:'#fff'}}>Usu√°rio Ativo</div>
                                <div style={{fontSize:'0.85rem',color:'#888'}}>Permitir login no sistema</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                {/* Bot√µes */}
                <div style={{display:'flex',gap:'1rem',marginTop:'2rem'}}>
                    {edit && d.canEdit !== false && (
                        <button 
                            onClick={del} 
                            style={{
                                padding:'1rem 1.5rem',
                                background:'#e74c3c',
                                border:'none',
                                borderRadius:'10px',
                                color:'#fff',
                                fontWeight:'800',
                                cursor:'pointer',
                                fontSize:'0.95rem'
                            }}
                        >
                            üóëÔ∏è EXCLUIR
                        </button>
                    )}
                    <button 
                        onClick={onClose} 
                        style={{
                            flex:1,
                            padding:'1rem',
                            background:'#2a2a2a',
                            border:'none',
                            borderRadius:'10px',
                            color:'#888',
                            fontWeight:'800',
                            cursor:'pointer',
                            fontSize:'0.95rem'
                        }}
                    >
                        CANCELAR
                    </button>
                    <button 
                        onClick={save} 
                        style={{
                            flex:1,
                            padding:'1rem',
                            background:'linear-gradient(135deg, #4a9d4e, #45a049)',
                            border:'none',
                            borderRadius:'10px',
                            color:'#fff',
                            fontWeight:'800',
                            cursor:'pointer',
                            fontSize:'0.95rem',
                            boxShadow:'0 4px 15px rgba(74,157,78,0.3)'
                        }}
                    >
                        üíæ SALVAR
                    </button>
                </div>
            </div>
        </div>
    );
}


function Admin({tables, waiters, products, config, sales, setView, theme, toggleTheme}) {
    const [tab, setTab] = useState('mesas');
    const [selW, setSelW] = useState(null);
    const [qrModal, setQrModal] = useState(null);
    
    const openTable = (id, wId) => {db.ref(`tables/${id}`).update({status: 'ocupada', waiter: wId}); alert('Mesa aberta!');};
    const closeTable = (id) => {
        const table = tables.find(t => t.id === id);
        if (!table) {
            alert('‚ùå Mesa n√£o encontrada!');
            return;
        }
        
        // Verificar se h√° pedidos pendentes
        if (table.pending && table.pending.length > 0) {
            alert('‚ùå N√£o √© poss√≠vel fechar a conta! Ainda h√° pedidos pendentes. Confirme ou cancele os pedidos primeiro.');
            return;
        }
        
        // CORRE√á√ÉO: Garantir valores num√©ricos seguros
        const subtotal = parseFloat(table.subtotal) || 0;
        let tip = parseFloat(table.tip) || 0;
        const total = parseFloat(table.total) || 0;
        
        // PERGUNTAR SOBRE GORJETA SE AINDA N√ÉO FOI ADICIONADA
        if (!tip || tip === 0) {
            const wantTip = confirm('üíù Deseja adicionar gorjeta antes de fechar a conta?');
            
            if (wantTip) {
                const tipOptions = [
                    `10% (${config.currency} ${(total * 0.10).toFixed(2)})`,
                    `15% (${config.currency} ${(total * 0.15).toFixed(2)})`,
                    `20% (${config.currency} ${(total * 0.20).toFixed(2)})`,
                    'Valor Personalizado'
                ];
                
                const choice = prompt(
                    `Escolha a gorjeta:\n\n1 - ${tipOptions[0]}\n2 - ${tipOptions[1]}\n3 - ${tipOptions[2]}\n4 - ${tipOptions[3]}\n\nDigite o n√∫mero da op√ß√£o:`
                );
                
                if (choice === '1') {
                    tip = total * 0.10;
                } else if (choice === '2') {
                    tip = total * 0.15;
                } else if (choice === '3') {
                    tip = total * 0.20;
                } else if (choice === '4') {
                    const customTip = parseFloat(prompt('Digite o valor da gorjeta:'));
                    if (customTip && customTip > 0) {
                        tip = customTip;
                    }
                }
                
                // Salvar gorjeta se foi adicionada
                if (tip > 0) {
                    db.ref(`tables/${id}/tip`).set(tip);
                }
            }
        }
        
        const totalWithTip = total + tip;
        
        // Confirmar fechamento
        let confirmMsg = `Fechar conta da Mesa ${id}?\n\nSubtotal: ${config.currency} ${subtotal.toFixed(2)}`;
        if (tip > 0) {
            confirmMsg += `\nGorjeta: ${config.currency} ${tip.toFixed(2)}`;
        }
        confirmMsg += `\n\nTOTAL: ${config.currency} ${totalWithTip.toFixed(2)}`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        if (totalWithTip > 0) {
            // Salvar venda no hist√≥rico
            const sale = {
                id: Date.now(),
                tableId: id,
                waiter: table.waiter || null,
                waiterName: table.waiter ? waiters.find(w => w.id === table.waiter)?.name || 'Sem gar√ßom' : 'Cliente direto',
                customerName: table.customerName || 'Cliente',
                subtotal: subtotal,
                tip: tip,
                total: totalWithTip,
                orders: table.orders || [],
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            db.ref(`sales/${sale.id}`).set(sale).catch(error => {
                console.error('Erro ao salvar venda:', error);
                alert('‚ö†Ô∏è Aviso: Erro ao salvar no hist√≥rico, mas a mesa ser√° fechada.');
            });
        }
        
        // Resetar mesa
        db.ref(`tables/${id}`).set({
            id: id,
            status: 'livre',
            waiter: null,
            customerName: null,
            customerPin: null,
            total: 0,
            subtotal: 0,
            tip: 0,
            orders: [],
            pending: [],
            callWaiter: false
        }).then(() => {
            alert('‚úÖ Mesa fechada com sucesso!');
        }).catch(error => {
            console.error('Erro ao fechar mesa:', error);
            alert('‚ùå Erro ao fechar mesa! Verifique a conex√£o e tente novamente.');
        });
    };
    
    const showQRCode = (tableId) => {
        setQrModal(tableId);
        
        // Gerar QR Code ap√≥s modal abrir
        setTimeout(() => {
            const canvas = document.getElementById(`qr-canvas-${tableId}`);
            if (!canvas) {
                console.error('Canvas n√£o encontrado');
                return;
            }
            
            const url = `${window.location.href.split('?')[0]}?mesa=${tableId}`;
            
            if (window.QRCode) {
                window.QRCode.toCanvas(canvas, url, {
                    width: 300,
                    margin: 2,
                    color: {dark: '#000000', light: '#ffffff'}
                }, (error) => {
                    if (error) {
                        console.error('Erro ao gerar QR Code:', error);
                        alert('‚ùå Erro ao gerar QR Code!');
                    } else {
                        console.log('‚úÖ QR Code gerado com sucesso!');
                    }
                });
            } else {
                console.error('Biblioteca QRCode n√£o carregada');
                alert('‚ùå Erro: Biblioteca QRCode n√£o carregada!');
            }
        }, 200);
    };
    
    const confirmOrder = (id, idx) => {
        const t = tables.find(x => x.id === id);
        const o = t.pending[idx];
        const newO = [...t.orders, o];
        const newP = t.pending.filter((_, i) => i !== idx);
        const newS = t.subtotal + (o.price * o.quantity);
        const newT = newS + (newS * config.serviceCharge / 100);
        db.ref(`tables/${id}`).update({orders: newO, pending: newP, subtotal: newS, total: newT});
        alert('Confirmado!');
    };
    
    return (
        <div style={{minHeight:'100vh',background:'#0a0a0a'}}>
            <header style={{background:'var(--surface)',padding:'1.5rem',borderBottom:'2px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    {config.logo && <img src={config.logo} alt={config.barName} style={{maxWidth:'150px',height:'100px'}} />}
                    <h1 style={{color:'#4a9d4e',fontSize:'1.8rem',fontWeight:'900'}}>üë®‚Äçüíº ADMIN</h1>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                    <button onClick={() => setView('login')} style={{padding:'0.8rem 1.5rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SAIR</button>
                </div>
            </header>
            
            <nav style={{background:'#0f0f0f',borderBottom:'2px solid #222',display:'flex'}}>
                <button onClick={() => setTab('mesas')} style={{padding:'1.2rem 2rem',background:tab==='mesas'?'#1a1a1a':'transparent',border:'none',color:tab==='mesas'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer'}}>üìã MESAS</button>
                <button onClick={() => setTab('pedidos')} style={{padding:'1.2rem 2rem',background:tab==='pedidos'?'#1a1a1a':'transparent',border:'none',color:tab==='pedidos'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer'}}>üîî PEDIDOS</button>
                <button onClick={() => setTab('chamadas')} style={{padding:'1.2rem 2rem',background:tab==='chamadas'?'#1a1a1a':'transparent',border:'none',color:tab==='chamadas'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer',position:'relative'}}>
                    üìû CHAMADAS
                    {tables.filter(t => t.callWaiter).length > 0 && (
                        <span style={{position:'absolute',top:'0.5rem',right:'0.5rem',background:'#e74c3c',color:'#fff',fontSize:'0.7rem',fontWeight:'900',padding:'0.2rem 0.5rem',borderRadius:'50%',minWidth:'1.2rem',height:'1.2rem',display:'flex',alignItems:'center',justifyContent:'center'}}>
                            {tables.filter(t => t.callWaiter).length}
                        </span>
                    )}
                </button>
                <button onClick={() => setTab('relatorios')} style={{padding:'1.2rem 2rem',background:tab==='relatorios'?'#1a1a1a':'transparent',border:'none',color:tab==='relatorios'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer'}}>üìä RELAT√ìRIOS</button>
            </nav>
            
            <main style={{padding:'2rem',maxWidth:'1400px',margin:'0 auto'}}>
                {tab === 'mesas' && (
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'1.5rem'}}>
                        {tables.map(t => (
                            <div key={t.id} style={{
                                background:'#1a1a1a',
                                padding:'1.5rem',
                                borderRadius:'12px',
                                border:`3px solid ${t.callWaiter ? '#e74c3c' : t.status==='livre'?'#4a9d4e':'#d4a017'}`,
                                position:'relative',
                                animation: t.callWaiter ? 'blink 1.5s infinite' : 'none'
                            }}>
                                {t.callWaiter && (
                                    <div style={{position:'absolute',top:'-10px',right:'-10px',background:'#e74c3c',color:'#fff',fontSize:'1.5rem',width:'40px',height:'40px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',animation:'pulse 1s infinite',boxShadow:'0 0 20px rgba(231,76,60,0.8)'}}>
                                        üîî
                                    </div>
                                )}
                                <div style={{fontSize:'1.5rem',fontWeight:'800',marginBottom:'0.5rem'}}>Mesa {t.id}</div>
                                <div style={{fontSize:'0.85rem',padding:'0.3rem 0.8rem',borderRadius:'20px',display:'inline-block',background:t.status==='livre'?'#4a9d4e':'#d4a017',color:'#fff',fontWeight:'800',marginBottom:'0.5rem'}}>
                                    {t.status.toUpperCase()}
                                </div>
                                {t.status === 'ocupada' ? (
                                    <>
                                        {/* Alerta: Mesa sem gar√ßom */}
                                        {!t.waiter && (
                                            <div style={{
                                                background:'linear-gradient(135deg, #f39c12, #e67e22)',
                                                padding:'0.8rem',
                                                borderRadius:'10px',
                                                marginTop:'0.8rem',
                                                marginBottom:'0.8rem',
                                                textAlign:'center',
                                                animation:'pulse 2s infinite',
                                                boxShadow:'0 4px 12px rgba(243,156,18,0.5)'
                                            }}>
                                                <div style={{fontSize:'1.2rem',marginBottom:'0.2rem'}}>‚ö†Ô∏è</div>
                                                <div style={{color:'#000',fontWeight:'900',fontSize:'0.85rem'}}>SEM GAR√áOM!</div>
                                            </div>
                                        )}
                                        
                                        <div style={{color:'#ccc',fontSize:'0.9rem',marginTop:'0.5rem'}}>
                                            {t.waiter ? (
                                                <div>
                                                    <span style={{color:'#666',fontSize:'0.75rem'}}>Gar√ßom: </span>
                                                    <span style={{color:'#3498db',fontWeight:'700'}}>{waiters.find(w => w.id === t.waiter)?.name}</span>
                                                </div>
                                            ) : (
                                                <div>
                                                    <span style={{color:'#666',fontSize:'0.75rem'}}>Cliente: </span>
                                                    <span style={{color:'#d4a574',fontWeight:'700'}}>{t.customerName}</span>
                                                </div>
                                            )}
                                        </div>
                                        <div style={{fontSize:'1.3rem',fontWeight:'800',color:'#d4a574',marginTop:'0.5rem'}}>{config.currency} {t.total.toFixed(2)}</div>
                                        {t.tip && t.tip > 0 && (
                                            <div style={{fontSize:'0.85rem',color:'#f39c12',marginTop:'0.3rem',fontWeight:'800'}}>
                                                üíù Gorjeta: {config.currency} {t.tip.toFixed(2)}
                                            </div>
                                        )}
                                        {t.callWaiter && (
                                            <button 
                                                onClick={() => db.ref(`tables/${t.id}/callWaiter`).set(false)}
                                                style={{width:'100%',padding:'0.6rem',background:'#e74c3c',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem',marginTop:'0.5rem'}}
                                            >
                                                ‚úì ATENDER CHAMADA
                                            </button>
                                        )}
                                        {!t.waiter && (
                                            <button 
                                                onClick={() => setSelW(t.id)}
                                                style={{
                                                    width:'100%',
                                                    padding:'0.8rem',
                                                    background:'linear-gradient(135deg, #f39c12, #e67e22)',
                                                    border:'none',
                                                    borderRadius:'10px',
                                                    color:'#000',
                                                    fontWeight:'900',
                                                    cursor:'pointer',
                                                    fontSize:'0.9rem',
                                                    marginTop:'0.8rem',
                                                    boxShadow:'0 4px 12px rgba(243,156,18,0.4)',
                                                    animation:'pulse 2s infinite'
                                                }}
                                            >
                                                üë®‚Äçüç≥ ATRIBUIR GAR√áOM
                                            </button>
                                        )}
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem',marginTop:'1rem'}}>
                                            <button onClick={() => showQRCode(t.id)} style={{padding:'0.6rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>üì± QR</button>
                                            <button onClick={() => closeTable(t.id)} style={{padding:'0.6rem',background:'#e67e22',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>FECHAR</button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={() => setSelW(t.id)} style={{width:'100%',marginTop:'1rem',padding:'0.8rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>ABRIR</button>
                                        <button onClick={() => showQRCode(t.id)} style={{width:'100%',marginTop:'0.5rem',padding:'0.6rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>üì± VER QR CODE</button>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                )}
                
                {tab === 'pedidos' && (
                    <div>
                        {tables.filter(t => t.pending && t.pending.length > 0).length === 0 ? (
                            <div style={{textAlign:'center',padding:'4rem',color:'#888'}}>
                                <div style={{fontSize:'4rem',marginBottom:'1rem'}}>‚úì</div>
                                <p style={{fontSize:'1.2rem'}}>Nenhum pedido pendente no momento</p>
                            </div>
                        ) : (
                            tables.filter(t => t.pending && t.pending.length > 0).map(t => (
                                <div key={t.id} style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1.5rem'}}>
                                    <h3 style={{color:'#d4a574',marginBottom:'1rem'}}>Mesa {t.id}</h3>
                                    {t.pending.map((o, i) => (
                                        <div key={i} style={{background:'#0a0a0a',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}>
                                            <div style={{display:'flex',gap:'1rem',marginBottom:'1rem'}}>
                                                <span style={{fontSize:'2rem'}}>{o.image}</span>
                                                <div style={{flex:1}}>
                                                    <div style={{fontWeight:'800'}}>{o.name}</div>
                                                    <div style={{color:'#888'}}>Qtd: {o.quantity} ‚Ä¢ {config.currency} {(o.price * o.quantity).toFixed(2)}</div>
                                                </div>
                                            </div>
                                            <button onClick={() => confirmOrder(t.id, i)} style={{width:'100%',padding:'0.8rem',background:'#4a9d4e',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>‚úì CONFIRMAR</button>
                                        </div>
                                    ))}
                                </div>
                            ))
                        )}
                    </div>
                )}
                
                {tab === 'chamadas' && (
                    <div>
                        <h2 style={{color:'#e74c3c',fontSize:'2rem',marginBottom:'2rem',fontWeight:'900'}}>üìû Chamadas de Gar√ßom</h2>
                        
                        {tables.filter(t => t.callWaiter).length === 0 ? (
                            <div style={{textAlign:'center',padding:'4rem',color:'#888'}}>
                                <div style={{fontSize:'4rem',marginBottom:'1rem'}}>‚úì</div>
                                <p style={{fontSize:'1.2rem'}}>Nenhuma chamada de gar√ßom no momento</p>
                            </div>
                        ) : (
                            <div style={{display:'grid',gap:'1.5rem'}}>
                                {tables.filter(t => t.callWaiter).map(t => (
                                    <div key={t.id} style={{
                                        background:'#1a1a1a',
                                        padding:'2rem',
                                        borderRadius:'16px',
                                        border:'3px solid #e74c3c',
                                        animation:'blink 1.5s infinite',
                                        display:'flex',
                                        alignItems:'center',
                                        gap:'2rem'
                                    }}>
                                        <div style={{fontSize:'4rem',animation:'pulse 1s infinite'}}>üîî</div>
                                        <div style={{flex:1}}>
                                            <h3 style={{fontSize:'2rem',fontWeight:'900',color:'#e74c3c',marginBottom:'0.5rem'}}>Mesa {t.id}</h3>
                                            <div style={{color:'#ccc',fontSize:'1.1rem',marginBottom:'0.3rem'}}>
                                                {t.waiter ? `Gar√ßom: ${waiters.find(w => w.id === t.waiter)?.name}` : `Cliente: ${t.customerName}`}
                                            </div>
                                            <div style={{color:'#888',fontSize:'0.9rem'}}>
                                                Conta atual: {config.currency} {t.total.toFixed(2)}
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => {
                                                db.ref(`tables/${t.id}/callWaiter`).set(false);
                                                playSound();
                                                alert('‚úÖ Chamada atendida!');
                                            }}
                                            style={{
                                                padding:'1.5rem 2.5rem',
                                                background:'#4a9d4e',
                                                border:'none',
                                                borderRadius:'12px',
                                                color:'#fff',
                                                fontWeight:'900',
                                                cursor:'pointer',
                                                fontSize:'1.2rem',
                                                whiteSpace:'nowrap'
                                            }}
                                        >
                                            ‚úì ATENDER
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
                
                {tab === 'relatorios' && (
                    <div>
                        <h2 style={{color:'#4a9d4e',fontSize:'2rem',marginBottom:'2rem',fontWeight:'900'}}>üìä Relat√≥rios</h2>
                        
                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(250px,1fr))',gap:'1.5rem',marginBottom:'3rem'}}>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #4a9d4e',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üí∞</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Faturamento Atual</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#4a9d4e'}}>
                                    {config.currency} {tables.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #d4a574',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üìà</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Total Vendido Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#d4a574'}}>
                                    {config.currency} {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).reduce((sum, s) => sum + s.total, 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #3498db',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üçΩÔ∏è</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Mesas Ativas</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#3498db'}}>
                                    {tables.filter(t => t.status === 'ocupada').length}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #e67e22',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üßæ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Vendas Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#e67e22'}}>
                                    {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).length}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #f39c12',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üíù</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Gorjetas Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#f39c12'}}>
                                    {config.currency} {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).reduce((sum, s) => sum + (s.tip || 0), 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#4a9d4e',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üë®‚Äçüç≥ Vendas e Gorjetas por Gar√ßom (Hoje)</h3>
                            {waiters.filter(w => w.active).map(waiter => {
                                const todaySales = (sales || []).filter(s => {
                                    const saleDate = new Date(s.date);
                                    const today = new Date();
                                    return s.waiter === waiter.id && saleDate.toDateString() === today.toDateString();
                                });
                                const totalSales = todaySales.reduce((s, sale) => s + sale.total, 0);
                                const totalTips = todaySales.reduce((s, sale) => s + (sale.tip || 0), 0);
                                const salesWithTips = todaySales.filter(s => s.tip && s.tip > 0).length;
                                
                                return (
                                    <div key={waiter.id} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
                                            <div>
                                                <div style={{fontWeight:'800',fontSize:'1.2rem',marginBottom:'0.3rem'}}>{waiter.name}</div>
                                                <div style={{color:'#888',fontSize:'0.9rem'}}>{todaySales.length} vendas hoje</div>
                                            </div>
                                            <div style={{textAlign:'right'}}>
                                                <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#4a9d4e'}}>
                                                    {config.currency} {totalSales.toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                        {totalTips > 0 && (
                                            <div style={{borderTop:'1px solid #333',paddingTop:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                                <div style={{color:'#f39c12',fontSize:'0.95rem'}}>
                                                    üíù Gorjetas recebidas ({salesWithTips} {salesWithTips === 1 ? 'venda' : 'vendas'})
                                                </div>
                                                <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#f39c12'}}>
                                                    {config.currency} {totalTips.toFixed(2)}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#4a9d4e',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üïê √öltimas 10 Vendas</h3>
                            {(sales || []).slice(0, 10).map((sale, i) => (
                                <div key={sale.id} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem'}}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                                        <div>
                                            <span style={{fontWeight:'800'}}>Mesa {sale.tableId}</span>
                                            <span style={{color:'#888',marginLeft:'1rem'}}>
                                                {new Date(sale.date).toLocaleString('pt-BR')}
                                            </span>
                                        </div>
                                        <div style={{textAlign:'right'}}>
                                            <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#4a9d4e'}}>
                                                {config.currency} {sale.total.toFixed(2)}
                                            </div>
                                            {sale.tip && sale.tip > 0 && (
                                                <div style={{fontSize:'0.9rem',color:'#f39c12',marginTop:'0.2rem'}}>
                                                    üíù + {config.currency} {sale.tip.toFixed(2)}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div style={{color:'#888',fontSize:'0.9rem'}}>
                                        {sale.waiterName ? `Gar√ßom: ${sale.waiterName}` : `Cliente: ${sale.customerName}`} ‚Ä¢ {sale.orders.length} itens
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </main>
            
            {selW && (
                <div onClick={() => setSelW(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'400px',width:'100%',border:'2px solid #4a9d4e'}}>
                        <h2 style={{color:'#4a9d4e',marginBottom:'2rem',fontSize:'1.8rem'}}>Abrir Mesa {selW}</h2>
                        {waiters.filter(w => w.active).map(w => (
                            <button key={w.id} onClick={() => {openTable(selW, w.id); setSelW(null);}} style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #333',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',marginBottom:'1rem'}}>üë®‚Äçüç≥ {w.name}</button>
                        ))}
                        <button onClick={() => setSelW(null)} style={{width:'100%',padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'12px',color:'#888',fontWeight:'800',cursor:'pointer',marginTop:'1rem'}}>CANCELAR</button>
                    </div>
                </div>
            )}
            
            {qrModal && (
                <div onClick={() => setQrModal(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000,padding:'1rem'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#fff',padding:'3rem',borderRadius:'20px',maxWidth:'500px',width:'100%',textAlign:'center'}}>
                        <h2 style={{color:'#000',marginBottom:'0.5rem',fontSize:'2rem',fontWeight:'900'}}>üçΩÔ∏è Mesa {qrModal}</h2>
                        <p style={{color:'#666',marginBottom:'2rem',fontSize:'0.95rem'}}>Escaneie o QR Code para acessar o card√°pio</p>
                        
                        <div style={{background:'#f5f5f5',padding:'2rem',borderRadius:'12px',marginBottom:'1.5rem',display:'flex',justifyContent:'center',alignItems:'center',minHeight:'340px'}}>
                            <canvas id={`qr-canvas-${qrModal}`}></canvas>
                        </div>
                        
                        <div style={{background:'#f0f0f0',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
                            <p style={{color:'#666',fontSize:'0.75rem',marginBottom:'0.3rem'}}>Link direto:</p>
                            <p style={{color:'#333',fontSize:'0.85rem',fontWeight:'600',wordBreak:'break-all',margin:0}}>
                                {window.location.href.split('?')[0]}?mesa={qrModal}
                            </p>
                        </div>
                        
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                            <button 
                                onClick={() => {
                                    const canvas = document.getElementById(`qr-canvas-${qrModal}`);
                                    if (canvas) {
                                        const link = document.createElement('a');
                                        link.download = `qrcode-mesa-${qrModal}.png`;
                                        link.href = canvas.toDataURL();
                                        link.click();
                                    }
                                }}
                                style={{padding:'1.2rem',background:'#3498db',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}
                            >
                                üíæ BAIXAR
                            </button>
                            <button onClick={() => setQrModal(null)} style={{padding:'1.2rem',background:'#4a9d4e',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}>‚úì FECHAR</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function Balcao({tables, config, waiters, products, setView, theme, toggleTheme}) {
    const [sel, setSel] = useState(null);
    const [selW, setSelW] = useState(null);
    const [qrModal, setQrModal] = useState(null);
    const [tab, setTab] = useState('mesas');
    const [deliveries, setDeliveries] = useState([]);
    const [deliveryModal, setDeliveryModal] = useState(false);
    
    // Carregar deliveries do Firebase
    useEffect(() => {
        db.ref('deliveries').on('value', snap => {
            if (snap.val()) {
                const list = Object.values(snap.val()).sort((a,b) => b.createdAt - a.createdAt);
                setDeliveries(list);
            } else {
                setDeliveries([]);
            }
        });
        return () => db.ref('deliveries').off();
    }, []);
    
    const deliveryPending = deliveries.filter(d => d.status === 'pendente' || d.status === 'preparando').length;
    
    const openTable = (id, wId) => {
        db.ref(`tables/${id}`).update({status: 'ocupada', waiter: wId});
        alert('‚úÖ Mesa aberta!');
        setSelW(null);
    };
    
    const closeTable = (tableId) => {
        const t = tables.find(x => x.id === tableId);
        if (!t) {
            alert('‚ùå Mesa n√£o encontrada!');
            return;
        }
        
        // Verificar se h√° pedidos pendentes
        if (t.pending && t.pending.length > 0) {
            alert('‚ùå N√£o √© poss√≠vel fechar a conta! Ainda h√° ' + t.pending.length + ' pedido(s) pendente(s). Confirme ou cancele os pedidos primeiro.');
            return;
        }
        
        // CORRE√á√ÉO: Garantir valores num√©ricos seguros
        const subtotal = parseFloat(t.subtotal) || 0;
        let tip = parseFloat(t.tip) || 0;
        const total = parseFloat(t.total) || 0;
        
        // PERGUNTAR SOBRE GORJETA SE AINDA N√ÉO FOI ADICIONADA
        if (!tip || tip === 0) {
            const wantTip = confirm('üíù Deseja adicionar gorjeta antes de fechar a conta?');
            
            if (wantTip) {
                const tipOptions = [
                    `10% (${config.currency} ${(total * 0.10).toFixed(2)})`,
                    `15% (${config.currency} ${(total * 0.15).toFixed(2)})`,
                    `20% (${config.currency} ${(total * 0.20).toFixed(2)})`,
                    'Valor Personalizado'
                ];
                
                const choice = prompt(
                    `Escolha a gorjeta:\n\n1 - ${tipOptions[0]}\n2 - ${tipOptions[1]}\n3 - ${tipOptions[2]}\n4 - ${tipOptions[3]}\n\nDigite o n√∫mero da op√ß√£o:`
                );
                
                if (choice === '1') {
                    tip = total * 0.10;
                } else if (choice === '2') {
                    tip = total * 0.15;
                } else if (choice === '3') {
                    tip = total * 0.20;
                } else if (choice === '4') {
                    const customTip = parseFloat(prompt('Digite o valor da gorjeta:'));
                    if (customTip && customTip > 0) {
                        tip = customTip;
                    }
                }
                
                // Salvar gorjeta se foi adicionada
                if (tip > 0) {
                    db.ref(`tables/${tableId}/tip`).set(tip);
                }
            }
        }
        
        const totalWithTip = total + tip;
        
        let confirmMsg = `Fechar conta da Mesa ${tableId}?\n\nSubtotal: ${config.currency} ${subtotal.toFixed(2)}`;
        if (tip > 0) {
            confirmMsg += `\nGorjeta: ${config.currency} ${tip.toFixed(2)}`;
        }
        confirmMsg += `\n\nTOTAL: ${config.currency} ${totalWithTip.toFixed(2)}`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        // Salvar venda no hist√≥rico
        if (totalWithTip > 0) {
            const sale = {
                id: Date.now(),
                tableId: tableId,
                waiter: t.waiter || null,
                waiterName: t.waiter ? waiters.find(w => w.id === t.waiter)?.name || 'Sem gar√ßom' : 'Cliente direto',
                customerName: t.customerName || 'Cliente',
                subtotal: subtotal,
                tip: tip,
                total: totalWithTip,
                orders: t.orders || [],
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            db.ref(`sales/${sale.id}`).set(sale).catch(error => {
                console.error('Erro ao salvar venda:', error);
                alert('‚ö†Ô∏è Erro ao salvar hist√≥rico de venda, mas a mesa ser√° fechada.');
            });
        }
        
        // Resetar mesa
        db.ref(`tables/${tableId}`).set({
            id: tableId,
            status: 'livre',
            waiter: null,
            customerName: null,
            customerPin: null,
            total: 0,
            subtotal: 0,
            tip: 0,
            orders: [],
            pending: [],
            callWaiter: false
        }).then(() => {
            alert('‚úÖ Mesa fechada com sucesso!');
            setSel(null);
        }).catch(error => {
            console.error('Erro ao fechar mesa:', error);
            alert('‚ùå Erro ao fechar mesa! Tente novamente.');
        });
    };
    
    const showQRCode = (tableId) => {
        setQrModal(tableId);
        
        setTimeout(() => {
            const canvas = document.getElementById(`qr-canvas-balcao-${tableId}`);
            if (!canvas) {
                console.error('Canvas n√£o encontrado');
                return;
            }
            
            const url = `${window.location.href.split('?')[0]}?mesa=${tableId}`;
            
            if (window.QRCode) {
                window.QRCode.toCanvas(canvas, url, {
                    width: 300,
                    margin: 2,
                    color: {dark: '#000000', light: '#ffffff'}
                }, (error) => {
                    if (error) {
                        console.error('Erro ao gerar QR Code:', error);
                        alert('‚ùå Erro ao gerar QR Code!');
                    }
                });
            } else {
                console.error('Biblioteca QRCode n√£o carregada');
                alert('‚ùå Erro: Biblioteca QRCode n√£o carregada!');
            }
        }, 200);
    };
    
    const confirmOrder = (tableId, idx) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || !t.pending[idx]) {
            alert('‚ùå Erro: Pedido n√£o encontrado!');
            return;
        }
        
        const o = t.pending[idx];
        const newOrders = [...(t.orders || []), {...o, confirmedAt: Date.now()}];
        const newPending = t.pending.filter((_, i) => i !== idx);
        const newSubtotal = (t.subtotal || 0) + (o.price * o.quantity);
        const newTotal = newSubtotal; // SEM TAXA DE SERVI√áO
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: newPending,
            subtotal: newSubtotal,
            total: newTotal
        }).then(() => {
            playSound();
            alert('‚úÖ Pedido confirmado!');
            // Atualizar o modal com a mesa atualizada
            const updatedTable = tables.find(x => x.id === tableId);
            if (updatedTable && newPending.length === 0) {
                // Se n√£o tem mais pendentes, fecha o modal
                setSel(null);
            }
        }).catch(err => {
            console.error('Erro ao confirmar pedido:', err);
            alert('‚ùå Erro ao confirmar pedido!');
        });
    };
    
    const cancelOrder = (tableId, idx) => {
        if (!confirm('Tem certeza que deseja CANCELAR este pedido?')) return;
        
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || !t.pending[idx]) {
            alert('‚ùå Erro: Pedido n√£o encontrado!');
            return;
        }
        
        const newPending = t.pending.filter((_, i) => i !== idx);
        
        db.ref(`tables/${tableId}/pending`).set(newPending).then(() => {
            alert('‚ùå Pedido cancelado!');
            if (newPending.length === 0) {
                setSel(null);
            }
        }).catch(err => {
            console.error('Erro ao cancelar pedido:', err);
            alert('‚ùå Erro ao cancelar pedido!');
        });
    };
    
    const approveAll = (tableId) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || t.pending.length === 0) {
            alert('‚ùå N√£o h√° pedidos pendentes!');
            return;
        }
        
        if (!confirm(`Aprovar TODOS os ${t.pending.length} pedidos pendentes?`)) {
            return;
        }
        
        // Adicionar todos os pendentes aos confirmados
        const newOrders = [...(t.orders || []), ...t.pending.map(p => ({...p, confirmedAt: Date.now()}))];
        
        // Calcular novo total SEM TAXA
        const pendingTotal = t.pending.reduce((sum, p) => sum + (p.price * p.quantity), 0);
        const newSubtotal = (t.subtotal || 0) + pendingTotal;
        const newTotal = newSubtotal; // SEM TAXA DE SERVI√áO
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: [],
            subtotal: newSubtotal,
            total: newTotal
        }).then(() => {
            playSound();
            alert(`‚úÖ ${t.pending.length} pedidos aprovados!`);
        }).catch(err => {
            console.error('Erro ao aprovar todos:', err);
            alert('‚ùå Erro ao aprovar pedidos!');
        });
    };
    
    const occupiedTables = tables.filter(t => t.status === 'ocupada');
    const pendingCount = tables.reduce((sum, t) => sum + (t.pending ? t.pending.length : 0), 0);
    const totalRevenue = tables.reduce((sum, t) => sum + t.total, 0);
    
    return (
        <div style={{minHeight:'100vh',background:'var(--background)'}}>
            <header style={{background:'var(--surface)',padding:'1.5rem',borderBottom:'2px solid var(--border)',position:'sticky',top:0,zIndex:100}}>
                <div style={{maxWidth:'1600px',margin:'0 auto',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div>
                        <h1 style={{fontSize:'2rem',background:'linear-gradient(135deg,#e67e22,#d35400)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',fontWeight:'900',margin:0}}>üè™ BALC√ÉO</h1>
                        <p style={{color:'var(--text-secondary)',fontSize:'0.9rem',margin:0}}>Gest√£o de Pedidos</p>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                        <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                        <button onClick={() => setView('login')} style={{padding:'0.8rem 1.8rem',background:'#e67e22',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SAIR</button>
                    </div>
                </div>
                {/* Abas */}
                <div style={{maxWidth:'1600px',margin:'0.8rem auto 0',display:'flex',gap:'0.5rem',overflowX:'auto'}}>
                    {[
                        {key:'mesas', label:'üçΩÔ∏è MESAS'},
                        {key:'delivery', label:`üõµ DELIVERY${deliveryPending > 0 ? ` (${deliveryPending})` : ''}`},
                    ].map(t => (
                        <button key={t.key} onClick={() => setTab(t.key)} style={{
                            padding:'0.7rem 1.5rem',
                            background: tab===t.key ? '#e67e22' : 'transparent',
                            border: `2px solid ${tab===t.key ? '#e67e22' : 'var(--border)'}`,
                            borderRadius:'10px',
                            color: tab===t.key ? '#fff' : 'var(--text-secondary)',
                            fontWeight:'800',cursor:'pointer',whiteSpace:'nowrap',
                            transition:'all 0.2s'
                        }}>{t.label}</button>
                    ))}
                </div>
            </header>
            
            {/* STATS */}
            <div style={{background:'#0f0f0f',padding:'1.5rem',borderBottom:'2px solid #222'}}>
                <div style={{maxWidth:'1600px',margin:'0 auto',display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1.5rem'}}>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üçΩÔ∏è</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Mesas Ocupadas</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:'#e67e22'}}>{occupiedTables.length}/{tables.length}</div>
                    </div>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üîî</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Pedidos Pendentes</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:pendingCount > 0 ? '#e74c3c' : '#4a9d4e'}}>{pendingCount}</div>
                        {pendingCount > 0 && <NotificationBadge count={pendingCount} />}
                    </div>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üìû</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Chamadas de Gar√ßom</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:tables.filter(t => t.callWaiter).length > 0 ? '#e74c3c' : '#4a9d4e'}}>
                            {tables.filter(t => t.callWaiter).length}
                        </div>
                        {tables.filter(t => t.callWaiter).length > 0 && <NotificationBadge count={tables.filter(t => t.callWaiter).length} />}
                    </div>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üí∞</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Em Aberto</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:'#4a9d4e'}}>{config.currency} {totalRevenue.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <main style={{padding:'2rem',maxWidth:'1600px',margin:'0 auto'}}>
            
            {/* ABA DELIVERY */}
            {tab === 'delivery' && (
                <DeliveryTab
                    deliveries={deliveries}
                    products={products}
                    config={config}
                    onNew={() => setDeliveryModal(true)}
                />
            )}
            
            {/* ABA MESAS */}
            {tab === 'mesas' && (
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'2rem'}}>
                    {tables.map(t => {
                        const hasPending = t.pending && t.pending.length > 0;
                        const hasOrders = t.orders && t.orders.length > 0;
                        const isOccupied = t.status === 'ocupada';
                        const hasCall = t.callWaiter;
                        
                        return (
                            <div 
                                key={t.id}
                                onClick={() => isOccupied && setSel(t)}
                                style={{
                                    background:'#1a1a1a',
                                    padding:'2rem',
                                    borderRadius:'16px',
                                    border: hasCall ? '3px solid #e74c3c' : hasPending ? '3px solid #e74c3c' : hasOrders ? '3px solid #4a9d4e' : isOccupied ? '3px solid #d4a017' : '3px solid #4a9d4e',
                                    cursor: isOccupied ? 'pointer' : 'default',
                                    position:'relative',
                                    animation: (hasPending || hasCall) ? 'blink 1.5s infinite' : 'none',
                                    transition:'all 0.3s'
                                }}
                                onMouseEnter={e => isOccupied && (e.currentTarget.style.transform = 'scale(1.03)')}
                                onMouseLeave={e => isOccupied && (e.currentTarget.style.transform = 'scale(1)')}
                            >
                                {hasPending && <NotificationBadge count={t.pending.length} />}
                                {hasCall && !hasPending && (
                                    <div style={{position:'absolute',top:'-10px',right:'-10px',background:'#e74c3c',color:'#fff',fontSize:'1.5rem',width:'40px',height:'40px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',animation:'pulse 1s infinite',boxShadow:'0 0 20px rgba(231,76,60,0.8)'}}>
                                        üîî
                                    </div>
                                )}
                                
                                <div style={{fontSize:'3rem',textAlign:'center',marginBottom:'0.5rem'}}>{isOccupied ? 'üçΩÔ∏è' : '‚úÖ'}</div>
                                <div style={{fontSize:'2rem',fontWeight:'900',textAlign:'center',marginBottom:'0.5rem',color:'#d4a574'}}>Mesa {t.id}</div>
                                
                                {/* Nome do Cliente/Mesa */}
                                {isOccupied && t.customerName && (
                                    <div style={{
                                        textAlign:'center',
                                        padding:'0.5rem 1rem',
                                        borderRadius:'20px',
                                        background:'rgba(212,165,116,0.15)',
                                        border:'1px solid rgba(212,165,116,0.3)',
                                        marginBottom:'0.8rem'
                                    }}>
                                        <div style={{fontSize:'0.7rem',color:'#888',marginBottom:'0.2rem',fontWeight:'600'}}>CLIENTE/MESA</div>
                                        <div style={{fontSize:'0.95rem',fontWeight:'700',color:'#d4a574'}}>üë§ {t.customerName}</div>
                                    </div>
                                )}
                                
                                <div style={{textAlign:'center',padding:'0.5rem 1rem',borderRadius:'25px',background: isOccupied ? '#d4a017' : '#4a9d4e',color: isOccupied ? '#000' : '#fff',fontWeight:'800',fontSize:'0.9rem',marginBottom:'1rem'}}>
                                    {isOccupied ? 'OCUPADA' : 'LIVRE'}
                                </div>
                                
                                {isOccupied && (
                                    <>
                                        {/* Alerta: Mesa sem gar√ßom */}
                                        {!t.waiter && (
                                            <div style={{
                                                background:'linear-gradient(135deg, #f39c12, #e67e22)',
                                                padding:'1rem',
                                                borderRadius:'12px',
                                                marginBottom:'1rem',
                                                textAlign:'center',
                                                animation:'pulse 2s infinite',
                                                boxShadow:'0 4px 15px rgba(243,156,18,0.5)'
                                            }}>
                                                <div style={{fontSize:'1.5rem',marginBottom:'0.3rem'}}>‚ö†Ô∏è</div>
                                                <div style={{color:'#000',fontWeight:'900',fontSize:'0.9rem'}}>SEM GAR√áOM</div>
                                                <div style={{color:'#000',fontSize:'0.75rem',marginTop:'0.2rem'}}>Atribua agora!</div>
                                            </div>
                                        )}
                                        
                                        <div style={{color:'#ccc',fontSize:'0.95rem',textAlign:'center',marginBottom:'1rem'}}>
                                            {t.waiter ? (
                                                <div style={{
                                                    padding:'0.8rem 1rem',
                                                    borderRadius:'12px',
                                                    background:'rgba(52,152,219,0.15)',
                                                    border:'1px solid rgba(52,152,219,0.3)'
                                                }}>
                                                    <div style={{fontSize:'0.7rem',color:'#888',marginBottom:'0.2rem',fontWeight:'600'}}>GAR√áOM RESPONS√ÅVEL</div>
                                                    <div style={{color:'#3498db',fontWeight:'800',fontSize:'1rem'}}>üë®‚Äçüç≥ {waiters.find(w => w.id === t.waiter)?.name}</div>
                                                </div>
                                            ) : (
                                                <div style={{
                                                    padding:'0.8rem 1rem',
                                                    borderRadius:'12px',
                                                    background:'rgba(243,156,18,0.15)',
                                                    border:'1px solid rgba(243,156,18,0.3)'
                                                }}>
                                                    <div style={{fontSize:'0.7rem',color:'#888',marginBottom:'0.2rem',fontWeight:'600'}}>ATENDIMENTO</div>
                                                    <div style={{color:'#f39c12',fontWeight:'800',fontSize:'0.9rem'}}>üîÑ Todos os Gar√ßons</div>
                                                </div>
                                            )}
                                        </div>
                                        <div style={{background:'#0a0a0a',padding:'1rem',borderRadius:'12px',textAlign:'center',marginBottom:'0.8rem'}}>
                                            <div style={{color:'#888',fontSize:'0.8rem',marginBottom:'0.3rem'}}>Total</div>
                                            <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#e67e22'}}>{config.currency} {t.total.toFixed(2)}</div>
                                            {t.tip && t.tip > 0 && (
                                                <div style={{fontSize:'0.85rem',color:'#f39c12',marginTop:'0.5rem',fontWeight:'800'}}>
                                                    üíù Gorjeta: {config.currency} {t.tip.toFixed(2)}
                                                </div>
                                            )}
                                        </div>
                                        {hasCall && (
                                            <div style={{background:'#e74c3c',padding:'0.8rem',borderRadius:'8px',marginBottom:'0.8rem',textAlign:'center'}}>
                                                <div style={{color:'#fff',fontWeight:'800',fontSize:'0.9rem'}}>üîî CHAMANDO GAR√áOM</div>
                                            </div>
                                        )}
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem',fontSize:'0.85rem',marginBottom:'1rem'}}>
                                            <div style={{background:'#0a0a0a',padding:'0.8rem',borderRadius:'8px',textAlign:'center'}}>
                                                <div style={{color:'#4a9d4e',fontWeight:'800'}}>{t.orders ? t.orders.length : 0}</div>
                                                <div style={{color:'#888',fontSize:'0.75rem'}}>Confirmados</div>
                                            </div>
                                            <div style={{background:'#0a0a0a',padding:'0.8rem',borderRadius:'8px',textAlign:'center'}}>
                                                <div style={{color:hasPending ? '#e74c3c' : '#888',fontWeight:'800'}}>
                                                    {t.pending ? t.pending.length : 0}
                                                </div>
                                                <div style={{color:'#888',fontSize:'0.75rem'}}>Pendentes</div>
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns: !t.waiter ? '1fr' : '1fr 1fr',gap:'0.8rem'}}>
                                            {!t.waiter && (
                                                <button 
                                                    onClick={(e) => {e.stopPropagation(); setSelW(t.id);}}
                                                    style={{
                                                        padding:'1rem',
                                                        background:'linear-gradient(135deg, #f39c12, #e67e22)',
                                                        border:'none',
                                                        borderRadius:'10px',
                                                        color:'#000',
                                                        fontWeight:'900',
                                                        cursor:'pointer',
                                                        fontSize:'0.95rem',
                                                        marginBottom:'0.8rem',
                                                        boxShadow:'0 4px 15px rgba(243,156,18,0.4)',
                                                        animation:'pulse 2s infinite'
                                                    }}
                                                >
                                                    üë®‚Äçüç≥ ATRIBUIR GAR√áOM
                                                </button>
                                            )}
                                            <button 
                                                onClick={(e) => {e.stopPropagation(); showQRCode(t.id);}}
                                                style={{padding:'0.8rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}
                                            >
                                                üì± QR
                                            </button>
                                            <button 
                                                onClick={(e) => {e.stopPropagation(); closeTable(t.id);}}
                                                style={{padding:'0.8rem',background:'#e74c3c',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}
                                            >
                                                üí∞ FECHAR
                                            </button>
                                        </div>
                                    </>
                                )}
                                
                                {!isOccupied && (
                                    <div style={{display:'grid',gap:'0.8rem',marginTop:'1rem'}}>
                                        <button 
                                            onClick={(e) => {e.stopPropagation(); setSelW(t.id);}}
                                            style={{padding:'1rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.95rem'}}
                                        >
                                            üîì ABRIR MESA
                                        </button>
                                        <button 
                                            onClick={(e) => {e.stopPropagation(); showQRCode(t.id);}}
                                            style={{padding:'0.8rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}
                                        >
                                            üì± VER QR CODE
                                        </button>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            )} {/* fim aba mesas */}
            
            </main>
            
            {/* Modal delivery */}
            {deliveryModal && (
                <DeliveryModal
                    products={products}
                    config={config}
                    onClose={() => setDeliveryModal(false)}
                />
            )}
            
            {sel && (
                <div onClick={() => setSel(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'2rem',overflowY:'auto'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'3rem',borderRadius:'24px',maxWidth:'700px',width:'100%',border:'3px solid #e67e22',maxHeight:'90vh',overflowY:'auto'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                            <h2 style={{fontSize:'2.5rem',color:'#e67e22',fontWeight:'900',margin:0}}>Mesa {sel.id}</h2>
                            <button onClick={() => setSel(null)} style={{background:'#2a2a2a',border:'none',width:'40px',height:'40px',borderRadius:'50%',color:'#888',fontSize:'1.5rem',cursor:'pointer',fontWeight:'800'}}>√ó</button>
                        </div>
                        
                        {/* INFO */}
                        <div style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'2rem'}}>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                                <div>
                                    <div style={{color:'#888',fontSize:'0.9rem'}}>Atendente</div>
                                    <div style={{fontWeight:'800',fontSize:'1.1rem'}}>
                                        {sel.waiter ? waiters.find(w => w.id === sel.waiter)?.name : sel.customerName}
                                    </div>
                                </div>
                            </div>
                            <div style={{borderTop:'1px solid #333',paddingTop:'1rem',marginTop:'1rem',textAlign:'center'}}>
                                <div style={{fontSize:'3rem',fontWeight:'900',color:'#e67e22'}}>{config.currency} {sel.total.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        {/* PEDIDOS PENDENTES */}
                        {sel.pending && sel.pending.length > 0 && (
                            <div style={{marginBottom:'2rem'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',gap:'1rem'}}>
                                    <h3 style={{color:'#e74c3c',fontSize:'1.5rem',margin:0}}>
                                        üîî Pendentes ({sel.pending.length})
                                    </h3>
                                    <div style={{display:'flex',gap:'0.8rem'}}>
                                        <button 
                                            onClick={() => {
                                                if (!confirm(`Cancelar TODOS os ${sel.pending.length} pedidos pendentes?`)) return;
                                                db.ref(`tables/${sel.id}/pending`).set([]).then(() => {
                                                    alert('‚ùå Todos os pedidos foram cancelados!');
                                                    setSel(null);
                                                }).catch(err => {
                                                    console.error('Erro ao cancelar pedidos:', err);
                                                    alert('‚ùå Erro ao cancelar pedidos!');
                                                });
                                            }}
                                            style={{
                                                padding:'0.8rem 1.5rem',
                                                background:'linear-gradient(135deg,#e74c3c,#c0392b)',
                                                border:'none',
                                                borderRadius:'10px',
                                                color:'#fff',
                                                fontWeight:'800',
                                                cursor:'pointer',
                                                fontSize:'0.9rem',
                                                boxShadow:'0 2px 10px rgba(231,76,60,0.3)'
                                            }}
                                        >
                                            ‚úó CANCELAR TODOS
                                        </button>
                                        <button 
                                            onClick={() => approveAll(sel.id)}
                                            style={{
                                                padding:'0.8rem 1.5rem',
                                                background:'linear-gradient(135deg,#4a9d4e,#45a049)',
                                                border:'none',
                                                borderRadius:'10px',
                                                color:'#fff',
                                                fontWeight:'800',
                                                cursor:'pointer',
                                                fontSize:'0.9rem',
                                                boxShadow:'0 2px 10px rgba(74,157,78,0.3)'
                                            }}
                                        >
                                            ‚úì APROVAR TODOS
                                        </button>
                                    </div>
                                </div>
                                {sel.pending.map((o, i) => (
                                    <div key={i} style={{
                                        background:'rgba(231,76,60,0.1)',
                                        border:'2px solid #e74c3c',
                                        padding:'1.5rem',
                                        borderRadius:'12px',
                                        marginBottom:'1rem'
                                    }}>
                                        <div style={{display:'flex',gap:'1.5rem',alignItems:'center',marginBottom:'1rem'}}>
                                            <span style={{fontSize:'3rem'}}>{o.image}</span>
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:'800',fontSize:'1.2rem',marginBottom:'0.3rem'}}>{o.name}</div>
                                                <div style={{color:'#888'}}>Qtd: {o.quantity} ‚Ä¢ {config.currency} {o.price.toFixed(2)} cada</div>
                                            </div>
                                            <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#e67e22'}}>
                                                {config.currency} {(o.price * o.quantity).toFixed(2)}
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 2fr',gap:'1rem'}}>
                                            <button 
                                                onClick={() => cancelOrder(sel.id, i)}
                                                style={{
                                                    width:'100%',
                                                    padding:'1rem',
                                                    background:'#e74c3c',
                                                    border:'none',
                                                    borderRadius:'10px',
                                                    color:'#fff',
                                                    fontWeight:'800',
                                                    cursor:'pointer',
                                                    fontSize:'1rem'
                                                }}
                                            >
                                                ‚úó CANCELAR
                                            </button>
                                            <button 
                                                onClick={() => confirmOrder(sel.id, i)}
                                                style={{
                                                    width:'100%',
                                                    padding:'1rem',
                                                    background:'#4a9d4e',
                                                    border:'none',
                                                    borderRadius:'10px',
                                                    color:'#fff',
                                                    fontWeight:'800',
                                                    cursor:'pointer',
                                                    fontSize:'1rem'
                                                }}
                                            >
                                                ‚úì CONFIRMAR PEDIDO
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* PEDIDOS CONFIRMADOS */}
                        {sel.orders && sel.orders.length > 0 && (
                            <div style={{marginBottom:'2rem'}}>
                                <h3 style={{color:'#4a9d4e',fontSize:'1.5rem',marginBottom:'1rem'}}>‚úì Confirmados ({sel.orders.length})</h3>
                                <div style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px'}}>
                                    {sel.orders.map((o, i) => (
                                        <div key={i} style={{
                                            display:'flex',
                                            gap:'1.5rem',
                                            alignItems:'center',
                                            padding:'1rem',
                                            borderBottom: i < sel.orders.length - 1 ? '1px solid #333' : 'none'
                                        }}>
                                            <span style={{fontSize:'2rem'}}>{o.image}</span>
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:'800',fontSize:'1.1rem'}}>{o.name}</div>
                                                <div style={{color:'#888',fontSize:'0.85rem'}}>Qtd: {o.quantity}</div>
                                            </div>
                                            <div style={{fontWeight:'800',color:'#4a9d4e',fontSize:'1.2rem'}}>
                                                {config.currency} {(o.price * o.quantity).toFixed(2)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* BOT√ÉO FECHAR CONTA */}
                        {sel.orders && sel.orders.length > 0 && (
                            <button 
                                onClick={() => closeTable(sel.id)}
                                style={{
                                    width:'100%',
                                    padding:'1.5rem',
                                    background:'linear-gradient(135deg,#e74c3c,#c0392b)',
                                    border:'none',
                                    borderRadius:'12px',
                                    color:'#fff',
                                    fontWeight:'900',
                                    cursor:'pointer',
                                    fontSize:'1.2rem',
                                    boxShadow:'0 4px 15px rgba(231,76,60,0.4)',
                                    marginTop:'1rem'
                                }}
                            >
                                üí∞ FECHAR CONTA - {config.currency} {sel.total.toFixed(2)}
                            </button>
                        )}
                    </div>
                </div>
            )}
            
            {/* MODAL SELECIONAR GAR√áOM */}
            {selW && (
                <div onClick={() => setSelW(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'500px',width:'100%',border:'3px solid #e67e22'}}>
                        <h2 style={{color:'#e67e22',marginBottom:'0.5rem',fontSize:'1.8rem',fontWeight:'900'}}>Abrir Mesa {selW}</h2>
                        
                        {/* Campo de Nome do Cliente */}
                        <div style={{marginBottom:'1.5rem'}}>
                            <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontSize:'0.9rem',fontWeight:'600'}}>Nome do Cliente (opcional):</label>
                            <input 
                                id={`customer-name-${selW}`}
                                type="text" 
                                placeholder="Ex: Jo√£o Silva, Mesa de anivers√°rio, etc"
                                style={{
                                    width:'100%',
                                    padding:'1rem',
                                    background:'#0a0a0a',
                                    border:'2px solid #333',
                                    borderRadius:'10px',
                                    color:'#fff',
                                    fontSize:'1rem'
                                }}
                            />
                        </div>
                        
                        <p style={{color:'#888',marginBottom:'1.5rem',fontSize:'0.95rem',fontWeight:'600'}}>Selecione o gar√ßom respons√°vel:</p>
                        {waiters.filter(w => w.active).map(w => (
                            <button 
                                key={w.id} 
                                onClick={() => {
                                    const customerName = document.getElementById(`customer-name-${selW}`)?.value || 'Cliente';
                                    db.ref(`tables/${selW}`).update({
                                        status: 'ocupada', 
                                        waiter: w.id,
                                        customerName: customerName,
                                        openedAt: Date.now()
                                    });
                                    setSelW(null);
                                    alert(`‚úÖ Mesa ${selW} aberta!\nGar√ßom: ${w.name}\nCliente: ${customerName}`);
                                }} 
                                style={{
                                    width:'100%',
                                    padding:'1.2rem',
                                    background:'#0a0a0a',
                                    border:'2px solid #333',
                                    borderRadius:'12px',
                                    color:'#fff',
                                    fontWeight:'800',
                                    cursor:'pointer',
                                    marginBottom:'1rem',
                                    fontSize:'1.1rem',
                                    transition:'all 0.3s'
                                }}
                                onMouseEnter={e => {
                                    e.currentTarget.style.background = '#4a9d4e';
                                    e.currentTarget.style.borderColor = '#4a9d4e';
                                }}
                                onMouseLeave={e => {
                                    e.currentTarget.style.background = '#0a0a0a';
                                    e.currentTarget.style.borderColor = '#333';
                                }}
                            >
                                üë®‚Äçüç≥ {w.name}
                            </button>
                        ))}
                        <button 
                            onClick={() => {
                                const customerName = document.getElementById(`customer-name-${selW}`)?.value || 'Cliente';
                                db.ref(`tables/${selW}`).update({
                                    status: 'ocupada', 
                                    waiter: null,
                                    customerName: customerName,
                                    openedAt: Date.now()
                                });
                                setSelW(null);
                                alert(`‚úÖ Mesa ${selW} aberta!\nGar√ßom: Sem gar√ßom espec√≠fico (todos podem atender)\nCliente: ${customerName}`);
                            }}
                            style={{
                                width:'100%',
                                padding:'1.2rem',
                                background:'#0a0a0a',
                                border:'2px solid #f39c12',
                                borderRadius:'12px',
                                color:'#f39c12',
                                fontWeight:'800',
                                cursor:'pointer',
                                marginBottom:'1rem',
                                fontSize:'1.1rem',
                                transition:'all 0.3s'
                            }}
                            onMouseEnter={e => {
                                e.currentTarget.style.background = '#f39c12';
                                e.currentTarget.style.color = '#000';
                            }}
                            onMouseLeave={e => {
                                e.currentTarget.style.background = '#0a0a0a';
                                e.currentTarget.style.color = '#f39c12';
                            }}
                        >
                            üîÑ Sem Gar√ßom Espec√≠fico (Todos Podem Atender)
                        </button>
                        <button onClick={() => setSelW(null)} style={{width:'100%',padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'12px',color:'#888',fontWeight:'800',cursor:'pointer',marginTop:'0.5rem'}}>CANCELAR</button>
                    </div>
                </div>
            )}
            
            {/* MODAL QR CODE */}
            {qrModal && (
                <div onClick={() => setQrModal(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10001,padding:'1rem'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#fff',padding:'3rem',borderRadius:'20px',maxWidth:'500px',width:'100%',textAlign:'center'}}>
                        <h2 style={{color:'#000',marginBottom:'0.5rem',fontSize:'2rem',fontWeight:'900'}}>üçΩÔ∏è Mesa {qrModal}</h2>
                        <p style={{color:'#666',marginBottom:'2rem',fontSize:'0.95rem'}}>Escaneie o QR Code para acessar o card√°pio</p>
                        
                        <div style={{background:'#f5f5f5',padding:'2rem',borderRadius:'12px',marginBottom:'1.5rem',display:'flex',justifyContent:'center',alignItems:'center',minHeight:'340px'}}>
                            <canvas id={`qr-canvas-balcao-${qrModal}`}></canvas>
                        </div>
                        
                        <div style={{background:'#f0f0f0',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
                            <p style={{color:'#666',fontSize:'0.75rem',marginBottom:'0.3rem'}}>Link direto:</p>
                            <p style={{color:'#333',fontSize:'0.85rem',fontWeight:'600',wordBreak:'break-all',margin:0}}>
                                {window.location.href.split('?')[0]}?mesa={qrModal}
                            </p>
                        </div>
                        
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                            <button 
                                onClick={() => {
                                    const canvas = document.getElementById(`qr-canvas-balcao-${qrModal}`);
                                    if (canvas) {
                                        const link = document.createElement('a');
                                        link.download = `qrcode-mesa-${qrModal}.png`;
                                        link.href = canvas.toDataURL();
                                        link.click();
                                    }
                                }}
                                style={{padding:'1.2rem',background:'#3498db',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}
                            >
                                üíæ BAIXAR
                            </button>
                            <button onClick={() => setQrModal(null)} style={{padding:'1.2rem',background:'#e67e22',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}>‚úì FECHAR</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function NotificationBadge({count}) {
    if (!count || count === 0) return null;
    return (
        <div style={{
            position:'absolute',
            top:'-8px',
            right:'-8px',
            background:'#e74c3c',
            color:'#fff',
            minWidth:'24px',
            height:'24px',
            borderRadius:'12px',
            display:'flex',
            alignItems:'center',
            justifyContent:'center',
            fontSize:'0.75rem',
            fontWeight:'900',
            padding:'0 6px',
            boxShadow:'0 2px 8px rgba(231,76,60,0.5)',
            animation:'pulse 1.5s infinite'
        }}>
            {count}
        </div>
    );
}

// ‚îÄ‚îÄ‚îÄ DELIVERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function DeliveryTab({deliveries, products, config, onNew}) {
    const statusColor = {
        pendente:   '#e74c3c',
        preparando: '#f39c12',
        saiu:       '#3498db',
        entregue:   '#4a9d4e',
        cancelado:  '#6c757d',
    };
    const statusLabel = {
        pendente:   '‚è≥ Pendente',
        preparando: 'üë®‚Äçüç≥ Preparando',
        saiu:       'üõµ Saiu p/ Entrega',
        entregue:   '‚úÖ Entregue',
        cancelado:  '‚ùå Cancelado',
    };
    const nextStatus = {pendente:'preparando', preparando:'saiu', saiu:'entregue'};
    const nextLabel  = {pendente:'‚ñ∂ INICIAR PREPARO', preparando:'üõµ SAIU P/ ENTREGA', saiu:'‚úÖ MARCAR ENTREGUE'};
    
    const advanceStatus = (d) => {
        const next = nextStatus[d.status];
        if (!next) return;
        db.ref(`deliveries/${d.id}/status`).set(next);
        if (next === 'entregue') {
            // Salvar como venda delivery
            const sale = {
                id: Date.now(),
                type: 'delivery',
                tableId: null,
                waiter: null,
                waiterName: 'Delivery',
                customerName: d.customerName,
                customerPhone: d.phone,
                address: d.address,
                subtotal: d.subtotal,
                deliveryFee: d.deliveryFee || 0,
                tip: 0,
                total: d.total,
                payment: d.payment,
                troco: d.troco || null,
                orders: d.items,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            db.ref(`sales/${sale.id}`).set(sale);
            db.ref(`deliveries/${d.id}/closedAt`).set(Date.now());
        }
    };
    
    const cancelDelivery = (d) => {
        if (!confirm(`Cancelar pedido de ${d.customerName}?`)) return;
        db.ref(`deliveries/${d.id}/status`).set('cancelado');
    };
    
    const active = deliveries.filter(d => d.status !== 'entregue' && d.status !== 'cancelado');
    const done   = deliveries.filter(d => d.status === 'entregue' || d.status === 'cancelado');
    
    return (
        <div>
            {/* Header */}
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                <h2 style={{fontSize:'2rem',fontWeight:'900',color:'#e67e22',margin:0}}>üõµ Pedidos Delivery</h2>
                <button onClick={onNew} style={{
                    padding:'1rem 2rem',
                    background:'linear-gradient(135deg,#e67e22,#d35400)',
                    border:'none',borderRadius:'12px',color:'#fff',
                    fontWeight:'800',cursor:'pointer',fontSize:'1rem',
                    boxShadow:'0 4px 15px rgba(230,126,34,0.4)'
                }}>+ NOVO PEDIDO</button>
            </div>
            
            {/* Stats r√°pidos */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(160px,1fr))',gap:'1rem',marginBottom:'2rem'}}>
                {[
                    {label:'Pendentes',    val: deliveries.filter(d=>d.status==='pendente').length,   color:'#e74c3c', icon:'‚è≥'},
                    {label:'Preparando',  val: deliveries.filter(d=>d.status==='preparando').length,  color:'#f39c12', icon:'üë®‚Äçüç≥'},
                    {label:'Na Rua',      val: deliveries.filter(d=>d.status==='saiu').length,        color:'#3498db', icon:'üõµ'},
                    {label:'Entregues Hoje', val: deliveries.filter(d=>{
                        if(d.status!=='entregue') return false;
                        return new Date(d.closedAt||d.createdAt).toDateString()===new Date().toDateString();
                    }).length, color:'#4a9d4e', icon:'‚úÖ'},
                ].map(s => (
                    <div key={s.label} style={{background:'var(--surface)',padding:'1.2rem',borderRadius:'12px',border:`2px solid ${s.color}`,textAlign:'center'}}>
                        <div style={{fontSize:'2rem'}}>{s.icon}</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.8rem',fontWeight:'700'}}>{s.label}</div>
                        <div style={{fontSize:'1.8rem',fontWeight:'900',color:s.color}}>{s.val}</div>
                    </div>
                ))}
            </div>
            
            {/* Pedidos Ativos */}
            {active.length === 0 && (
                <div style={{textAlign:'center',padding:'4rem',background:'var(--surface)',borderRadius:'16px',border:'2px dashed var(--border)',marginBottom:'2rem'}}>
                    <div style={{fontSize:'4rem',marginBottom:'1rem'}}>üõµ</div>
                    <h3 style={{fontSize:'1.5rem',color:'var(--text-secondary)'}}>Nenhum pedido ativo</h3>
                    <p style={{color:'var(--text-secondary)'}}>Clique em "+ NOVO PEDIDO" para come√ßar</p>
                </div>
            )}
            
            <div style={{display:'grid',gap:'1.5rem',marginBottom:'3rem'}}>
                {active.map(d => (
                    <div key={d.id} style={{
                        background:'var(--surface)',
                        borderRadius:'16px',
                        border:`3px solid ${statusColor[d.status]}`,
                        padding:'2rem',
                        boxShadow:`0 4px 20px ${statusColor[d.status]}33`,
                        animation: d.status==='pendente' ? 'pulse 2s infinite' : 'none'
                    }}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem',marginBottom:'1.5rem'}}>
                            <div>
                                <div style={{display:'flex',alignItems:'center',gap:'0.8rem',marginBottom:'0.5rem'}}>
                                    <span style={{
                                        padding:'0.4rem 1rem',
                                        background:statusColor[d.status],
                                        borderRadius:'20px',
                                        fontSize:'0.85rem',
                                        fontWeight:'800',
                                        color:'#fff'
                                    }}>{statusLabel[d.status]}</span>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.85rem'}}>
                                        #{String(d.id).slice(-5)} ¬∑ {new Date(d.createdAt).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}
                                    </span>
                                </div>
                                <h3 style={{fontSize:'1.4rem',fontWeight:'900',margin:'0 0 0.3rem'}}>{d.customerName}</h3>
                                <div style={{color:'var(--text-secondary)',fontSize:'0.95rem'}}>üìû {d.phone}</div>
                                <div style={{color:'var(--text-secondary)',fontSize:'0.95rem'}}>üìç {d.address}</div>
                            </div>
                            <div style={{textAlign:'right'}}>
                                <div style={{fontSize:'2rem',fontWeight:'900',color:'#e67e22'}}>{config.currency} {d.total.toFixed(2)}</div>
                                <div style={{fontSize:'0.9rem',color:'var(--text-secondary)'}}>
                                    {d.payment === 'dinheiro' ? `üíµ Dinheiro${d.troco > 0 ? ` ¬∑ Troco p/ ${config.currency} ${parseFloat(d.troco).toFixed(2)}` : ''}` : 
                                     d.payment === 'pix' ? 'üí† PIX' : 'üí≥ Cart√£o'}
                                </div>
                            </div>
                        </div>
                        
                        {/* Itens */}
                        <div style={{background:'var(--background)',borderRadius:'10px',padding:'1rem',marginBottom:'1.5rem'}}>
                            {(d.items||[]).map((item,i) => (
                                <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'0.4rem 0',borderBottom:'1px solid var(--border)'}}>
                                    <span>{item.image} {item.quantity}x {item.name}</span>
                                    <span style={{fontWeight:'700',color:'#e67e22'}}>{config.currency} {(item.price*item.quantity).toFixed(2)}</span>
                                </div>
                            ))}
                            <div style={{display:'flex',justifyContent:'space-between',marginTop:'0.5rem',fontWeight:'700'}}>
                                <span>Subtotal</span><span>{config.currency} {d.subtotal.toFixed(2)}</span>
                            </div>
                            {d.deliveryFee > 0 && (
                                <div style={{display:'flex',justifyContent:'space-between',fontWeight:'700',color:'var(--text-secondary)'}}>
                                    <span>Taxa de entrega</span><span>{config.currency} {parseFloat(d.deliveryFee).toFixed(2)}</span>
                                </div>
                            )}
                        </div>
                        
                        {/* A√ß√µes */}
                        <div style={{display:'flex',gap:'1rem',flexWrap:'wrap'}}>
                            {nextStatus[d.status] && (
                                <button onClick={() => advanceStatus(d)} style={{
                                    flex:1,padding:'1rem',
                                    background:`linear-gradient(135deg,${statusColor[nextStatus[d.status]]},${statusColor[nextStatus[d.status]]}cc)`,
                                    border:'none',borderRadius:'10px',color:'#fff',
                                    fontWeight:'800',cursor:'pointer',fontSize:'0.95rem',
                                    minWidth:'160px'
                                }}>{nextLabel[d.status]}</button>
                            )}
                            {d.status !== 'cancelado' && d.status !== 'entregue' && (
                                <button onClick={() => cancelDelivery(d)} style={{
                                    padding:'1rem 1.5rem',background:'transparent',
                                    border:'2px solid #e74c3c',borderRadius:'10px',
                                    color:'#e74c3c',fontWeight:'800',cursor:'pointer'
                                }}>‚ùå CANCELAR</button>
                            )}
                        </div>
                    </div>
                ))}
            </div>
            
            {/* Hist√≥rico */}
            {done.length > 0 && (
                <div>
                    <h3 style={{color:'var(--text-secondary)',marginBottom:'1rem',fontWeight:'700'}}>üìã Hist√≥rico de Hoje</h3>
                    <div style={{display:'grid',gap:'0.8rem'}}>
                        {done.slice(0,10).map(d => (
                            <div key={d.id} style={{
                                background:'var(--surface)',borderRadius:'12px',
                                padding:'1.2rem 1.5rem',
                                border:`2px solid ${statusColor[d.status]}`,
                                display:'flex',justifyContent:'space-between',alignItems:'center',
                                opacity:0.7
                            }}>
                                <div>
                                    <span style={{padding:'0.3rem 0.8rem',background:statusColor[d.status],borderRadius:'20px',fontSize:'0.8rem',fontWeight:'700',color:'#fff',marginRight:'0.8rem'}}>
                                        {statusLabel[d.status]}
                                    </span>
                                    <strong>{d.customerName}</strong>
                                    <span style={{color:'var(--text-secondary)',marginLeft:'0.5rem',fontSize:'0.85rem'}}>¬∑ {d.phone}</span>
                                </div>
                                <div style={{fontWeight:'900',color:'#e67e22'}}>{config.currency} {d.total.toFixed(2)}</div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
}

function DeliveryModal({products, config, onClose}) {
    const [form, setForm] = useState({
        customerName:'', phone:'', address:'', payment:'dinheiro', troco:'', deliveryFee:''
    });
    const [cart, setCart] = useState([]);
    const [step, setStep] = useState(1); // 1=dados, 2=itens
    const [catFilter, setCatFilter] = useState('Todos');
    
    const categories = ['Todos', ...new Set(products.filter(p=>p.active).map(p=>p.category))];
    const filtered = products.filter(p => p.active && (catFilter==='Todos' || p.category===catFilter));
    
    const addItem = (p) => {
        const ex = cart.find(i=>i.id===p.id);
        if (ex) setCart(cart.map(i => i.id===p.id ? {...i, quantity:i.quantity+1} : i));
        else setCart([...cart, {...p, quantity:1}]);
    };
    const removeItem = (id) => setCart(cart.map(i => i.id===id ? {...i, quantity:i.quantity-1} : i).filter(i=>i.quantity>0));
    
    const subtotal = cart.reduce((s,i)=>s+i.price*i.quantity, 0);
    const deliveryFee = parseFloat(form.deliveryFee) || 0;
    const total = subtotal + deliveryFee;
    
    const save = () => {
        if (!form.customerName.trim()) { alert('‚ùå Informe o nome do cliente!'); return; }
        if (!form.phone.trim())         { alert('‚ùå Informe o telefone!'); return; }
        if (!form.address.trim())       { alert('‚ùå Informe o endere√ßo!'); return; }
        if (cart.length === 0)          { alert('‚ùå Adicione pelo menos 1 item!'); return; }
        if (form.payment==='dinheiro' && !form.troco && form.troco !== '0') {
            const ok = confirm('O cliente n√£o precisa de troco? Confirmar?');
            if (!ok) return;
        }
        
        const delivery = {
            id: Date.now(),
            customerName: form.customerName.trim(),
            phone: form.phone.trim(),
            address: form.address.trim(),
            payment: form.payment,
            troco: form.payment==='dinheiro' ? (parseFloat(form.troco)||0) : null,
            items: cart,
            subtotal,
            deliveryFee,
            total,
            status: 'pendente',
            createdAt: Date.now()
        };
        
        db.ref(`deliveries/${delivery.id}`).set(delivery);
        playSound();
        alert(`‚úÖ Pedido de ${form.customerName} criado!\nTotal: ${config.currency} ${total.toFixed(2)}`);
        onClose();
    };
    
    return (
        <div onClick={onClose} style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.92)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'1rem'}}>
            <div onClick={e=>e.stopPropagation()} style={{
                background:'var(--surface)',
                borderRadius:'20px',
                maxWidth:'700px',width:'100%',
                border:'3px solid #e67e22',
                maxHeight:'92vh',overflowY:'auto'
            }}>
                {/* Header modal */}
                <div style={{padding:'2rem 2rem 1rem',borderBottom:'2px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',position:'sticky',top:0,background:'var(--surface)',zIndex:1}}>
                    <h3 style={{color:'#e67e22',fontSize:'1.6rem',fontWeight:'900',margin:0}}>üõµ Novo Pedido Delivery</h3>
                    <button onClick={onClose} style={{background:'transparent',border:'none',fontSize:'1.8rem',cursor:'pointer',color:'var(--text-secondary)'}}>√ó</button>
                </div>
                
                {/* Steps */}
                <div style={{display:'flex',padding:'1.2rem 2rem',gap:'0.5rem'}}>
                    {[{n:1,label:'üìã Dados'},{n:2,label:'üõí Itens'}].map(s=>(
                        <button key={s.n} onClick={() => step > s.n ? setStep(s.n) : null} style={{
                            flex:1,padding:'0.8rem',
                            background: step===s.n ? '#e67e22' : step>s.n ? '#4a9d4e' : 'var(--background)',
                            border:`2px solid ${step>=s.n ? (step===s.n?'#e67e22':'#4a9d4e') : 'var(--border)'}`,
                            borderRadius:'10px',
                            color: step>=s.n ? '#fff' : 'var(--text-secondary)',
                            fontWeight:'800',cursor: step>s.n ? 'pointer' : 'default'
                        }}>{s.label}</button>
                    ))}
                </div>
                
                <div style={{padding:'0 2rem 2rem'}}>
                
                {/* STEP 1 ‚Äì Dados do cliente */}
                {step === 1 && (
                    <div style={{display:'grid',gap:'1.2rem'}}>
                        <div>
                            <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üë§ Nome do Cliente *</label>
                            <input value={form.customerName} onChange={e=>setForm({...form,customerName:e.target.value})}
                                placeholder="Ex: Jo√£o Silva"
                                style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}} />
                        </div>
                        <div>
                            <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üìû Telefone *</label>
                            <input value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})}
                                placeholder="(00) 90000-0000"
                                style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}} />
                        </div>
                        <div>
                            <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üìç Endere√ßo Completo *</label>
                            <textarea value={form.address} onChange={e=>setForm({...form,address:e.target.value})}
                                placeholder="Rua, n√∫mero, bairro, refer√™ncia..."
                                rows={3}
                                style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem',resize:'vertical'}} />
                        </div>
                        <div>
                            <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üèçÔ∏è Taxa de Entrega (opcional)</label>
                            <input type="number" min="0" step="0.50" value={form.deliveryFee} onChange={e=>setForm({...form,deliveryFee:e.target.value})}
                                placeholder="0,00"
                                style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}} />
                        </div>
                        <div>
                            <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.8rem'}}>üí≥ Forma de Pagamento *</label>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.8rem'}}>
                                {[{v:'dinheiro',l:'üíµ Dinheiro'},{v:'pix',l:'üí† PIX'},{v:'cartao',l:'üí≥ Cart√£o'}].map(p=>(
                                    <button key={p.v} onClick={()=>setForm({...form,payment:p.v})} style={{
                                        padding:'1rem',
                                        background: form.payment===p.v ? '#e67e22' : 'var(--background)',
                                        border:`2px solid ${form.payment===p.v ? '#e67e22' : 'var(--border)'}`,
                                        borderRadius:'10px',
                                        color: form.payment===p.v ? '#fff' : 'var(--text)',
                                        fontWeight:'800',cursor:'pointer'
                                    }}>{p.l}</button>
                                ))}
                            </div>
                        </div>
                        {form.payment === 'dinheiro' && (
                            <div>
                                <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üíµ Troco para quanto? (deixe em branco se n√£o precisar)</label>
                                <input type="number" min="0" value={form.troco} onChange={e=>setForm({...form,troco:e.target.value})}
                                    placeholder="Ex: 50,00"
                                    style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}} />
                            </div>
                        )}
                        <button onClick={()=>setStep(2)} style={{
                            width:'100%',padding:'1.2rem',
                            background:'linear-gradient(135deg,#e67e22,#d35400)',
                            border:'none',borderRadius:'12px',
                            color:'#fff',fontWeight:'900',fontSize:'1.1rem',cursor:'pointer'
                        }}>PR√ìXIMO: ESCOLHER ITENS ‚Üí</button>
                    </div>
                )}
                
                {/* STEP 2 ‚Äì Itens */}
                {step === 2 && (
                    <div>
                        {/* Filtro categorias */}
                        <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap',marginBottom:'1.5rem'}}>
                            {categories.map(c=>(
                                <button key={c} onClick={()=>setCatFilter(c)} style={{
                                    padding:'0.5rem 1rem',
                                    background: catFilter===c ? '#e67e22' : 'var(--background)',
                                    border:`2px solid ${catFilter===c ? '#e67e22':'var(--border)'}`,
                                    borderRadius:'20px',color: catFilter===c ? '#fff':'var(--text)',
                                    fontWeight:'700',cursor:'pointer',fontSize:'0.9rem'
                                }}>{c}</button>
                            ))}
                        </div>
                        
                        {/* Grid produtos */}
                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(140px,1fr))',gap:'1rem',marginBottom:'2rem'}}>
                            {filtered.map(p=>{
                                const inCart = cart.find(i=>i.id===p.id);
                                return (
                                    <div key={p.id} style={{
                                        background:'var(--background)',
                                        borderRadius:'12px',
                                        border:`2px solid ${inCart ? '#e67e22' : 'var(--border)'}`,
                                        padding:'1rem',textAlign:'center',cursor:'pointer',
                                        transition:'all 0.2s'
                                    }} onClick={()=>addItem(p)}>
                                        <div style={{fontSize:'2.5rem',marginBottom:'0.4rem'}}>
                                            {p.imageType==='upload' ? <img src={p.image} style={{width:'40px',height:'40px',borderRadius:'8px',objectFit:'cover'}} /> : p.image}
                                        </div>
                                        <div style={{fontWeight:'800',fontSize:'0.9rem',marginBottom:'0.2rem'}}>{p.name}</div>
                                        <div style={{color:'#e67e22',fontWeight:'900',fontSize:'0.95rem'}}>{config.currency} {p.price.toFixed(2)}</div>
                                        {inCart && <div style={{marginTop:'0.4rem',background:'#e67e22',color:'#fff',borderRadius:'20px',padding:'0.2rem 0.6rem',fontSize:'0.8rem',fontWeight:'800'}}>√ó {inCart.quantity}</div>}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Carrinho resumo */}
                        {cart.length > 0 && (
                            <div style={{background:'var(--background)',borderRadius:'12px',padding:'1.5rem',marginBottom:'1.5rem',border:'2px solid var(--border)'}}>
                                <h4 style={{margin:'0 0 1rem',color:'var(--text)'}}>üõí Resumo do Pedido</h4>
                                {cart.map(i=>(
                                    <div key={i.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.5rem 0',borderBottom:'1px solid var(--border)'}}>
                                        <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                            <button onClick={()=>removeItem(i.id)} style={{background:'#e74c3c',border:'none',color:'#fff',borderRadius:'50%',width:'22px',height:'22px',cursor:'pointer',fontWeight:'900',fontSize:'0.9rem',display:'flex',alignItems:'center',justifyContent:'center'}}>-</button>
                                            <span>{i.quantity}x {i.name}</span>
                                        </div>
                                        <span style={{fontWeight:'700',color:'#e67e22'}}>{config.currency} {(i.price*i.quantity).toFixed(2)}</span>
                                    </div>
                                ))}
                                <div style={{marginTop:'0.8rem',paddingTop:'0.8rem',borderTop:'2px solid var(--border)'}}>
                                    <div style={{display:'flex',justifyContent:'space-between'}}><span>Subtotal</span><span>{config.currency} {subtotal.toFixed(2)}</span></div>
                                    {deliveryFee>0 && <div style={{display:'flex',justifyContent:'space-between',color:'var(--text-secondary)'}}><span>Taxa entrega</span><span>{config.currency} {deliveryFee.toFixed(2)}</span></div>}
                                    <div style={{display:'flex',justifyContent:'space-between',fontSize:'1.3rem',fontWeight:'900',color:'#e67e22',marginTop:'0.5rem'}}>
                                        <span>TOTAL</span><span>{config.currency} {total.toFixed(2)}</span>
                                    </div>
                                    {form.payment==='dinheiro' && form.troco > 0 && (
                                        <div style={{marginTop:'0.5rem',padding:'0.5rem',background:'rgba(74,157,78,0.1)',borderRadius:'8px',color:'#4a9d4e',fontWeight:'700',fontSize:'0.9rem'}}>
                                            üíµ Troco: {config.currency} {(parseFloat(form.troco)-total).toFixed(2)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        <div style={{display:'flex',gap:'1rem'}}>
                            <button onClick={()=>setStep(1)} style={{padding:'1.2rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'12px',color:'var(--text)',fontWeight:'800',cursor:'pointer'}}>‚Üê VOLTAR</button>
                            <button onClick={save} style={{
                                flex:1,padding:'1.2rem',
                                background:'linear-gradient(135deg,#4a9d4e,#45a049)',
                                border:'none',borderRadius:'12px',
                                color:'#fff',fontWeight:'900',fontSize:'1.1rem',cursor:'pointer'
                            }}>‚úÖ CONFIRMAR PEDIDO</button>
                        </div>
                    </div>
                )}
                </div>
            </div>
        </div>
    );
}

// ‚îÄ‚îÄ‚îÄ FIM DELIVERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üìÖ  RESERVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ReservasTab({config, tables, onAdd}) {
    const [reservas, setReservas] = useState([]);

    useEffect(() => {
        db.ref('reservas').on('value', s => {
            if (s.val()) setReservas(Object.values(s.val()).sort((a,b)=>a.timestamp-b.timestamp));
            else setReservas([]);
        });
        return () => db.ref('reservas').off();
    }, []);

    const statusColor = {pendente:'#f39c12', confirmada:'#4a9d4e', cancelada:'#e74c3c', concluida:'#6c757d'};
    const statusLabel = {pendente:'‚è≥ Pendente', confirmada:'‚úÖ Confirmada', cancelada:'‚ùå Cancelada', concluida:'üèÅ Conclu√≠da'};

    const setStatus = (id, status) => db.ref(`reservas/${id}/status`).set(status);
    const del = (id) => { if(confirm('Excluir reserva?')) db.ref(`reservas/${id}`).remove(); };

    const hoje = new Date().toISOString().slice(0,10);
    const futuras = reservas.filter(r => r.data >= hoje && r.status !== 'cancelada' && r.status !== 'concluida');
    const passadas = reservas.filter(r => r.data < hoje || r.status === 'concluida' || r.status === 'cancelada');

    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                <h2 style={{fontSize:'2rem',fontWeight:'900',color:'#3498db',margin:0}}>üìÖ Reservas</h2>
                <button onClick={onAdd} style={{padding:'1rem 2rem',background:'linear-gradient(135deg,#3498db,#2980b9)',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',boxShadow:'0 4px 15px rgba(52,152,219,0.4)'}}>+ NOVA RESERVA</button>
            </div>

            {/* Stats */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'1rem',marginBottom:'2rem'}}>
                {[
                    {l:'Hoje',   v:reservas.filter(r=>r.data===hoje && r.status!=='cancelada').length, c:'#3498db', i:'üìÖ'},
                    {l:'Pendentes', v:reservas.filter(r=>r.status==='pendente').length, c:'#f39c12', i:'‚è≥'},
                    {l:'Confirmadas', v:reservas.filter(r=>r.status==='confirmada').length, c:'#4a9d4e', i:'‚úÖ'},
                    {l:'Esta Semana', v:reservas.filter(r=>{
                        const d=new Date(r.data); const h=new Date();
                        return d>=h && d<=new Date(h.getTime()+7*864e5) && r.status!=='cancelada';
                    }).length, c:'#9b59b6', i:'üìÜ'},
                ].map(s=>(
                    <div key={s.l} style={{background:'var(--surface)',padding:'1.2rem',borderRadius:'12px',border:`2px solid ${s.c}`,textAlign:'center'}}>
                        <div style={{fontSize:'1.8rem'}}>{s.i}</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.8rem',fontWeight:'700'}}>{s.l}</div>
                        <div style={{fontSize:'1.8rem',fontWeight:'900',color:s.c}}>{s.v}</div>
                    </div>
                ))}
            </div>

            {/* Lista futuras */}
            <h3 style={{color:'var(--text)',marginBottom:'1rem',fontWeight:'800'}}>üìÜ Pr√≥ximas Reservas</h3>
            {futuras.length === 0 && (
                <div style={{textAlign:'center',padding:'3rem',background:'var(--surface)',borderRadius:'16px',border:'2px dashed var(--border)',marginBottom:'2rem'}}>
                    <div style={{fontSize:'3rem'}}>üìÖ</div>
                    <p style={{color:'var(--text-secondary)'}}>Nenhuma reserva futura</p>
                </div>
            )}
            <div style={{display:'grid',gap:'1rem',marginBottom:'2rem'}}>
                {futuras.map(r=>(
                    <div key={r.id} style={{background:'var(--surface)',borderRadius:'14px',border:`3px solid ${statusColor[r.status]}`,padding:'1.5rem',boxShadow:`0 4px 15px ${statusColor[r.status]}22`}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
                            <div>
                                <div style={{display:'flex',alignItems:'center',gap:'0.8rem',marginBottom:'0.5rem'}}>
                                    <span style={{padding:'0.3rem 0.9rem',background:statusColor[r.status],borderRadius:'20px',fontSize:'0.8rem',fontWeight:'800',color:'#fff'}}>{statusLabel[r.status]}</span>
                                    {r.data === hoje && <span style={{padding:'0.3rem 0.8rem',background:'#f39c12',borderRadius:'20px',fontSize:'0.8rem',fontWeight:'800',color:'#000'}}>HOJE!</span>}
                                </div>
                                <h3 style={{fontSize:'1.3rem',fontWeight:'900',margin:'0 0 0.3rem'}}>{r.nome}</h3>
                                <div style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>üìû {r.telefone}</div>
                                <div style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>
                                    üìÖ {new Date(r.data+'T12:00').toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'long'})} √†s {r.hora}
                                </div>
                                <div style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>üë• {r.pessoas} pessoa{r.pessoas>1?'s':''} ¬∑ {r.mesa ? `Mesa ${r.mesa}` : 'Mesa a definir'}</div>
                                {r.obs && <div style={{marginTop:'0.5rem',padding:'0.5rem',background:'var(--background)',borderRadius:'8px',fontSize:'0.85rem',color:'var(--text-secondary)'}}>üí¨ {r.obs}</div>}
                            </div>
                            <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                                {r.status==='pendente' && <button onClick={()=>setStatus(r.id,'confirmada')} style={{padding:'0.7rem 1rem',background:'#4a9d4e',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>‚úÖ CONFIRMAR</button>}
                                {r.status==='confirmada' && <button onClick={()=>setStatus(r.id,'concluida')} style={{padding:'0.7rem 1rem',background:'#6c757d',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>üèÅ CONCLUIR</button>}
                                {r.status!=='cancelada' && <button onClick={()=>setStatus(r.id,'cancelada')} style={{padding:'0.7rem 1rem',background:'transparent',border:'2px solid #e74c3c',borderRadius:'8px',color:'#e74c3c',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>‚ùå</button>}
                                <button onClick={()=>del(r.id)} style={{padding:'0.7rem 1rem',background:'transparent',border:'2px solid var(--border)',borderRadius:'8px',color:'var(--text-secondary)',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Hist√≥rico */}
            {passadas.length>0 && (
                <details style={{marginTop:'1rem'}}>
                    <summary style={{cursor:'pointer',color:'var(--text-secondary)',fontWeight:'700',padding:'0.5rem'}}>üìã Hist√≥rico ({passadas.length})</summary>
                    <div style={{display:'grid',gap:'0.6rem',marginTop:'1rem'}}>
                        {passadas.slice(0,15).map(r=>(
                            <div key={r.id} style={{background:'var(--surface)',borderRadius:'10px',padding:'1rem',border:`2px solid ${statusColor[r.status]}`,opacity:0.6,display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <div>
                                    <span style={{padding:'0.25rem 0.7rem',background:statusColor[r.status],borderRadius:'20px',fontSize:'0.75rem',fontWeight:'800',color:'#fff',marginRight:'0.7rem'}}>{statusLabel[r.status]}</span>
                                    <strong>{r.nome}</strong> ¬∑ {r.pessoas} pessoas ¬∑ {new Date(r.data+'T12:00').toLocaleDateString('pt-BR')} {r.hora}
                                </div>
                                <button onClick={()=>del(r.id)} style={{background:'transparent',border:'none',cursor:'pointer',color:'var(--text-secondary)',fontSize:'1.1rem'}}>üóëÔ∏è</button>
                            </div>
                        ))}
                    </div>
                </details>
            )}
        </div>
    );
}

function ReservaModal({tables, config, onClose}) {
    const [d, setD] = useState({
        nome:'', telefone:'', data: new Date().toISOString().slice(0,10),
        hora:'20:00', pessoas:2, mesa:'', obs:'', status:'pendente'
    });

    const save = () => {
        if (!d.nome.trim())      { alert('‚ùå Informe o nome!'); return; }
        if (!d.telefone.trim())  { alert('‚ùå Informe o telefone!'); return; }
        if (!d.data)             { alert('‚ùå Informe a data!'); return; }
        if (!d.hora)             { alert('‚ùå Informe o hor√°rio!'); return; }

        const reserva = { ...d, id: Date.now(), timestamp: Date.now(), createdAt: Date.now() };
        db.ref(`reservas/${reserva.id}`).set(reserva);
        playSound('reserva');
        alert(`‚úÖ Reserva de ${d.nome} criada!\nüìÖ ${new Date(d.data+'T12:00').toLocaleDateString('pt-BR')} √†s ${d.hora}\nüë• ${d.pessoas} pessoa(s)`);
        onClose();
    };

    const mesasLivres = tables.filter(t=>t.status==='livre').map(t=>t.id);

    return (
        <div onClick={onClose} style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'1rem'}}>
            <div onClick={e=>e.stopPropagation()} style={{background:'var(--surface)',borderRadius:'20px',maxWidth:'480px',width:'100%',border:'3px solid #3498db',maxHeight:'92vh',overflowY:'auto'}}>
                <div style={{padding:'2rem 2rem 1rem',borderBottom:'2px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',position:'sticky',top:0,background:'var(--surface)'}}>
                    <h3 style={{color:'#3498db',fontSize:'1.6rem',fontWeight:'900',margin:0}}>üìÖ Nova Reserva</h3>
                    <button onClick={onClose} style={{background:'transparent',border:'none',fontSize:'1.8rem',cursor:'pointer',color:'var(--text-secondary)'}}>√ó</button>
                </div>
                <div style={{padding:'1.5rem 2rem 2rem',display:'grid',gap:'1.2rem'}}>
                    {[
                        {label:'üë§ Nome do Cliente *', key:'nome', type:'text', placeholder:'Ex: Jo√£o Silva'},
                        {label:'üìû Telefone *', key:'telefone', type:'text', placeholder:'(00) 90000-0000'},
                        {label:'üìÖ Data *', key:'data', type:'date'},
                        {label:'üïê Hor√°rio *', key:'hora', type:'time'},
                    ].map(f=>(
                        <div key={f.key}>
                            <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>{f.label}</label>
                            <input type={f.type} value={d[f.key]} placeholder={f.placeholder||''} onChange={e=>setD({...d,[f.key]:e.target.value})}
                                style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}} />
                        </div>
                    ))}
                    <div>
                        <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üë• N√∫mero de Pessoas</label>
                        <input type="number" min="1" max="50" value={d.pessoas} onChange={e=>setD({...d,pessoas:parseInt(e.target.value)||1})}
                            style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}} />
                    </div>
                    <div>
                        <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>ü™ë Mesa (opcional)</label>
                        <select value={d.mesa} onChange={e=>setD({...d,mesa:e.target.value})}
                            style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem'}}>
                            <option value="">A definir na chegada</option>
                            {mesasLivres.map(m=><option key={m} value={m}>Mesa {m}</option>)}
                        </select>
                    </div>
                    <div>
                        <label style={{display:'block',color:'var(--text-secondary)',fontWeight:'700',marginBottom:'0.4rem'}}>üí¨ Observa√ß√µes</label>
                        <textarea value={d.obs} onChange={e=>setD({...d,obs:e.target.value})} rows={3} placeholder="Anivers√°rio, alergias, pedidos especiais..."
                            style={{width:'100%',padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text)',fontSize:'1rem',resize:'vertical'}} />
                    </div>
                    <div style={{display:'flex',gap:'1rem',marginTop:'0.5rem'}}>
                        <button onClick={onClose} style={{flex:1,padding:'1rem',background:'var(--background)',border:'2px solid var(--border)',borderRadius:'10px',color:'var(--text-secondary)',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                        <button onClick={save} style={{flex:2,padding:'1rem',background:'linear-gradient(135deg,#3498db,#2980b9)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'900',cursor:'pointer',fontSize:'1rem'}}>üìÖ CONFIRMAR RESERVA</button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üìã  CARD√ÅPIO QR P√öBLICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function CardapioQRTab({products, config}) {
    const qrRef = useRef(null);
    const [qrGenerated, setQrGenerated] = useState(false);

    // URL do card√°pio p√∫blico
    const cardapioUrl = `${window.location.href.split('?')[0]}?cardapio=1`;

    useEffect(() => {
        if (qrRef.current && window.QRCode && !qrGenerated) {
            window.QRCode.toCanvas(qrRef.current, cardapioUrl, {
                width: 250, margin: 2,
                color: {dark:'#000000', light:'#ffffff'}
            }, err => { if (!err) setQrGenerated(true); });
        }
    }, []);

    const grouped = products.filter(p=>p.active).reduce((a,p)=>{ if(!a[p.category])a[p.category]=[]; a[p.category].push(p); return a; },{});

    const printCardapio = () => {
        const w = window.open('', '_blank');
        const items = products.filter(p=>p.active);
        const cats = [...new Set(items.map(p=>p.category))];
        w.document.write(`
            <html><head><title>Card√°pio - ${config.barName}</title>
            <meta charset="UTF-8">
            <style>
                body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:2rem;background:#fff;color:#000}
                h1{text-align:center;color:#d4a574;font-size:2.5rem;border-bottom:3px solid #d4a574;padding-bottom:1rem}
                h2{color:#333;font-size:1.5rem;margin-top:2rem;border-bottom:1px solid #ddd;padding-bottom:0.5rem}
                .item{display:flex;justify-content:space-between;align-items:center;padding:0.8rem 0;border-bottom:1px solid #f0f0f0}
                .nome{font-size:1.1rem;font-weight:600}
                .preco{font-size:1.2rem;font-weight:900;color:#d4a574}
                .emoji{font-size:1.8rem;margin-right:1rem}
                @media print{body{padding:1rem}}
            </style></head><body>
            ${config.logo ? `<div style="text-align:center;margin-bottom:1rem"><img src="${config.logo}" style="max-width:200px;max-height:150px"></div>` : ''}
            <h1>${config.barName}</h1>
            ${cats.map(cat=>`
                <h2>${cat}</h2>
                ${items.filter(p=>p.category===cat).map(p=>`
                    <div class="item">
                        <div style="display:flex;align-items:center">
                            <span class="emoji">${p.imageType==='upload'?'üçΩÔ∏è':p.image}</span>
                            <span class="nome">${p.name}</span>
                        </div>
                        <span class="preco">${config.currency} ${parseFloat(p.price).toFixed(2)}</span>
                    </div>
                `).join('')}
            `).join('')}
            </body></html>
        `);
        w.document.close();
        w.print();
    };

    return (
        <div>
            <h2 style={{fontSize:'2rem',fontWeight:'900',color:'#4a9d4e',marginBottom:'2rem'}}>üìã Card√°pio Online & QR Code</h2>

            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'2rem',marginBottom:'2rem'}}>
                {/* QR Code */}
                <div style={{background:'var(--surface)',borderRadius:'16px',padding:'2rem',border:'2px solid #4a9d4e',textAlign:'center'}}>
                    <h3 style={{color:'#4a9d4e',marginBottom:'1.5rem',fontWeight:'800'}}>üì± QR Code do Card√°pio</h3>
                    <div style={{background:'#fff',padding:'1rem',borderRadius:'12px',display:'inline-block',marginBottom:'1.5rem'}}>
                        <canvas ref={qrRef} />
                    </div>
                    <p style={{color:'var(--text-secondary)',fontSize:'0.85rem',marginBottom:'1rem'}}>
                        Clientes escaneiam e veem o card√°pio completo
                    </p>
                    <div style={{display:'grid',gap:'0.8rem'}}>
                        <button onClick={() => {navigator.clipboard.writeText(cardapioUrl); alert('‚úÖ Link copiado!');}}
                            style={{padding:'0.9rem',background:'#3498db',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>
                            üìã COPIAR LINK
                        </button>
                        <button onClick={printCardapio}
                            style={{padding:'0.9rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>
                            üñ®Ô∏è IMPRIMIR CARD√ÅPIO
                        </button>
                    </div>
                </div>

                {/* Preview */}
                <div style={{background:'var(--surface)',borderRadius:'16px',padding:'2rem',border:'2px solid var(--border)'}}>
                    <h3 style={{color:'var(--text)',marginBottom:'1.5rem',fontWeight:'800'}}>üëÅÔ∏è Pr√©via do Card√°pio</h3>
                    <div style={{maxHeight:'400px',overflowY:'auto'}}>
                        {Object.entries(grouped).map(([cat, items])=>(
                            <div key={cat} style={{marginBottom:'1.5rem'}}>
                                <div style={{fontWeight:'900',color:'#d4a574',marginBottom:'0.7rem',fontSize:'1rem',borderBottom:'2px solid var(--border)',paddingBottom:'0.4rem'}}>{cat}</div>
                                {items.map(p=>(
                                    <div key={p.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.5rem 0'}}>
                                        <div style={{display:'flex',alignItems:'center',gap:'0.6rem'}}>
                                            <span style={{fontSize:'1.5rem'}}>
                                                {p.imageType==='upload' ? <img src={p.image} style={{width:'28px',height:'28px',borderRadius:'6px',objectFit:'cover'}} /> : p.image}
                                            </span>
                                            <span style={{fontWeight:'600',fontSize:'0.95rem'}}>{p.name}</span>
                                        </div>
                                        <span style={{fontWeight:'900',color:'#d4a574',fontSize:'0.95rem'}}>{config.currency} {parseFloat(p.price).toFixed(2)}</span>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* Instru√ß√µes */}
            <div style={{background:'var(--surface)',borderRadius:'12px',padding:'1.5rem',border:'2px solid var(--border)'}}>
                <h4 style={{fontWeight:'800',marginBottom:'1rem'}}>üí° Como usar</h4>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
                    {[
                        {i:'1Ô∏è‚É£', t:'Imprima o QR Code', d:'Coloque nas mesas e balc√£o'},
                        {i:'2Ô∏è‚É£', t:'Cliente escaneia', d:'Abre o card√°pio no celular'},
                        {i:'3Ô∏è‚É£', t:'V√™ os produtos', d:'Com fotos, pre√ßos e categorias'},
                        {i:'4Ô∏è‚É£', t:'Faz o pedido', d:'Pode chamar o gar√ßom pelo app'},
                    ].map(s=>(
                        <div key={s.i} style={{padding:'1rem',background:'var(--background)',borderRadius:'10px',textAlign:'center'}}>
                            <div style={{fontSize:'2rem',marginBottom:'0.5rem'}}>{s.i}</div>
                            <div style={{fontWeight:'800',marginBottom:'0.3rem'}}>{s.t}</div>
                            <div style={{color:'var(--text-secondary)',fontSize:'0.85rem'}}>{s.d}</div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üèÜ  HIST√ìRICO DE CLIENTES / FIDELIDADE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ClientesTab({sales, config}) {
    const [search, setSearch] = useState('');
    const [selCliente, setSelCliente] = useState(null);

    // Agrupar vendas por cliente
    const clientMap = {};
    (sales||[]).forEach(s => {
        const name = s.customerName || 'Cliente';
        const phone = s.customerPhone || '';
        const key = phone || name;
        if (!clientMap[key]) {
            clientMap[key] = { name, phone, visitas:0, totalGasto:0, pedidos:[], ultimaVisita:null, tipoFav:'' };
        }
        clientMap[key].visitas++;
        clientMap[key].totalGasto += s.total||0;
        clientMap[key].pedidos.push(s);
        if (!clientMap[key].ultimaVisita || s.timestamp > clientMap[key].ultimaVisita) {
            clientMap[key].ultimaVisita = s.timestamp;
        }
    });

    // Calcular item favorito
    Object.values(clientMap).forEach(c => {
        const freq = {};
        c.pedidos.forEach(p => (p.orders||[]).forEach(o => { freq[o.name]=(freq[o.name]||0)+o.quantity; }));
        const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
        c.itemFav = sorted[0]?.[0] || '‚Äî';
    });

    const clientes = Object.values(clientMap).sort((a,b) => b.totalGasto - a.totalGasto);
    const filtered = clientes.filter(c => c.name.toLowerCase().includes(search.toLowerCase()) || c.phone.includes(search));

    const tier = (total) => {
        if (total >= 500) return {label:'ü•á VIP', color:'#f39c12'};
        if (total >= 200) return {label:'ü•à Frequente', color:'#6c757d'};
        if (total >= 50)  return {label:'ü•â Regular', color:'#cd7f32'};
        return {label:'üÜï Novo', color:'#3498db'};
    };

    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem',flexWrap:'wrap',gap:'1rem'}}>
                <h2 style={{fontSize:'2rem',fontWeight:'900',color:'#9b59b6',margin:0}}>üèÜ Hist√≥rico de Clientes</h2>
                <div style={{display:'flex',alignItems:'center',gap:'0.5rem',background:'var(--surface)',border:'2px solid var(--border)',borderRadius:'10px',padding:'0.5rem 1rem'}}>
                    <span>üîç</span>
                    <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar cliente..."
                        style={{background:'transparent',border:'none',outline:'none',color:'var(--text)',fontSize:'1rem',width:'180px'}} />
                </div>
            </div>

            {/* Resumo */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'1rem',marginBottom:'2rem'}}>
                {[
                    {l:'Total Clientes', v:clientes.length, c:'#9b59b6', i:'üë•'},
                    {l:'VIP (R$500+)', v:clientes.filter(c=>c.totalGasto>=500).length, c:'#f39c12', i:'ü•á'},
                    {l:'Frequentes', v:clientes.filter(c=>c.totalGasto>=200&&c.totalGasto<500).length, c:'#6c757d', i:'ü•à'},
                    {l:'Ticket M√©dio', v:`${config.currency} ${clientes.length?( clientes.reduce((s,c)=>s+c.totalGasto,0)/clientes.length).toFixed(0):'0'}`, c:'#4a9d4e', i:'üí∞'},
                ].map(s=>(
                    <div key={s.l} style={{background:'var(--surface)',padding:'1.2rem',borderRadius:'12px',border:`2px solid ${s.c}`,textAlign:'center'}}>
                        <div style={{fontSize:'1.8rem'}}>{s.i}</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.75rem',fontWeight:'700'}}>{s.l}</div>
                        <div style={{fontSize:'1.5rem',fontWeight:'900',color:s.c}}>{s.v}</div>
                    </div>
                ))}
            </div>

            {/* Lista */}
            {filtered.length === 0 && (
                <div style={{textAlign:'center',padding:'4rem',background:'var(--surface)',borderRadius:'16px',border:'2px dashed var(--border)'}}>
                    <div style={{fontSize:'3rem'}}>üèÜ</div>
                    <p style={{color:'var(--text-secondary)'}}>Nenhum cliente encontrado</p>
                </div>
            )}
            <div style={{display:'grid',gap:'1rem'}}>
                {filtered.map((c,i) => {
                    const t = tier(c.totalGasto);
                    return (
                        <div key={i} onClick={()=>setSelCliente(selCliente===i?null:i)} style={{
                            background:'var(--surface)',borderRadius:'14px',
                            border:`2px solid ${t.color}`,padding:'1.5rem',
                            cursor:'pointer',transition:'all 0.2s'
                        }}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'1rem'}}>
                                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                                    <div style={{width:'50px',height:'50px',borderRadius:'50%',background:t.color,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.3rem',fontWeight:'900',color:'#fff',flexShrink:0}}>
                                        {c.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style={{display:'flex',alignItems:'center',gap:'0.6rem'}}>
                                            <strong style={{fontSize:'1.1rem'}}>{c.name}</strong>
                                            <span style={{padding:'0.2rem 0.7rem',background:t.color,borderRadius:'20px',fontSize:'0.75rem',fontWeight:'800',color:'#fff'}}>{t.label}</span>
                                        </div>
                                        {c.phone && <div style={{color:'var(--text-secondary)',fontSize:'0.85rem'}}>üìû {c.phone}</div>}
                                        <div style={{color:'var(--text-secondary)',fontSize:'0.85rem'}}>
                                            {c.visitas} visita{c.visitas>1?'s':''} ¬∑ ‚≠ê Favorito: {c.itemFav}
                                        </div>
                                    </div>
                                </div>
                                <div style={{textAlign:'right'}}>
                                    <div style={{fontSize:'1.5rem',fontWeight:'900',color:t.color}}>{config.currency} {c.totalGasto.toFixed(2)}</div>
                                    <div style={{color:'var(--text-secondary)',fontSize:'0.8rem'}}>
                                        √öltima: {c.ultimaVisita ? new Date(c.ultimaVisita).toLocaleDateString('pt-BR') : '‚Äî'}
                                    </div>
                                </div>
                            </div>

                            {/* Detalhes expandidos */}
                            {selCliente === i && (
                                <div style={{marginTop:'1.5rem',paddingTop:'1.5rem',borderTop:'2px solid var(--border)'}}>
                                    <h4 style={{marginBottom:'1rem',color:'var(--text)'}}>üìã Hist√≥rico de Pedidos</h4>
                                    <div style={{display:'grid',gap:'0.7rem',maxHeight:'250px',overflowY:'auto'}}>
                                        {c.pedidos.sort((a,b)=>b.timestamp-a.timestamp).map((p,j)=>(
                                            <div key={j} style={{background:'var(--background)',borderRadius:'10px',padding:'1rem',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                                                <div>
                                                    <div style={{fontWeight:'700',marginBottom:'0.2rem'}}>
                                                        {p.type==='delivery'?'üõµ Delivery':`üçΩÔ∏è Mesa ${p.tableId}`}
                                                        {p.waiterName && ` ¬∑ ${p.waiterName}`}
                                                    </div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.8rem'}}>
                                                        {(p.orders||[]).slice(0,3).map(o=>`${o.quantity}x ${o.name}`).join(', ')}
                                                        {(p.orders||[]).length>3?'...':''}
                                                    </div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.8rem'}}>
                                                        {new Date(p.timestamp).toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}
                                                    </div>
                                                </div>
                                                <div style={{fontWeight:'900',color:'#d4a574',fontSize:'1.1rem'}}>{config.currency} {p.total.toFixed(2)}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIM NOVOS COMPONENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function Waiter({tables, products, config, user, setView, theme, toggleTheme}) {
    const [cart, setCart] = useState([]);
    const [orderingFor, setOrderingFor] = useState(null);
    const [showChat, setShowChat] = useState(false);
    const [selectedTable, setSelectedTable] = useState(null);
    const [chatMessage, setChatMessage] = useState('');
    
    const myTables = tables.filter(t => (t.waiter === user.waiterId || t.waiter === null) && t.status === 'ocupada');
    const pendingCount = myTables.reduce((s, t) => s + (t.pending ? t.pending.length : 0), 0);
    const totalSales = myTables.reduce((s, t) => s + t.total, 0);
    const callingCount = myTables.filter(t => t.callWaiter).length;
    
    // Contar mensagens n√£o lidas de todas as mesas
    const unreadMessagesCount = myTables.reduce((total, table) => {
        if (table.messages) {
            return total + table.messages.filter(m => m.from === 'customer' && !m.read).length;
        }
        return total;
    }, 0);
    
    const sendOrder = () => {
        if (!orderingFor || cart.length === 0) return;
        
        const newItems = cart.map(i => ({
            ...i, 
            addedBy: user.name, 
            addedAt: Date.now(),
            orderId: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
        }));
        
        const pendingRef = db.ref(`tables/${orderingFor.id}/pending`);
        pendingRef.once('value').then(snapshot => {
            const currentPending = snapshot.val() || [];
            const updatedPending = [...currentPending, ...newItems];
            pendingRef.set(updatedPending);
        });
        
        setCart([]);
        setOrderingFor(null);
        alert(`‚úÖ ${newItems.length} ${newItems.length === 1 ? 'pedido enviado' : 'pedidos enviados'}!`);
        playSound();
    };
    
    const confirmPending = (tableId, idx) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || !t.pending[idx]) return;
        
        const item = t.pending[idx];
        const newOrders = [...(t.orders || []), {...item, confirmedAt: Date.now()}];
        const newPending = t.pending.filter((_, i) => i !== idx);
        
        const itemTotal = item.price * item.quantity;
        const newSubtotal = (t.subtotal || 0) + itemTotal;
        const newTotal = newSubtotal;
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: newPending,
            subtotal: newSubtotal,
            total: newTotal
        }).then(() => {
            playSound();
        });
    };
    
    const confirmAllPending = (tableId) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || t.pending.length === 0) return;
        
        if (!confirm(`Confirmar TODOS os ${t.pending.length} pedidos?`)) return;
        
        const newOrders = [...(t.orders || []), ...t.pending.map(p => ({...p, confirmedAt: Date.now()}))];
        const pendingTotal = t.pending.reduce((sum, p) => sum + (p.price * p.quantity), 0);
        const newSubtotal = (t.subtotal || 0) + pendingTotal;
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: [],
            subtotal: newSubtotal,
            total: newSubtotal
        }).then(() => {
            playSound();
            alert('‚úÖ Todos os pedidos confirmados!');
        });
    };
    
    const sendChatMessage = () => {
        if (!chatMessage.trim() || !selectedTable) return;
        
        const newMessage = {
            text: chatMessage,
            from: 'waiter',
            senderName: user.name,
            timestamp: Date.now(),
            read: false
        };
        
        const messages = selectedTable.messages || [];
        db.ref(`tables/${selectedTable.id}/messages`).set([...messages, newMessage]);
        
        setChatMessage('');
        playSound();
    };
    
    const grouped = products.filter(p => p.active).reduce((acc, p) => {
        if (!acc[p.category]) acc[p.category] = [];
        acc[p.category].push(p);
        return acc;
    }, {});
    
    return (
        <div className="fade-in" style={{minHeight:'100vh',background:'linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)'}}>
            {/* Header Moderno */}
            <header className="glass" style={{
                padding:'1.5rem',
                borderBottom:'1px solid rgba(255,255,255,0.1)',
                position:'sticky',
                top:0,
                zIndex:100,
                backdropFilter:'blur(20px)'
            }}>
                <div style={{maxWidth:'1400px',margin:'0 auto',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div>
                        <h1 className="gradient-text" style={{fontSize:'2rem',fontWeight:'900',margin:0,letterSpacing:'-0.5px'}}>
                            üë®‚Äçüç≥ {user.name}
                        </h1>
                        <p style={{color:'var(--text-secondary)',fontSize:'0.9rem',margin:0,fontWeight:'500'}}>Gar√ßom</p>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                        <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                        <button 
                            onClick={() => setView('login')} 
                            className="btn btn-primary"
                            style={{padding:'0.8rem 1.8rem'}}
                        >
                            SAIR
                        </button>
                    </div>
                </div>
            </header>
            
            {/* Dashboard de Estat√≠sticas */}
            <div style={{padding:'2rem',borderBottom:'1px solid rgba(255,255,255,0.05)'}}>
                <div style={{maxWidth:'1400px',margin:'0 auto',display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1.5rem'}}>
                    <div className="card" style={{textAlign:'center',background:'linear-gradient(135deg, rgba(52,152,219,0.1), rgba(41,128,185,0.05))'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üçΩÔ∏è</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Minhas Mesas</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:'var(--info)'}}>{myTables.length}</div>
                    </div>
                    <div className="card" style={{textAlign:'center',background:callingCount > 0 ? 'linear-gradient(135deg, rgba(243,156,18,0.1), rgba(230,126,34,0.05))' : 'rgba(255,255,255,0.02)',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üîî</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Chamadas</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:callingCount > 0 ? 'var(--warning)' : 'var(--text-secondary)'}}>{callingCount}</div>
                        {callingCount > 0 && <NotificationBadge count={callingCount} />}
                    </div>
                    <div className="card" style={{textAlign:'center',background:pendingCount > 0 ? 'linear-gradient(135deg, rgba(231,76,60,0.1), rgba(192,57,43,0.05))' : 'rgba(255,255,255,0.02)',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üìã</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Pendentes</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:pendingCount > 0 ? 'var(--danger)' : 'var(--accent)'}}>{pendingCount}</div>
                        {pendingCount > 0 && <NotificationBadge count={pendingCount} />}
                    </div>
                    <div className="card" style={{textAlign:'center',background:'linear-gradient(135deg, rgba(74,157,78,0.1), rgba(69,160,73,0.05))'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üí∞</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Vendas</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:'var(--accent)'}}>{config.currency} {totalSales.toFixed(2)}</div>
                    </div>
                    <div className="card" style={{textAlign:'center',background:unreadMessagesCount > 0 ? 'linear-gradient(135deg, rgba(52,152,219,0.1), rgba(41,128,185,0.05))' : 'rgba(255,255,255,0.02)',position:'relative',cursor:'pointer'}} onClick={() => {
                        const tableWithMessages = myTables.find(t => t.messages && t.messages.some(m => m.from === 'customer' && !m.read));
                        if (tableWithMessages) {
                            setSelectedTable(tableWithMessages);
                            setShowChat(true);
                        }
                    }}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üí¨</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Mensagens</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:unreadMessagesCount > 0 ? 'var(--info)' : 'var(--text-secondary)'}}>{unreadMessagesCount}</div>
                        {unreadMessagesCount > 0 && <NotificationBadge count={unreadMessagesCount} />}
                    </div>
                </div>
            </div>
            
            {/* √Årea Principal - Mesas */}
            <main style={{padding:'2rem',maxWidth:'1400px',margin:'0 auto',paddingBottom:'150px'}}>
                {!orderingFor ? (
                    <div>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                            <h2 className="gradient-text" style={{fontSize:'2rem',fontWeight:'900',margin:0}}>Minhas Mesas</h2>
                            {myTables.length > 0 && (
                                <div style={{color:'var(--text-secondary)',fontSize:'0.95rem',fontWeight:'600'}}>
                                    {myTables.length} {myTables.length === 1 ? 'mesa' : 'mesas'} ativa{myTables.length === 1 ? '' : 's'}
                                </div>
                            )}
                        </div>
                        
                        {myTables.length === 0 ? (
                            <div className="card" style={{textAlign:'center',padding:'4rem',marginTop:'3rem'}}>
                                <div style={{fontSize:'5rem',marginBottom:'1.5rem',opacity:0.5}}>üçΩÔ∏è</div>
                                <h3 style={{fontSize:'1.8rem',marginBottom:'0.8rem',fontWeight:'700'}}>Nenhuma mesa atribu√≠da</h3>
                                <p style={{color:'var(--text-secondary)',fontSize:'1rem'}}>Aguarde o admin abrir mesas para voc√™</p>
                            </div>
                        ) : (
                            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(300px,1fr))',gap:'1.5rem'}}>
                                {myTables.map(t => {
                                    const hasPending = t.pending && t.pending.length > 0;
                                    const hasOrders = t.orders && t.orders.length > 0;
                                    const isCallingWaiter = t.callWaiter;
                                    const hasMessages = t.messages && t.messages.some(m => m.from === 'customer' && !m.read);
                                    const unreadCount = hasMessages ? t.messages.filter(m => m.from === 'customer' && !m.read).length : 0;
                                    
                                    let borderColor = 'var(--info)';
                                    if (isCallingWaiter) borderColor = 'var(--warning)';
                                    else if (hasPending) borderColor = 'var(--danger)';
                                    else if (hasOrders) borderColor = 'var(--accent)';
                                    
                                    return (
                                        <div 
                                            key={t.id} 
                                            className="card" 
                                            style={{
                                                position:'relative',
                                                border:`2px solid ${borderColor}`,
                                                animation: (hasPending || isCallingWaiter) ? 'pulse 2s infinite' : 'none',
                                                cursor:'pointer',
                                                transition:'all 0.3s ease'
                                            }}
                                            onClick={() => setOrderingFor(t)}
                                        >
                                            {/* Badges de Notifica√ß√£o */}
                                            {hasPending && (
                                                <div style={{
                                                    position:'absolute',
                                                    top:'-10px',
                                                    right:'-10px',
                                                    background:'var(--danger)',
                                                    color:'#fff',
                                                    borderRadius:'50%',
                                                    width:'32px',
                                                    height:'32px',
                                                    display:'flex',
                                                    alignItems:'center',
                                                    justifyContent:'center',
                                                    fontWeight:'900',
                                                    fontSize:'0.9rem',
                                                    boxShadow:'0 4px 12px rgba(231,76,60,0.5)',
                                                    zIndex:10
                                                }}>
                                                    {t.pending.length}
                                                </div>
                                            )}
                                            
                                            {isCallingWaiter && (
                                                <div style={{
                                                    position:'absolute',
                                                    top:'-12px',
                                                    left:'50%',
                                                    transform:'translateX(-50%)',
                                                    background:'var(--warning)',
                                                    color:'#000',
                                                    padding:'0.5rem 1.2rem',
                                                    borderRadius:'20px',
                                                    fontWeight:'900',
                                                    fontSize:'0.85rem',
                                                    boxShadow:'0 4px 15px rgba(243,156,18,0.6)',
                                                    animation:'pulse 1s infinite',
                                                    whiteSpace:'nowrap'
                                                }}>
                                                    üîî CHAMANDO VOC√ä!
                                                </div>
                                            )}
                                            
                                            {/* √çcone e N√∫mero da Mesa */}
                                            <div style={{textAlign:'center',marginTop: isCallingWaiter ? '1.5rem' : '0'}}>
                                                <div style={{fontSize:'3.5rem',marginBottom:'0.5rem'}}>üçΩÔ∏è</div>
                                                <div style={{
                                                    fontSize:'2.5rem',
                                                    fontWeight:'900',
                                                    color:borderColor,
                                                    marginBottom:'0.5rem',
                                                    letterSpacing:'-1px'
                                                }}>
                                                    Mesa {t.id}
                                                </div>
                                                {t.customerName && (
                                                    <div style={{
                                                        color:'var(--text-secondary)',
                                                        fontSize:'0.95rem',
                                                        fontWeight:'600',
                                                        marginBottom:'1rem'
                                                    }}>
                                                        üë§ {t.customerName}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Total */}
                                            <div style={{
                                                background:'rgba(212,165,116,0.1)',
                                                padding:'1.2rem',
                                                borderRadius:'12px',
                                                textAlign:'center',
                                                marginBottom:'1rem',
                                                border:'1px solid rgba(212,165,116,0.2)'
                                            }}>
                                                <div style={{color:'var(--text-secondary)',fontSize:'0.85rem',fontWeight:'600',marginBottom:'0.3rem'}}>TOTAL</div>
                                                <div style={{fontSize:'2rem',fontWeight:'900',color:'var(--primary)'}}>{config.currency} {t.total.toFixed(2)}</div>
                                            </div>
                                            
                                            {/* Estat√≠sticas */}
                                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.8rem',marginBottom:'1.2rem'}}>
                                                <div style={{
                                                    background:'rgba(74,157,78,0.1)',
                                                    padding:'0.8rem 0.5rem',
                                                    borderRadius:'10px',
                                                    textAlign:'center',
                                                    border:'1px solid rgba(74,157,78,0.2)'
                                                }}>
                                                    <div style={{color:'var(--accent)',fontWeight:'900',fontSize:'1.3rem'}}>{t.orders ? t.orders.length : 0}</div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.7rem',fontWeight:'600'}}>Confirmados</div>
                                                </div>
                                                <div style={{
                                                    background: hasPending ? 'rgba(231,76,60,0.1)' : 'rgba(255,255,255,0.03)',
                                                    padding:'0.8rem 0.5rem',
                                                    borderRadius:'10px',
                                                    textAlign:'center',
                                                    border: hasPending ? '1px solid rgba(231,76,60,0.2)' : '1px solid rgba(255,255,255,0.05)'
                                                }}>
                                                    <div style={{color:hasPending?'var(--danger)':'var(--text-secondary)',fontWeight:'900',fontSize:'1.3rem'}}>{t.pending ? t.pending.length : 0}</div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.7rem',fontWeight:'600'}}>Pendentes</div>
                                                </div>
                                                <div 
                                                    style={{
                                                        background: hasMessages ? 'rgba(52,152,219,0.1)' : 'rgba(255,255,255,0.03)',
                                                        padding:'0.8rem 0.5rem',
                                                        borderRadius:'10px',
                                                        textAlign:'center',
                                                        border: hasMessages ? '1px solid rgba(52,152,219,0.2)' : '1px solid rgba(255,255,255,0.05)',
                                                        cursor: hasMessages ? 'pointer' : 'default'
                                                    }}
                                                    onClick={(e) => {
                                                        if (hasMessages) {
                                                            e.stopPropagation();
                                                            setSelectedTable(t);
                                                            setShowChat(true);
                                                        }
                                                    }}
                                                >
                                                    <div style={{color:hasMessages?'var(--info)':'var(--text-secondary)',fontWeight:'900',fontSize:'1.3rem'}}>
                                                        {hasMessages ? unreadCount : 'üí¨'}
                                                    </div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.7rem',fontWeight:'600'}}>Mensagens</div>
                                                </div>
                                            </div>
                                            
                                            {/* Bot√µes de A√ß√£o */}
                                            <div style={{display:'grid',gap:'0.8rem'}}>
                                                {isCallingWaiter && (
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            db.ref(`tables/${t.id}/callWaiter`).set(false);
                                                            playSound();
                                                            alert('‚úÖ Chamado atendido!');
                                                        }} 
                                                        className="btn"
                                                        style={{
                                                            background:'linear-gradient(135deg, var(--warning), #e67e22)',
                                                            color:'#000',
                                                            boxShadow:'0 4px 15px rgba(243,156,18,0.4)'
                                                        }}
                                                    >
                                                        ‚úì ATENDER CHAMADO
                                                    </button>
                                                )}
                                                
                                                {hasPending && (
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            confirmAllPending(t.id);
                                                        }} 
                                                        className="btn btn-success"
                                                    >
                                                        ‚úì CONFIRMAR TODOS ({t.pending.length})
                                                    </button>
                                                )}
                                                
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setOrderingFor(t);
                                                    }}
                                                    className="btn"
                                                    style={{
                                                        background:'linear-gradient(135deg, var(--info), #2980b9)',
                                                        color:'#fff',
                                                        boxShadow:'0 4px 15px rgba(52,152,219,0.3)'
                                                    }}
                                                >
                                                    + FAZER PEDIDO
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                ) : (
                    <div>
                        <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',marginBottom:'2rem',display:'flex',justifyContent:'space-between'}}>
                            <h2 style={{color:'#3498db',margin:0}}>Mesa {orderingFor.id} - Fazer Pedido</h2>
                            <button onClick={() => {setOrderingFor(null); setCart([]);}} style={{padding:'0.8rem 1.5rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                        </div>
                        {Object.entries(grouped).map(([cat, items]) => (
                            <div key={cat} style={{marginBottom:'2rem'}}>
                                <h3 style={{fontSize:'1.3rem',marginBottom:'1rem',color:'#d4a574'}}>{cat}</h3>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(150px,1fr))',gap:'1rem'}}>
                                    {items.map(p => (
                                        <div key={p.id} onClick={() => {
                                            const ex = cart.find(i => i.id === p.id);
                                            if (ex) setCart(cart.map(i => i.id === p.id ? {...i, quantity: i.quantity + 1} : i));
                                            else setCart([...cart, {...p, quantity: 1}]);
                                        }} style={{background:'#1a1a1a',border:'2px solid #333',borderRadius:'12px',padding:'1rem',textAlign:'center',cursor:'pointer'}}>
                                            <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>{p.image}</div>
                                            <div style={{fontWeight:'800',fontSize:'0.9rem',marginBottom:'0.3rem'}}>{p.name}</div>
                                            <div style={{color:'#3498db',fontWeight:'900'}}>{config.currency} {p.price.toFixed(2)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        {cart.length > 0 && (
                            <div style={{position:'fixed',bottom:'20px',right:'20px',background:'#1a1a1a',border:'3px solid #3498db',borderRadius:'16px',padding:'1.5rem',minWidth:'300px',maxHeight:'60vh',overflowY:'auto',boxShadow:'0 8px 32px rgba(0,0,0,0.5)',zIndex:1000}}>
                                <h3 style={{color:'#3498db',marginBottom:'1rem'}}>üõí Carrinho ({cart.length})</h3>
                                {cart.map(i => (
                                    <div key={i.id} style={{background:'#0a0a0a',borderRadius:'8px',padding:'0.8rem',marginBottom:'0.8rem',display:'flex',alignItems:'center',gap:'0.8rem'}}>
                                        <span style={{fontSize:'1.5rem'}}>{i.image}</span>
                                        <div style={{flex:1}}>
                                            <div style={{fontWeight:'800',fontSize:'0.9rem'}}>{i.name}</div>
                                            <div style={{color:'#3498db',fontSize:'0.85rem'}}>{config.currency} {(i.price * i.quantity).toFixed(2)}</div>
                                        </div>
                                        <div style={{display:'flex',gap:'0.3rem',alignItems:'center'}}>
                                            <button onClick={() => setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity - 1} : x).filter(x => x.quantity > 0))} style={{background:'#e74c3c',border:'none',width:'24px',height:'24px',borderRadius:'50%',color:'#fff',cursor:'pointer',fontWeight:'900'}}>‚àí</button>
                                            <span style={{fontWeight:'900',minWidth:'20px',textAlign:'center'}}>{i.quantity}</span>
                                            <button onClick={() => setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity + 1} : x))} style={{background:'#4a9d4e',border:'none',width:'24px',height:'24px',borderRadius:'50%',color:'#fff',cursor:'pointer',fontWeight:'900'}}>+</button>
                                        </div>
                                    </div>
                                ))}
                                <div style={{borderTop:'2px solid #333',paddingTop:'1rem',marginTop:'1rem'}}>
                                    <div style={{marginBottom:'1rem',textAlign:'right'}}>
                                        <span style={{color:'#888'}}>Total: </span>
                                        <span style={{color:'#3498db',fontSize:'1.3rem',fontWeight:'900'}}>{config.currency} {cart.reduce((s, i) => s + i.price * i.quantity, 0).toFixed(2)}</span>
                                    </div>
                                    <button onClick={sendOrder} style={{width:'100%',padding:'1rem',background:'linear-gradient(135deg,#4a9d4e,#45a049)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'900',cursor:'pointer'}}>üì§ ENVIAR PEDIDO</button>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </main>
        </div>
    );
}

function Customer({tables, products, config, waiters, setView, theme, toggleTheme}) {
    const tableId = parseInt(sessionStorage.getItem('tableId'));
    const [table, setTable] = useState(null);
    const [cart, setCart] = useState([]);
    const [show, setShow] = useState(false);
    const [tab, setTab] = useState('menu');
    const [chatMessage, setChatMessage] = useState('');
    const [showChat, setShowChat] = useState(false);
    const [unreadMessages, setUnreadMessages] = useState(0);
    const chatEndRef = useRef(null);
    
    // Scroll autom√°tico para √∫ltima mensagem
    useEffect(() => {
        if (showChat && chatEndRef.current) {
            chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
    }, [table?.messages, showChat]);
    
    // Contar mensagens n√£o lidas
    useEffect(() => {
        if (table?.messages) {
            const unread = table.messages.filter(m => m.from !== 'customer' && !m.read).length;
            setUnreadMessages(unread);
        }
    }, [table?.messages]);
    
    // Marcar mensagens como lidas quando abrir chat
    useEffect(() => {
        if (showChat && table?.messages && unreadMessages > 0) {
            const updatedMessages = table.messages.map(m => 
                m.from !== 'customer' ? {...m, read: true} : m
            );
            db.ref(`tables/${tableId}/messages`).set(updatedMessages);
            setUnreadMessages(0);
        }
    }, [showChat]);
    
    const sendMessage = () => {
        if (!chatMessage.trim()) return;
        
        const newMessage = {
            text: chatMessage,
            from: 'customer',
            customerName: table.customerName || 'Cliente',
            timestamp: Date.now(),
            read: false
        };
        
        const messages = table.messages || [];
        db.ref(`tables/${tableId}/messages`).set([...messages, newMessage]);
        
        setChatMessage('');
        playSound();
    };
    
    const callWaiter = () => {
        if (!confirm('Deseja chamar o gar√ßom?')) return;
        
        db.ref(`tables/${tableId}/callWaiter`).set(true).then(() => {
            playSound();
            alert('‚úÖ Gar√ßom chamado! Aguarde, ele j√° vem atend√™-lo.');
        });
    };
    
    useEffect(() => {
        if (!tableId) {setView('login'); return;}
        db.ref(`tables/${tableId}`).on('value', s => {if (s.val()) setTable(s.val());});
        return () => db.ref(`tables/${tableId}`).off();
    }, [tableId]);
    
    const addOrder = () => {
        if (cart.length === 0) {
            alert('‚ùå Carrinho vazio!');
            return;
        }
        
        // Usar push para adicionar novos itens sem sobrescrever
        const newItems = cart.map(i => ({
            ...i, 
            addedAt: Date.now(),
            orderId: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
        }));
        
        // Adicionar cada item individualmente
        const pendingRef = db.ref(`tables/${tableId}/pending`);
        pendingRef.once('value').then(snapshot => {
            const currentPending = snapshot.val() || [];
            const updatedPending = [...currentPending, ...newItems];
            pendingRef.set(updatedPending);
        });
        
        setCart([]);
        setShow(false);
        setTab('bill');
        alert(`‚úÖ ${newItems.length} ${newItems.length === 1 ? 'pedido enviado' : 'pedidos enviados'}!`);
        playSound();
    };
    
    if (!table) return <div style={{padding:'2rem',textAlign:'center'}}>Carregando...</div>;
    
    const grouped = products.filter(p => p.active).reduce((a, p) => {
        if (!a[p.category]) a[p.category] = [];
        a[p.category].push(p);
        return a;
    }, {});
    
    return (
        <div style={{minHeight:'100vh',background:'var(--background)',color:'var(--text)'}}>
            <header style={{background:'var(--surface)',padding:'1.5rem',textAlign:'center',color:'var(--text)',position:'relative'}}>
                {/* Bot√£o de Tema */}
                <div style={{position:'absolute',top:'1rem',right:'1rem',zIndex:10}}>
                    <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                </div>
                
                {config.logo && (
                    <div style={{marginBottom:'1rem'}}>
                        <img src={config.logo} alt={config.barName} style={{maxWidth:'300px',height:'200px'}} />
                    </div>
                )}
                <div style={{background:'#d4a574',padding:'0.5rem 1.5rem',borderRadius:'25px',display:'inline-block',marginBottom:'1rem',color:'#000',fontWeight:'800'}}>MESA {table.id}</div>
                {!config.logo && <h1 style={{fontSize:'2rem',marginBottom:'0.5rem'}}>{config.barName}</h1>}
            </header>
            
            <nav style={{display:'flex',background:'#f5f5f5',borderBottom:'2px solid #e0e0e0',position:'sticky',top:0,zIndex:100}}>
                <button onClick={() => setTab('menu')} style={{flex:1,padding:'1.2rem',background:tab==='menu'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='menu'?'#d4a574':'#666',cursor:'pointer'}}>üìã CARD√ÅPIO</button>
                <button onClick={() => setTab('bill')} style={{flex:1,padding:'1.2rem',background:tab==='bill'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='bill'?'#d4a574':'#666',cursor:'pointer'}}>üßæ CONTA</button>
                <button onClick={() => {setTab('chat'); setShowChat(true);}} style={{flex:1,padding:'1.2rem',background:tab==='chat'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='chat'?'#3498db':'#666',cursor:'pointer',position:'relative'}}>
                    üí¨ CHAT
                    {unreadMessages > 0 && (
                        <span style={{
                            position:'absolute',
                            top:'8px',
                            right:'8px',
                            background:'#e74c3c',
                            color:'#fff',
                            borderRadius:'50%',
                            width:'20px',
                            height:'20px',
                            fontSize:'0.7rem',
                            display:'flex',
                            alignItems:'center',
                            justifyContent:'center',
                            fontWeight:'900'
                        }}>{unreadMessages}</span>
                    )}
                </button>
                <button onClick={() => setTab('call')} style={{flex:1,padding:'1.2rem',background:tab==='call'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='call'?'#f39c12':'#666',cursor:'pointer'}}>üîî CHAMAR</button>
            </nav>
            
            <main style={{padding:'2rem',paddingBottom:'150px'}}>
                {tab === 'menu' && (
                    <div>
                        {Object.entries(grouped).map(([cat, items]) => (
                            <div key={cat} style={{marginBottom:'2.5rem'}}>
                                <h2 style={{fontSize:'1.8rem',fontWeight:'900',marginBottom:'1.5rem'}}>{cat === 'Bebidas' ? 'üç∫' : 'üçó'} {cat}</h2>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(160px,1fr))',gap:'1.5rem'}}>
                                    {items.map(p => (
                                        <div key={p.id} onClick={() => {
                                            const ex = cart.find(i => i.id === p.id);
                                            if (ex) setCart(cart.map(i => i.id === p.id ? {...i, quantity: i.quantity + 1} : i));
                                            else setCart([...cart, {...p, quantity: 1}]);
                                        }} style={{background:'#fff',border:'2px solid #e0e0e0',borderRadius:'16px',padding:'1.5rem',textAlign:'center',cursor:'pointer'}}>
                                            <span style={{fontSize:'3.5rem',display:'block',marginBottom:'0.8rem'}}>{p.image}</span>
                                            <div style={{fontWeight:'800',marginBottom:'0.5rem',fontSize:'0.95rem'}}>{p.name}</div>
                                            <div style={{color:'#d4a574',fontSize:'1.2rem',fontWeight:'900'}}>{config.currency} {p.price.toFixed(2)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {tab === 'bill' && (
                    <div style={{background:'#fff',borderRadius:'20px',padding:'2rem'}}>
                        <div style={{textAlign:'center',paddingBottom:'1.5rem',borderBottom:'2px solid #e0e0e0',marginBottom:'1.5rem'}}>
                            <h2 style={{fontSize:'1.8rem',marginBottom:'1rem'}}>Sua Conta</h2>
                            <div style={{fontSize:'3rem',fontWeight:'900',color:'#d4a574'}}>{config.currency} {table.total.toFixed(2)}</div>
                            {table.tip && table.tip > 0 && (
                                <div style={{marginTop:'1rem',padding:'1rem',background:'#fff3cd',borderRadius:'10px'}}>
                                    <div style={{color:'#856404',fontSize:'0.9rem'}}>üíù Gorjeta para o gar√ßom</div>
                                    <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#f39c12'}}>+ {config.currency} {table.tip.toFixed(2)}</div>
                                    <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#d4a574',marginTop:'0.5rem',paddingTop:'0.5rem',borderTop:'2px solid #f39c12'}}>
                                        Total com gorjeta: {config.currency} {(table.total + table.tip).toFixed(2)}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* BOT√ïES DE GORJETA */}
                        {!table.tip && table.orders && table.orders.length > 0 && (
                            <div style={{marginBottom:'2rem',padding:'1.5rem',background:'#f8f9fa',borderRadius:'12px'}}>
                                <h3 style={{textAlign:'center',marginBottom:'1rem',color:'#f39c12',fontSize:'1.3rem'}}>üíù Gostou do atendimento?</h3>
                                <p style={{textAlign:'center',color:'#666',marginBottom:'1rem',fontSize:'0.9rem'}}>Deixe uma gorjeta para o gar√ßom</p>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'1rem'}}>
                                    {[10, 15, 20].map(percent => {
                                        const tipValue = (table.total * percent) / 100;
                                        return (
                                            <button 
                                                key={percent}
                                                onClick={() => {
                                                    if (confirm(`Adicionar gorjeta de ${percent}% (${config.currency} ${tipValue.toFixed(2)})?`)) {
                                                        db.ref(`tables/${tableId}/tip`).set(tipValue);
                                                        alert(`‚úÖ Gorjeta de ${config.currency} ${tipValue.toFixed(2)} adicionada! Obrigado! üíù`);
                                                    }
                                                }}
                                                style={{
                                                    padding:'1.2rem',
                                                    background:'linear-gradient(135deg,#f39c12,#e67e22)',
                                                    border:'none',
                                                    borderRadius:'12px',
                                                    color:'#fff',
                                                    fontWeight:'900',
                                                    cursor:'pointer',
                                                    fontSize:'1rem',
                                                    boxShadow:'0 4px 12px rgba(243,156,18,0.3)'
                                                }}
                                            >
                                                <div style={{fontSize:'1.5rem',marginBottom:'0.3rem'}}>{percent}%</div>
                                                <div style={{fontSize:'0.85rem'}}>{config.currency} {tipValue.toFixed(2)}</div>
                                            </button>
                                        );
                                    })}
                                </div>
                                <button 
                                    onClick={() => {
                                        const customTip = parseFloat(prompt('Digite o valor da gorjeta:'));
                                        if (customTip && customTip > 0) {
                                            db.ref(`tables/${tableId}/tip`).set(customTip);
                                            alert(`‚úÖ Gorjeta de ${config.currency} ${customTip.toFixed(2)} adicionada! Obrigado! üíù`);
                                        }
                                    }}
                                    style={{
                                        width:'100%',
                                        marginTop:'1rem',
                                        padding:'1rem',
                                        background:'#6c757d',
                                        border:'none',
                                        borderRadius:'10px',
                                        color:'#fff',
                                        fontWeight:'800',
                                        cursor:'pointer'
                                    }}
                                >
                                    üí∞ Outro Valor
                                </button>
                            </div>
                        )}
                        
                        {table.orders && table.orders.length > 0 && (
                            <>
                                <h3 style={{marginBottom:'1rem',color:'#4a9d4e'}}>‚úì Confirmados</h3>
                                {table.orders.map((o, i) => (
                                    <div key={i} style={{background:'#f9f9f9',borderRadius:'12px',padding:'1rem',marginBottom:'1rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                                        <span style={{fontSize:'2rem'}}>{o.image}</span>
                                        <div style={{flex:1}}>
                                            <div style={{fontWeight:'800'}}>{o.name}</div>
                                            <div style={{color:'#666'}}>Qtd: {o.quantity}</div>
                                        </div>
                                        <div style={{fontWeight:'800',color:'#d4a574'}}>{config.currency} {(o.price * o.quantity).toFixed(2)}</div>
                                    </div>
                                ))}
                                
                                {/* CARD DE RESUMO E FECHAMENTO */}
                                <div style={{
                                    marginTop:'2rem',
                                    padding:'2rem',
                                    background:'linear-gradient(135deg, rgba(74,157,78,0.1), rgba(69,160,73,0.05))',
                                    border:'2px solid #4a9d4e',
                                    borderRadius:'20px',
                                    boxShadow:'0 8px 25px rgba(74,157,78,0.2)'
                                }}>
                                    <div style={{textAlign:'center',marginBottom:'1.5rem'}}>
                                        <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>‚úÖ</div>
                                        <h3 style={{fontSize:'1.5rem',fontWeight:'900',color:'#4a9d4e',marginBottom:'0.5rem'}}>
                                            Pronto para Pagar?
                                        </h3>
                                        <p style={{color:'#666',fontSize:'0.95rem'}}>
                                            Revise sua conta e solicite o fechamento
                                        </p>
                                    </div>
                                    
                                    {/* Resumo r√°pido */}
                                    <div style={{
                                        background:'#fff',
                                        padding:'1.5rem',
                                        borderRadius:'15px',
                                        marginBottom:'1.5rem',
                                        boxShadow:'0 2px 10px rgba(0,0,0,0.05)'
                                    }}>
                                        <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.8rem'}}>
                                            <span style={{color:'#666',fontWeight:'600'}}>Consumo:</span>
                                            <span style={{fontSize:'1.2rem',fontWeight:'900',color:'#d4a574'}}>
                                                {config.currency} {table.subtotal ? table.subtotal.toFixed(2) : table.total.toFixed(2)}
                                            </span>
                                        </div>
                                        {table.tip && table.tip > 0 && (
                                            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.8rem'}}>
                                                <span style={{color:'#666',fontWeight:'600'}}>üíù Gorjeta:</span>
                                                <span style={{fontSize:'1.2rem',fontWeight:'900',color:'#f39c12'}}>
                                                    + {config.currency} {table.tip.toFixed(2)}
                                                </span>
                                            </div>
                                        )}
                                        <div style={{
                                            borderTop:'2px solid #4a9d4e',
                                            paddingTop:'0.8rem',
                                            display:'flex',
                                            justifyContent:'space-between',
                                            alignItems:'center'
                                        }}>
                                            <span style={{fontSize:'1.1rem',fontWeight:'800',color:'#333'}}>TOTAL:</span>
                                            <span style={{fontSize:'2rem',fontWeight:'900',color:'#4a9d4e'}}>
                                                {config.currency} {((table.subtotal || table.total) + (table.tip || 0)).toFixed(2)}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <button
                                        onClick={() => {
                                            if (table.pending && table.pending.length > 0) {
                                                alert('‚ö†Ô∏è Voc√™ ainda tem pedidos pendentes de confirma√ß√£o. Aguarde a confirma√ß√£o antes de solicitar o fechamento da conta.');
                                                return;
                                            }
                                            
                                            const wantToPay = confirm('üí∞ FECHAR CONTA?\n\nValor total: ' + config.currency + ' ' + ((table.subtotal || table.total) + (table.tip || 0)).toFixed(2) + '\n\nO gar√ßom vir√° at√© sua mesa para receber o pagamento.\n\nConfirmar?');
                                            if (!wantToPay) return;
                                            
                                            // Marcar mesa como solicitando fechamento
                                            db.ref(`tables/${tableId}`).update({
                                                callWaiter: true,
                                                requestingBill: true,
                                                billRequestedAt: Date.now()
                                            });
                                            playSound();
                                            alert('‚úÖ Solicita√ß√£o enviada!\n\nO gar√ßom vir√° fechar sua conta em breve.\n\nAguarde na mesa, por favor.');
                                            setTab('call');
                                        }}
                                        style={{
                                            width:'100%',
                                            padding:'1.8rem',
                                            background:'linear-gradient(135deg,#4a9d4e,#45a049)',
                                            border:'none',
                                            borderRadius:'16px',
                                            color:'#fff',
                                            fontWeight:'900',
                                            fontSize:'1.3rem',
                                            cursor:'pointer',
                                            boxShadow:'0 8px 25px rgba(74,157,78,0.4)',
                                            transition:'all 0.3s',
                                            position:'relative',
                                            overflow:'hidden'
                                        }}
                                        onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-3px)'}
                                        onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}
                                        onMouseDown={e => e.currentTarget.style.transform = 'scale(0.97)'}
                                        onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                                    >
                                        <div style={{fontSize:'2.5rem',marginBottom:'0.3rem'}}>üí∞</div>
                                        SOLICITAR FECHAMENTO DA CONTA
                                    </button>
                                    
                                    <p style={{
                                        textAlign:'center',
                                        marginTop:'1rem',
                                        color:'#666',
                                        fontSize:'0.85rem',
                                        lineHeight:'1.5'
                                    }}>
                                        üí° <strong>Dica:</strong> Adicione gorjeta acima antes de fechar a conta!
                                    </p>
                                </div>
                            </>
                        )}
                    </div>
                )}
                
                {tab === 'call' && (
                    <div style={{textAlign:'center',paddingTop:'3rem'}}>
                        <div style={{fontSize:'6rem',marginBottom:'2rem'}}>üîî</div>
                        <h2 style={{fontSize:'2rem',fontWeight:'900',marginBottom:'1rem'}}>Precisa de Ajuda?</h2>
                        <p style={{color:'#666',fontSize:'1.1rem',marginBottom:'3rem'}}>Chame o gar√ßom que ele vir√° atend√™-lo</p>
                        
                        {table.callWaiter ? (
                            <div style={{background:'#fff3cd',border:'2px solid #f39c12',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                                <div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚è≥</div>
                                <h3 style={{color:'#f39c12',fontSize:'1.5rem',fontWeight:'900',marginBottom:'0.5rem'}}>Gar√ßom Chamado!</h3>
                                <p style={{color:'#856404'}}>Aguarde, ele j√° vem atend√™-lo.</p>
                                <button 
                                    onClick={() => db.ref(`tables/${tableId}/callWaiter`).set(false)}
                                    style={{marginTop:'1.5rem',padding:'1rem 2rem',background:'#6c757d',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}
                                >
                                    CANCELAR CHAMADA
                                </button>
                            </div>
                        ) : (
                            <button 
                                onClick={callWaiter}
                                style={{
                                    background:'linear-gradient(135deg,#f39c12,#e67e22)',
                                    border:'none',
                                    padding:'2rem 3rem',
                                    borderRadius:'20px',
                                    color:'#fff',
                                    fontWeight:'900',
                                    fontSize:'1.5rem',
                                    cursor:'pointer',
                                    boxShadow:'0 8px 20px rgba(243,156,18,0.4)',
                                    transition:'all 0.3s'
                                }}
                                onMouseDown={e => e.currentTarget.style.transform = 'scale(0.95)'}
                                onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                üîî CHAMAR GAR√áOM
                            </button>
                        )}
                    </div>
                )}
                
                {tab === 'chat' && (
                    <div style={{maxWidth:'600px',margin:'0 auto'}}>
                        <div style={{textAlign:'center',padding:'2rem 0 1rem'}}>
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üí¨</div>
                            <h2 style={{fontSize:'1.8rem',fontWeight:'900',marginBottom:'0.5rem',color:'#3498db'}}>Chat com o Balc√£o</h2>
                            <p style={{color:'#666',fontSize:'0.9rem'}}>Envie mensagens diretas para o atendimento</p>
                        </div>
                        
                        {/* √Årea de Mensagens */}
                        <div style={{
                            background:'#f5f5f5',
                            borderRadius:'20px',
                            padding:'1.5rem',
                            minHeight:'400px',
                            maxHeight:'500px',
                            overflowY:'auto',
                            marginBottom:'1.5rem',
                            border:'2px solid #e0e0e0'
                        }}>
                            {(!table.messages || table.messages.length === 0) ? (
                                <div style={{textAlign:'center',padding:'3rem',color:'#999'}}>
                                    <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üì≠</div>
                                    <p>Nenhuma mensagem ainda</p>
                                    <p style={{fontSize:'0.9rem',marginTop:'0.5rem'}}>Envie uma mensagem para come√ßar!</p>
                                </div>
                            ) : (
                                <div>
                                    {table.messages.map((msg, idx) => (
                                        <div 
                                            key={idx}
                                            style={{
                                                display:'flex',
                                                justifyContent: msg.from === 'customer' ? 'flex-end' : 'flex-start',
                                                marginBottom:'1rem'
                                            }}
                                        >
                                            <div style={{
                                                maxWidth:'70%',
                                                padding:'1rem 1.2rem',
                                                borderRadius: msg.from === 'customer' ? '20px 20px 5px 20px' : '20px 20px 20px 5px',
                                                background: msg.from === 'customer' ? 'linear-gradient(135deg, #3498db, #2980b9)' : '#fff',
                                                color: msg.from === 'customer' ? '#fff' : '#000',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                                wordBreak:'break-word'
                                            }}>
                                                {msg.from !== 'customer' && (
                                                    <div style={{fontSize:'0.75rem',fontWeight:'700',marginBottom:'0.3rem',opacity:0.8}}>
                                                        {msg.senderName || 'Balc√£o'}
                                                    </div>
                                                )}
                                                <div style={{fontSize:'0.95rem',marginBottom:'0.3rem'}}>
                                                    {msg.text}
                                                </div>
                                                <div style={{
                                                    fontSize:'0.7rem',
                                                    opacity:0.7,
                                                    textAlign:'right'
                                                }}>
                                                    {new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={chatEndRef} />
                                </div>
                            )}
                        </div>
                        
                        {/* Input de Mensagem */}
                        <div style={{
                            display:'flex',
                            gap:'0.8rem',
                            background:'#fff',
                            padding:'1rem',
                            borderRadius:'20px',
                            border:'2px solid #e0e0e0',
                            position:'sticky',
                            bottom:'20px'
                        }}>
                            <input 
                                type="text"
                                value={chatMessage}
                                onChange={e => setChatMessage(e.target.value)}
                                onKeyPress={e => {if (e.key === 'Enter') sendMessage();}}
                                placeholder="Digite sua mensagem..."
                                style={{
                                    flex:1,
                                    padding:'1rem 1.2rem',
                                    border:'none',
                                    background:'#f5f5f5',
                                    borderRadius:'15px',
                                    fontSize:'1rem',
                                    outline:'none'
                                }}
                            />
                            <button 
                                onClick={sendMessage}
                                disabled={!chatMessage.trim()}
                                style={{
                                    padding:'1rem 1.5rem',
                                    background: chatMessage.trim() ? 'linear-gradient(135deg, #3498db, #2980b9)' : '#ccc',
                                    border:'none',
                                    borderRadius:'15px',
                                    color:'#fff',
                                    fontSize:'1.3rem',
                                    cursor: chatMessage.trim() ? 'pointer' : 'not-allowed',
                                    transition:'all 0.3s',
                                    boxShadow: chatMessage.trim() ? '0 4px 15px rgba(52,152,219,0.3)' : 'none'
                                }}
                            >
                                üì§
                            </button>
                        </div>
                    </div>
                )}
            </main>
            
            {cart.length > 0 && (
                <div style={{position:'fixed',bottom:'20px',left:'20px',right:'20px',maxWidth:'500px',margin:'0 auto',zIndex:1000}}>
                    <button onClick={() => setShow(true)} style={{width:'100%',background:'linear-gradient(135deg,#d4a574,#8B4513)',border:'none',padding:'1.5rem',borderRadius:'50px',color:'#fff',fontWeight:'900',cursor:'pointer',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:'1.1rem'}}>
                        <span>üõí CARRINHO</span>
                        <span style={{background:'#fff',color:'#d4a574',width:'35px',height:'35px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center'}}>{cart.length}</span>
                    </button>
                </div>
            )}
            
            {show && (
                <div onClick={() => setShow(false)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.8)',zIndex:2000,display:'flex',alignItems:'flex-end'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#fff',borderRadius:'28px 28px 0 0',width:'100%',maxHeight:'85vh',overflow:'auto'}}>
                        <div style={{position:'sticky',top:0,background:'#fff',padding:'2rem',borderBottom:'2px solid #e0e0e0',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                            <h3 style={{fontSize:'1.5rem',fontWeight:'900'}}>Carrinho</h3>
                            <button onClick={() => setShow(false)} style={{background:'#f5f5f5',border:'none',width:'40px',height:'40px',borderRadius:'50%',cursor:'pointer',fontSize:'1.5rem'}}>√ó</button>
                        </div>
                        <div style={{padding:'2rem'}}>
                            {cart.map(i => (
                                <div key={i.id} style={{background:'#f9f9f9',borderRadius:'16px',padding:'1.2rem',marginBottom:'1rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                                    <span style={{fontSize:'2.5rem'}}>{i.image}</span>
                                    <div style={{flex:1}}>
                                        <div style={{fontWeight:'800'}}>{i.name}</div>
                                        <div style={{color:'#d4a574',fontWeight:'800'}}>{config.currency} {(i.price * i.quantity).toFixed(2)}</div>
                                    </div>
                                    <div style={{display:'flex',alignItems:'center',gap:'1rem',background:'#fff',padding:'0.5rem 1rem',borderRadius:'25px'}}>
                                        <button onClick={() => {
                                            if (i.quantity > 1) setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity - 1} : x));
                                            else setCart(cart.filter(x => x.id !== i.id));
                                        }} style={{background:'#d4a574',border:'none',width:'32px',height:'32px',borderRadius:'50%',color:'#fff',fontSize:'1.2rem',cursor:'pointer'}}>‚àí</button>
                                        <span style={{fontWeight:'900',minWidth:'30px',textAlign:'center'}}>{i.quantity}</span>
                                        <button onClick={() => setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity + 1} : x))} style={{background:'#d4a574',border:'none',width:'32px',height:'32px',borderRadius:'50%',color:'#fff',fontSize:'1.2rem',cursor:'pointer'}}>+</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div style={{position:'sticky',bottom:0,background:'#fff',padding:'2rem',borderTop:'2px solid #e0e0e0'}}>
                            <button onClick={addOrder} style={{width:'100%',background:'linear-gradient(135deg,#4a9d4e,#45a049)',border:'none',padding:'1.2rem',borderRadius:'12px',color:'#fff',fontWeight:'900',fontSize:'1.1rem',cursor:'pointer'}}>ENVIAR PEDIDO</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
<style>
@keyframes blink {
    0%, 100% { border-color: #e74c3c; box-shadow: 0 0 20px rgba(231,76,60,0.5); }
    50% { border-color: #c0392b; box-shadow: 0 0 40px rgba(231,76,60,0.8); }
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>
</body>
</html>
