<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#d4a574">
    <title>Sistema de Gest√£o - Bar Premium</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #d4a574;
            --primary-dark: #b8915f;
            --primary-light: #e8c9a0;
            --secondary: #1a1a1a;
            --accent: #4a9d4e;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --background: #0f0f0f;
            --surface: #1a1a1a;
            --surface-light: #2a2a2a;
            --text: #ffffff;
            --text-secondary: #888888;
            --border: #333333;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(-100%); 
            }
            to { 
                transform: translateX(0); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }
        
        @keyframes shine {
            0% { 
                background-position: -200% center; 
            }
            100% { 
                background-position: 200% center; 
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Glass morphism */
        .glass {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Bot√µes modernos */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #000;
            box-shadow: 0 4px 15px rgba(212, 165, 116, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(212, 165, 116, 0.4);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--accent), #45a049);
            color: #fff;
            box-shadow: 0 4px 15px rgba(74, 157, 78, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: #fff;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* Cards modernos */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--primary);
        }
        
        /* Input moderno */
        .input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        }
        
        .input::placeholder {
            color: var(--text-secondary);
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background: var(--primary);
            color: #000;
        }
        
        .badge-success {
            background: var(--accent);
            color: #fff;
        }
        
        .badge-danger {
            background: var(--danger);
            color: #fff;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useRef } = React;

const firebaseConfig = {
    apiKey: "AIzaSyBC2DuHu1P0fKUOJpm_PpWAGiKkEEPyMu8",
    authDomain: "bares-bae14.firebaseapp.com",
    databaseURL: "https://bares-bae14-default-rtdb.firebaseio.com",
    projectId: "bares-bae14",
    storageBucket: "bares-bae14.firebasestorage.app",
    messagingSenderId: "581436771219",
    appId: "1:581436771219:web:b60519997b643b86fc7666"
};

let db;
try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log('‚úÖ Firebase conectado');
} catch (e) {
    console.error('‚ùå Firebase erro:', e);
}

// Verificar se QRCode est√° dispon√≠vel
setTimeout(() => {
    if (window.QRCode) {
        console.log('‚úÖ Biblioteca QRCode carregada');
    } else {
        console.error('‚ùå Biblioteca QRCode n√£o carregada!');
    }
}, 1000);

const playSound = () => {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.5);
    } catch(e) {}
};

const INITIAL_CONFIG = {
    barName: 'Meu Bar',
    logo: null,
    masterPin: '0000',
    adminPin: '9999',
    balcaoPin: '8888',
    currency: 'R$',
    tables: 12
};

const INITIAL_PRODUCTS = [
    {id: 1, name: 'Cerveja', price: 12, image: 'üç∫', category: 'Bebidas', active: true},
    {id: 2, name: 'Caipirinha', price: 15, image: 'üçπ', category: 'Bebidas', active: true},
    {id: 3, name: 'Batata Frita', price: 28, image: 'üçü', category: 'Comidas', active: true},
    {id: 4, name: 'Espetinho', price: 8, image: ' ‰∏≤', category: 'Comidas', active: true},
    {id: 5, name: 'Caldo', price: 12, image: 'üç≤', category: 'Comidas', active: true},
    {id: 6, name: 'Caldeir√£o', price: 45, image: 'ü•ò', category: 'Comidas', active: true},
    {id: 7, name: 'A√ßa√≠', price: 18, image: 'üçá', category: 'Sobremesas', active: true},
    {id: 8, name: 'Sorvete', price: 10, image: 'üç¶', category: 'Sobremesas', active: true},
];

const INITIAL_WAITERS = [
    {id: 1, name: 'Jo√£o', pin: '1234', active: true, sales: 0},
    {id: 2, name: 'Maria', pin: '2345', active: true, sales: 0},
];

function PasswordInput({value, onChange, placeholder, style, maxLength, onKeyPress}) {
    const [show, setShow] = useState(false);
    return (
        <div style={{position:'relative'}}>
            <input 
                type={show ? 'text' : 'password'} 
                value={value} 
                onChange={onChange} 
                onKeyPress={onKeyPress}
                placeholder={placeholder} 
                maxLength={maxLength} 
                style={style} 
            />
            <button type="button" onClick={() => setShow(!show)} style={{position:'absolute',right:'1rem',top:'50%',transform:'translateY(-50%)',background:'transparent',border:'none',cursor:'pointer',fontSize:'1.3rem'}}>
                {show ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
            </button>
        </div>
    );
}

function App() {
    const [view, setView] = useState('login');
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [config, setConfig] = useState(INITIAL_CONFIG);
    const [products, setProducts] = useState([]);
    const [waiters, setWaiters] = useState([]);
    const [tables, setTables] = useState([]);
    const [sales, setSales] = useState([]);
    const prevTables = useRef([]);
    
    useEffect(() => {
        if (!db) {setLoading(false); return;}
        
        db.ref('config').on('value', s => {
            if (s.val()) setConfig(s.val());
            else db.ref('config').set(INITIAL_CONFIG);
        });
        
        db.ref('products').on('value', s => {
            if (s.val()) setProducts(Object.keys(s.val()).map(k => ({...s.val()[k], id: k})));
            else {
                const obj = {};
                INITIAL_PRODUCTS.forEach(p => obj[p.id] = p);
                db.ref('products').set(obj);
            }
        });
        
        db.ref('sales').on('value', s => {
            if (s.val()) {
                setSales(Object.values(s.val()).sort((a, b) => b.timestamp - a.timestamp));
            }
        });
        
        db.ref('waiters').on('value', s => {
            if (s.val()) setWaiters(Object.values(s.val()));
            else {
                const obj = {};
                INITIAL_WAITERS.forEach(w => obj[w.id] = w);
                db.ref('waiters').set(obj);
            }
        });
        
        db.ref('tables').on('value', s => {
            if (s.val()) {
                const newT = Object.values(s.val());
                if (prevTables.current.length > 0) {
                    newT.forEach(nt => {
                        const ot = prevTables.current.find(t => t.id === nt.id);
                        if (ot && nt.pending && ot.pending && nt.pending.length > ot.pending.length) {
                            playSound();
                        }
                        // Detectar chamada de gar√ßom
                        if (ot && nt.callWaiter && !ot.callWaiter) {
                            playSound();
                        }
                    });
                }
                prevTables.current = newT;
                setTables(newT);
            } else {
                const obj = {};
                for (let i = 1; i <= INITIAL_CONFIG.tables; i++) {
                    obj[i] = {
                        id: i,
                        status: 'livre',
                        waiter: null,
                        customerName: null,
                        customerPin: null,
                        total: 0,
                        subtotal: 0,
                        tip: 0,
                        orders: [],
                        pending: [],
                        callWaiter: false
                    };
                }
                db.ref('tables').set(obj);
            }
        });
        
        setTimeout(() => setLoading(false), 800);
    }, []);
    
    if (loading) return <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center'}}><h2 style={{color:'#d4a574'}}>Carregando...</h2></div>;
    
    const props = {config, products, waiters, tables, sales, user, setUser, setView};
    
    if (view === 'login') return <Login {...props} />;
    if (view === 'master') return <Master {...props} />;
    if (view === 'admin') return <Admin {...props} />;
    if (view === 'balcao') return <Balcao {...props} />;
    if (view === 'waiter') return <Waiter {...props} />;
    if (view === 'customer') return <Customer {...props} />;
}

function Login({config, tables, waiters, setUser, setView}) {
    const [mode, setMode] = useState('staff');
    const [pin, setPin] = useState('');
    const [mesa, setMesa] = useState('');
    const [nome, setNome] = useState('');
    const [ask, setAsk] = useState(false);
    
    // Detectar acesso via QR Code
    useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const mesaParam = urlParams.get('mesa');
        
        if (mesaParam) {
            // Cliente veio via QR Code
            setMode('customer');
            setMesa(mesaParam);
            
            // Verificar status da mesa
            const table = tables.find(t => t.id === parseInt(mesaParam));
            if (table) {
                if (table.status === 'livre') {
                    // Mesa livre, pedir nome
                    setAsk(true);
                } else {
                    // Mesa ocupada, n√£o pode acessar via QR Code
                    alert('‚ùå Esta mesa j√° est√° ocupada! Por favor, solicite ajuda ao gar√ßom.');
                    // Limpar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
    }, [tables]);
    
    const go = () => {
        if (pin === '0000') {setUser({name:'Master',role:'master'}); setView('master');}
        else if (pin === '9999') {setUser({name:'Admin',role:'admin'}); setView('admin');}
        else if (pin === '8888') {setUser({name:'Balc√£o',role:'balcao'}); setView('balcao');}
        else {
            const w = waiters.find(x => x.pin === pin && x.active);
            if (w) {setUser({name:w.name,role:'waiter',waiterId:w.id}); setView('waiter');}
            else alert('PIN incorreto!');
        }
    };
    
    return (
        <div className="fade-in" style={{
            minHeight:'100vh',
            display:'flex',
            alignItems:'center',
            justifyContent:'center',
            padding:'2rem',
            background:'linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)',
            position:'relative',
            overflow:'hidden'
        }}>
            {/* Background decorativo */}
            <div style={{
                position:'absolute',
                top:'-50%',
                right:'-20%',
                width:'600px',
                height:'600px',
                background:'radial-gradient(circle, rgba(212,165,116,0.05) 0%, transparent 70%)',
                borderRadius:'50%',
                pointerEvents:'none'
            }}></div>
            <div style={{
                position:'absolute',
                bottom:'-30%',
                left:'-10%',
                width:'400px',
                height:'400px',
                background:'radial-gradient(circle, rgba(74,157,78,0.03) 0%, transparent 70%)',
                borderRadius:'50%',
                pointerEvents:'none'
            }}></div>
            
            <div className="glass" style={{
                maxWidth:'480px',
                width:'100%',
                padding:'3rem',
                borderRadius:'24px',
                boxShadow:'0 20px 60px rgba(0,0,0,0.5)',
                position:'relative',
                zIndex:1
            }}>
                {/* Logo e Nome do Bar */}
                <div style={{textAlign:'center',marginBottom:'3rem'}}>
                    {config.logo ? (
                        <div style={{
                            marginBottom:'1.5rem',
                            background:'rgba(212,165,116,0.05)',
                            padding:'1.5rem',
                            borderRadius:'20px',
                            display:'inline-block'
                        }}>
                            <img src={config.logo} alt={config.barName} style={{
                                maxWidth:'280px',
                                height:'auto',
                                maxHeight:'180px',
                                objectFit:'contain',
                                filter:'drop-shadow(0 4px 10px rgba(212,165,116,0.3))'
                            }} />
                        </div>
                    ) : (
                        <div style={{
                            fontSize:'5rem',
                            marginBottom:'1rem',
                            filter:'drop-shadow(0 4px 10px rgba(212,165,116,0.3))'
                        }}>üç∫</div>
                    )}
                    <h1 className="gradient-text" style={{
                        fontSize:'2.5rem',
                        marginBottom:'0.5rem',
                        fontWeight:'900',
                        letterSpacing:'-0.5px'
                    }}>{config.barName}</h1>
                    <p style={{
                        color:'var(--text-secondary)',
                        fontSize:'0.95rem',
                        fontWeight:'500'
                    }}>Sistema de Gest√£o</p>
                </div>
                
                {/* Tabs de sele√ß√£o */}
                <div style={{
                    display:'grid',
                    gridTemplateColumns:'1fr 1fr',
                    gap:'0.75rem',
                    marginBottom:'2.5rem',
                    padding:'0.5rem',
                    background:'var(--surface)',
                    borderRadius:'14px'
                }}>
                    <button 
                        onClick={() => {setMode('staff');setAsk(false);}} 
                        className={mode==='staff' ? 'btn-primary' : ''}
                        style={{
                            padding:'1rem',
                            background:mode==='staff' ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'transparent',
                            border:'none',
                            borderRadius:'10px',
                            color:mode==='staff' ? '#000' : 'var(--text-secondary)',
                            fontWeight:'700',
                            fontSize:'0.95rem',
                            cursor:'pointer',
                            transition:'all 0.3s ease',
                            boxShadow: mode==='staff' ? '0 4px 15px rgba(212,165,116,0.3)' : 'none'
                        }}
                    >
                        üëë EQUIPE
                    </button>
                    <button 
                        onClick={() => {setMode('customer');setAsk(false);}} 
                        className={mode==='customer' ? 'btn-success' : ''}
                        style={{
                            padding:'1rem',
                            background:mode==='customer' ? 'linear-gradient(135deg, var(--accent), #45a049)' : 'transparent',
                            border:'none',
                            borderRadius:'10px',
                            color:mode==='customer' ? '#fff' : 'var(--text-secondary)',
                            fontWeight:'700',
                            fontSize:'0.95rem',
                            cursor:'pointer',
                            transition:'all 0.3s ease',
                            boxShadow: mode==='customer' ? '0 4px 15px rgba(74,157,78,0.3)' : 'none'
                        }}
                    >
                        üë• CLIENTE
                    </button>
                </div>
                
                {mode === 'staff' && !ask && (
                    <div className="slide-in">
                        <PasswordInput 
                            value={pin} 
                            onChange={e => setPin(e.target.value)} 
                            onKeyPress={e => {if (e.key === 'Enter') go();}}
                            placeholder="Digite seu PIN" 
                            maxLength={4} 
                            style={{
                                width:'100%',
                                padding:'1.2rem 1.5rem',
                                background:'var(--surface)',
                                border:'2px solid var(--border)',
                                borderRadius:'12px',
                                color:'var(--text)',
                                fontSize:'1.1rem',
                                textAlign:'center',
                                marginBottom:'1.5rem',
                                letterSpacing:'0.3rem',
                                fontWeight:'600',
                                transition:'all 0.3s ease'
                            }} 
                        />
                        <button 
                            onClick={go} 
                            className="btn btn-primary"
                            style={{
                                width:'100%',
                                marginBottom:'1.5rem'
                            }}
                        >
                            ENTRAR
                        </button>
                        <div style={{
                            padding:'1.2rem',
                            background:'rgba(212,165,116,0.05)',
                            borderRadius:'12px',
                            border:'1px solid rgba(212,165,116,0.1)'
                        }}>
                            <p style={{color:'var(--text-secondary)',fontSize:'0.8rem',marginBottom:'0.8rem',fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.5px'}}>Acessos R√°pidos</p>
                            <div style={{display:'grid',gap:'0.5rem'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>üëë Master</span>
                                    <span className="badge badge-primary">0000</span>
                                </div>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>‚öôÔ∏è Admin</span>
                                    <span className="badge badge-success">9999</span>
                                </div>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <span style={{color:'var(--text-secondary)',fontSize:'0.9rem'}}>üí∞ Balc√£o</span>
                                    <span style={{
                                        padding:'0.4rem 0.8rem',
                                        borderRadius:'20px',
                                        fontSize:'0.85rem',
                                        fontWeight:'600',
                                        background:'#e67e22',
                                        color:'#fff'
                                    }}>8888</span>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {mode === 'customer' && !ask && (
                    <div>
                        <input 
                            type="number" 
                            value={mesa} 
                            onChange={e => setMesa(e.target.value)} 
                            onKeyPress={e => {
                                if (e.key === 'Enter') {
                                    const t = tables.find(x => x.id === parseInt(mesa));
                                    if (!t) {alert('‚ùå Mesa inv√°lida'); return;}
                                    if (t.status === 'livre') {
                                        setAsk(true);
                                    } else {
                                        // Mesa ocupada - mostrar mensagem amig√°vel antes de pedir senha
                                        if (confirm('‚ö†Ô∏è MESA OCUPADA\n\nEsta mesa j√° est√° em uso.\n\nüì± Se esta √© SUA mesa, clique em OK para inserir sua senha.\n\n‚ùå Se n√£o √© sua mesa, clique em CANCELAR.')) {
                                            const senha = prompt('üîê Digite a senha de 4 d√≠gitos da sua mesa:');
                                            if (!senha) return;
                                            
                                            if (t.customerPin && senha === t.customerPin) {
                                                // Senha correta
                                                sessionStorage.setItem('tableId', mesa);
                                                sessionStorage.setItem('customerPin', senha);
                                                setUser({tableId: parseInt(mesa)});
                                                setView('customer');
                                            } else {
                                                alert('‚ùå Senha incorreta!\n\nEsta mesa pertence a outro cliente.\nSolicite ajuda ao gar√ßom.');
                                            }
                                        }
                                    }
                                }
                            }}
                            placeholder="N√∫mero da Mesa" 
                            style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #444',borderRadius:'10px',color:'#fff',fontSize:'1.3rem',textAlign:'center',marginBottom:'1.5rem'}} 
                        />
                        <button onClick={() => {
                            const t = tables.find(x => x.id === parseInt(mesa));
                            if (!t) {alert('‚ùå Mesa inv√°lida'); return;}
                            if (t.status === 'livre') {
                                setAsk(true);
                            } else {
                                // Mesa ocupada - mostrar mensagem amig√°vel antes de pedir senha
                                if (confirm('‚ö†Ô∏è MESA OCUPADA\n\nEsta mesa j√° est√° em uso.\n\nüì± Se esta √© SUA mesa, clique em OK para inserir sua senha.\n\n‚ùå Se n√£o √© sua mesa, clique em CANCELAR.')) {
                                    const senha = prompt('üîê Digite a senha de 4 d√≠gitos da sua mesa:');
                                    if (!senha) return;
                                    
                                    if (t.customerPin && senha === t.customerPin) {
                                        // Senha correta
                                        sessionStorage.setItem('tableId', mesa);
                                        sessionStorage.setItem('customerPin', senha);
                                        setUser({tableId: parseInt(mesa)});
                                        setView('customer');
                                    } else {
                                        alert('‚ùå Senha incorreta!\n\nEsta mesa pertence a outro cliente.\nSolicite ajuda ao gar√ßom.');
                                    }
                                }
                            }
                        }} style={{width:'100%',padding:'1.3rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1.1rem'}}>ACESSAR</button>
                    </div>
                )}
                
                {ask && (
                    <div>
                        <div style={{textAlign:'center',marginBottom:'2rem',padding:'1.5rem',background:'rgba(74,157,78,0.1)',borderRadius:'10px'}}>
                            <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>üéâ</div>
                            <h3 style={{color:'#4a9d4e',fontSize:'1.5rem'}}>Mesa {mesa} Livre!</h3>
                        </div>
                        <input 
                            type="text" 
                            value={nome} 
                            onChange={e => setNome(e.target.value)} 
                            onKeyPress={e => {
                                if (e.key === 'Enter') {
                                    document.querySelector('input[type="password"]').focus();
                                }
                            }}
                            placeholder="Seu Nome" 
                            style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #444',borderRadius:'10px',color:'#fff',fontSize:'1.1rem',textAlign:'center',marginBottom:'1rem'}} 
                        />
                        <input 
                            type="password" 
                            value={pin} 
                            onChange={e => setPin(e.target.value)} 
                            onKeyPress={e => {
                                if (e.key === 'Enter') {
                                    if (!nome.trim()) return alert('Digite seu nome!');
                                    if (!pin || pin.length !== 4) return alert('Crie uma senha de 4 d√≠gitos!');
                                    
                                    const updateData = {
                                        status:'ocupada',
                                        customerName:nome,
                                        customerPin:pin,
                                        openedAt:Date.now()
                                    };
                                    
                                    db.ref(`tables/${mesa}`).update(updateData);
                                    sessionStorage.setItem('tableId', mesa);
                                    sessionStorage.setItem('customerPin', pin);
                                    setUser({tableId: parseInt(mesa)});
                                    setView('customer');
                                }
                            }}
                            placeholder="Senha (4 d√≠gitos)" 
                            maxLength="4" 
                            style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #444',borderRadius:'10px',color:'#fff',fontSize:'1.1rem',textAlign:'center',marginBottom:'1.5rem'}} 
                        />
                        <p style={{color:'#888',fontSize:'0.85rem',textAlign:'center',marginBottom:'1.5rem'}}>üí° Crie uma senha para acessar sua mesa novamente caso saia do app</p>
                        
                        <div style={{display:'flex',gap:'1rem'}}>
                            <button onClick={() => {setAsk(false);}} style={{flex:1,padding:'1.2rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>VOLTAR</button>
                            <button onClick={() => {
                                if (!nome.trim()) return alert('Digite seu nome!');
                                if (!pin || pin.length !== 4) return alert('Crie uma senha de 4 d√≠gitos!');
                                
                                const updateData = {
                                    status:'ocupada',
                                    customerName:nome,
                                    customerPin:pin,
                                    openedAt:Date.now()
                                };
                                
                                db.ref(`tables/${mesa}`).update(updateData);
                                sessionStorage.setItem('tableId', mesa);
                                sessionStorage.setItem('customerPin', pin);
                                setUser({tableId: parseInt(mesa)});
                                setView('customer');
                            }} style={{flex:2,padding:'1.2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>ABRIR MESA</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}


function Master({config, products, waiters, tables, sales, setView}) {
    const [tab, setTab] = useState('config');
    const [modal, setModal] = useState(null);
    const [edit, setEdit] = useState(null);
    
    return (
        <div style={{minHeight:'100vh',background:'#0a0a0a'}}>
            <header style={{background:'#1a1a1a',padding:'1.5rem',borderBottom:'2px solid #333',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    {config.logo && <img src={config.logo} alt={config.barName} style={{maxWidth:'150px',height:'100px'}} />}
                    <h1 style={{color:'#d4a574',fontSize:'1.8rem',fontWeight:'900'}}>üëë MASTER</h1>
                </div>
                <button onClick={() => setView('login')} style={{padding:'0.8rem 1.5rem',background:'#d4a574',border:'none',borderRadius:'10px',color:'#000',fontWeight:'800',cursor:'pointer'}}>SAIR</button>
            </header>
            
            <nav style={{background:'#0f0f0f',borderBottom:'2px solid #222',display:'flex'}}>
                <button onClick={() => setTab('config')} style={{padding:'1.2rem 2rem',background:tab==='config'?'#1a1a1a':'transparent',border:'none',color:tab==='config'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer'}}>‚öôÔ∏è CONFIG</button>
                <button onClick={() => setTab('products')} style={{padding:'1.2rem 2rem',background:tab==='products'?'#1a1a1a':'transparent',border:'none',color:tab==='products'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer'}}>üì¶ PRODUTOS</button>
                <button onClick={() => setTab('waiters')} style={{padding:'1.2rem 2rem',background:tab==='waiters'?'#1a1a1a':'transparent',border:'none',color:tab==='waiters'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer'}}>üë®‚Äçüç≥ GAR√áONS</button>
                <button onClick={() => setTab('relatorios')} style={{padding:'1.2rem 2rem',background:tab==='relatorios'?'#1a1a1a':'transparent',border:'none',color:tab==='relatorios'?'#d4a574':'#888',fontWeight:'800',cursor:'pointer'}}>üìä RELAT√ìRIOS</button>
            </nav>
            
            <main style={{padding:'2rem',maxWidth:'1200px',margin:'0 auto'}}>
                {tab === 'config' && <ConfigTab config={config} />}
                {tab === 'products' && <ProductsTab products={products} config={config} onAdd={() => setModal('product')} onEdit={(p) => {setEdit(p); setModal('product');}} />}
                {tab === 'waiters' && <WaitersTab waiters={waiters} onAdd={() => setModal('waiter')} onEdit={(w) => {setEdit(w); setModal('waiter');}} />}
                {tab === 'relatorios' && (
                    <div>
                        <h2 style={{color:'#d4a574',fontSize:'2rem',marginBottom:'2rem',fontWeight:'900'}}>üìä Relat√≥rios Gerenciais</h2>
                        
                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(250px,1fr))',gap:'1.5rem',marginBottom:'3rem'}}>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #d4a574',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üí∞</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Faturamento Atual</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#d4a574'}}>
                                    {config.currency} {tables.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #4a9d4e',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üìà</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Total Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#4a9d4e'}}>
                                    {config.currency} {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).reduce((sum, s) => sum + s.total, 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #3498db',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üèÜ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Total Geral</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#3498db'}}>
                                    {config.currency} {(sales || []).reduce((sum, s) => sum + s.total, 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #e67e22',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üßæ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Vendas Totais</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#e67e22'}}>
                                    {(sales || []).length}
                                </div>
                            </div>
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#d4a574',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üë®‚Äçüç≥ Performance dos Gar√ßons</h3>
                            {waiters.filter(w => w.active).map(waiter => {
                                const waiterSales = (sales || []).filter(s => s.waiter === waiter.id);
                                const total = waiterSales.reduce((s, sale) => s + sale.total, 0);
                                const today = waiterSales.filter(s => {
                                    const saleDate = new Date(s.date);
                                    const todayDate = new Date();
                                    return saleDate.toDateString() === todayDate.toDateString();
                                });
                                return (
                                    <div key={waiter.id} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                        <div>
                                            <div style={{fontWeight:'800',fontSize:'1.3rem',marginBottom:'0.3rem'}}>{waiter.name}</div>
                                            <div style={{color:'#888'}}>
                                                {waiterSales.length} vendas total ‚Ä¢ {today.length} hoje
                                            </div>
                                        </div>
                                        <div style={{fontSize:'2rem',fontWeight:'900',color:'#d4a574'}}>
                                            {config.currency} {total.toFixed(2)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#d4a574',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üèÜ Top 10 Produtos</h3>
                            {(() => {
                                const productStats = {};
                                (sales || []).forEach(sale => {
                                    sale.orders.forEach(order => {
                                        if (!productStats[order.id]) {
                                            productStats[order.id] = {
                                                name: order.name,
                                                image: order.image,
                                                quantity: 0,
                                                revenue: 0
                                            };
                                        }
                                        productStats[order.id].quantity += order.quantity;
                                        productStats[order.id].revenue += order.price * order.quantity;
                                    });
                                });
                                
                                return Object.values(productStats)
                                    .sort((a, b) => b.revenue - a.revenue)
                                    .slice(0, 10)
                                    .map((product, i) => (
                                        <div key={i} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                            <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                                                <div style={{background:'#d4a574',color:'#000',width:'35px',height:'35px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'900'}}>{i+1}</div>
                                                <div style={{fontSize:'2.5rem'}}>{product.image}</div>
                                                <div>
                                                    <div style={{fontWeight:'800',fontSize:'1.2rem'}}>{product.name}</div>
                                                    <div style={{color:'#888'}}>{product.quantity} vendidos</div>
                                                </div>
                                            </div>
                                            <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#d4a574'}}>
                                                {config.currency} {product.revenue.toFixed(2)}
                                            </div>
                                        </div>
                                    ));
                            })()}
                        </div>
                    </div>
                )}
            </main>
            
            {modal === 'product' && <ProductModal edit={edit} config={config} onClose={() => {setModal(null); setEdit(null);}} />}
            {modal === 'waiter' && <WaiterModal edit={edit} onClose={() => {setModal(null); setEdit(null);}} />}
        </div>
    );
}

function ConfigTab({config}) {
    const [d, setD] = useState(config);
    const save = () => {db.ref('config').set(d); alert('‚úÖ Salvo!');};
    
    const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('‚ùå Por favor, selecione uma imagem!');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                // Criar canvas para redimensionar
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Dimens√µes fixas 300x200
                canvas.width = 300;
                canvas.height = 200;
                
                // Desenhar imagem redimensionada
                ctx.drawImage(img, 0, 0, 300, 200);
                
                // Converter para base64
                const base64 = canvas.toDataURL('image/png');
                setD({...d, logo: base64});
                alert('‚úÖ Logo carregada! Clique em SALVAR para confirmar.');
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    
    const removeLogo = () => {
        if (confirm('Remover logo?')) {
            setD({...d, logo: null});
        }
    };
    
    return (
        <div style={{maxWidth:'600px'}}>
            <h2 style={{color:'#d4a574',fontSize:'2rem',marginBottom:'2rem'}}>Configura√ß√µes</h2>
            <div style={{display:'grid',gap:'1.5rem'}}>
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>Nome do Bar</label>
                    <input value={d.barName} onChange={e => setD({...d, barName: e.target.value})} style={{width:'100%',padding:'1rem',background:'#1a1a1a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                </div>
                
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>Logo do Bar (300x200px)</label>
                    {d.logo ? (
                        <div style={{background:'#1a1a1a',border:'2px solid #333',borderRadius:'10px',padding:'1.5rem',textAlign:'center'}}>
                            <img src={d.logo} alt="Logo" style={{maxWidth:'300px',height:'200px',marginBottom:'1rem'}} />
                            <div style={{display:'flex',gap:'1rem'}}>
                                <label style={{flex:1,padding:'1rem',background:'#3498db',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',textAlign:'center'}}>
                                    üì§ TROCAR LOGO
                                    <input type="file" accept="image/*" onChange={handleLogoUpload} style={{display:'none'}} />
                                </label>
                                <button onClick={removeLogo} style={{flex:1,padding:'1rem',background:'#e74c3c',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>
                                    üóëÔ∏è REMOVER
                                </button>
                            </div>
                        </div>
                    ) : (
                        <label style={{display:'block',padding:'3rem',background:'#1a1a1a',border:'2px dashed #333',borderRadius:'10px',textAlign:'center',cursor:'pointer',transition:'all 0.3s'}}
                            onMouseEnter={e => e.currentTarget.style.borderColor = '#d4a574'}
                            onMouseLeave={e => e.currentTarget.style.borderColor = '#333'}
                        >
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üì∑</div>
                            <div style={{color:'#d4a574',fontWeight:'800',fontSize:'1.1rem',marginBottom:'0.5rem'}}>Clique para adicionar logo</div>
                            <div style={{color:'#888',fontSize:'0.85rem'}}>Recomendado: 300x200 pixels</div>
                            <input type="file" accept="image/*" onChange={handleLogoUpload} style={{display:'none'}} />
                        </label>
                    )}
                </div>
                
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>N√∫mero de Mesas (1-50)</label>
                    <input type="number" min="1" max="50" value={d.tables} onChange={e => setD({...d, tables: parseInt(e.target.value) || 1})} style={{width:'100%',padding:'1rem',background:'#1a1a1a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <p style={{color:'#888',fontSize:'0.85rem',marginTop:'0.5rem'}}>‚ö†Ô∏è Recarregue ap√≥s salvar</p>
                </div>
                <div>
                    <label style={{display:'block',color:'#888',marginBottom:'0.5rem',fontWeight:'700'}}>PIN Master</label>
                    <PasswordInput value={d.masterPin} onChange={e => setD({...d, masterPin: e.target.value})} maxLength={4} style={{width:'100%',padding:'1rem',background:'#1a1a1a',border:'1px solid #333',borderRadius:'10px',color:'#fff',fontSize:'1.5rem',textAlign:'center'}} />
                </div>
                <button onClick={save} style={{padding:'1.2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1.1rem'}}>üíæ SALVAR</button>
                
                {/* BOT√ÉO LIMPAR DADOS */}
                <div style={{marginTop:'2rem',padding:'1.5rem',background:'#2a1a1a',border:'2px solid #e74c3c',borderRadius:'12px'}}>
                    <h3 style={{color:'#e74c3c',fontSize:'1.3rem',marginBottom:'0.5rem'}}>‚ö†Ô∏è Zona de Perigo</h3>
                    <p style={{color:'#888',fontSize:'0.9rem',marginBottom:'1rem'}}>Use esta fun√ß√£o para limpar TODAS as vendas e resetar as mesas. Ideal para come√ßar o sistema do zero.</p>
                    <button 
                        onClick={() => {
                            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO! Isso vai APAGAR:\n\n‚Ä¢ Todas as vendas\n‚Ä¢ Todos os pedidos\n‚Ä¢ Todas as mesas ocupadas\n\nDeseja continuar?')) return;
                            
                            if (!confirm('üö® √öLTIMA CONFIRMA√á√ÉO!\n\nTem CERTEZA que deseja limpar TODOS os dados de vendas?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!')) return;
                            
                            // Limpar vendas
                            db.ref('sales').remove();
                            
                            // Resetar todas as mesas
                            const resetTables = {};
                            for (let i = 1; i <= config.tables; i++) {
                                resetTables[i] = {
                                    id: i,
                                    status: 'livre',
                                    waiter: null,
                                    orders: [],
                                    pending: [],
                                    total: 0,
                                    subtotal: 0,
                                    tip: 0,
                                    callWaiter: false
                                };
                            }
                            db.ref('tables').set(resetTables);
                            
                            alert('‚úÖ Dados limpos com sucesso!\n\n‚Ä¢ Vendas apagadas\n‚Ä¢ Mesas resetadas\n\nSistema pronto para come√ßar!');
                        }}
                        style={{
                            width:'100%',
                            padding:'1.2rem',
                            background:'#e74c3c',
                            border:'none',
                            borderRadius:'10px',
                            color:'#fff',
                            fontWeight:'800',
                            cursor:'pointer',
                            fontSize:'1.1rem'
                        }}
                    >
                        üóëÔ∏è LIMPAR TODAS AS VENDAS E RESETAR MESAS
                    </button>
                </div>
            </div>
        </div>
    );
}

function ProductsTab({products, config, onAdd, onEdit}) {
    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
                <h2 style={{color:'#d4a574',fontSize:'2rem'}}>Produtos</h2>
                <button onClick={onAdd} style={{padding:'1rem 2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>+ NOVO</button>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'1.5rem'}}>
                {products.map(p => (
                    <div key={p.id} onClick={() => onEdit(p)} style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',cursor:'pointer',textAlign:'center'}}>
                        <div style={{fontSize:'3rem',marginBottom:'0.8rem'}}>{p.image}</div>
                        <div style={{fontWeight:'800',marginBottom:'0.5rem'}}>{p.name}</div>
                        <div style={{color:'#d4a574',fontSize:'1.2rem',fontWeight:'900'}}>{config.currency} {p.price.toFixed(2)}</div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function WaitersTab({waiters, onAdd, onEdit}) {
    return (
        <div>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
                <h2 style={{color:'#d4a574',fontSize:'2rem'}}>Gar√ßons</h2>
                <button onClick={onAdd} style={{padding:'1rem 2rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>+ NOVO</button>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(250px,1fr))',gap:'1.5rem'}}>
                {waiters.map(w => (
                    <div key={w.id} onClick={() => onEdit(w)} style={{background:'#1a1a1a',padding:'2rem',borderRadius:'12px',border:'2px solid #333',cursor:'pointer',textAlign:'center'}}>
                        <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üë®‚Äçüç≥</div>
                        <div style={{fontWeight:'800',fontSize:'1.2rem',marginBottom:'0.5rem'}}>{w.name}</div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function ProductModal({edit, config, onClose}) {
    const [d, setD] = useState(edit || {id: Date.now(), name: '', price: 0, image: 'üç∫', category: 'Bebidas', active: true});
    const [showEmojiPicker, setShowEmojiPicker] = useState(false);
    
    const emojis = {
        'Bebidas': ['üç∫', 'üçª', 'üç∑', 'üç∏', 'üçπ', 'üçæ', 'ü•Ç', 'üßÉ', 'üßã', 'ü•§', '‚òï', 'üçµ', 'üßâ', 'ü•õ'],
        'Comidas': ['üçó', 'üçñ', 'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ', 'ü•ó', 'üçù', 'üçú', 'üç≤', 'üç±', 'üçõ', 'üçô', 'üçö', 'ü•ü', 'ü¶ê', 'üç§', 'ü¶ë', 'üêô']
    };
    
    const save = () => {db.ref(`products/${d.id}`).set(d); alert('‚úÖ Salvo!'); onClose();};
    const del = () => {if (confirm('Deletar?')) {db.ref(`products/${d.id}`).remove(); onClose();}};
    
    return (
        <div onClick={onClose} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'1rem',overflowY:'auto'}}>
            <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'600px',width:'100%',border:'2px solid #d4a574',maxHeight:'90vh',overflowY:'auto'}}>
                <h3 style={{color:'#d4a574',fontSize:'1.8rem',marginBottom:'2rem'}}>{edit ? 'Editar' : 'Novo'} Produto</h3>
                <div style={{display:'grid',gap:'1rem'}}>
                    <input placeholder="Nome" value={d.name} onChange={e => setD({...d, name: e.target.value})} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <input type="number" placeholder="Pre√ßo" value={d.price || ''} onChange={e => setD({...d, price: parseFloat(e.target.value) || 0})} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <select value={d.category} onChange={e => setD({...d, category: e.target.value})} style={{padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}}>
                        <option>Bebidas</option>
                        <option>Comidas</option>
                    </select>
                    
                    <div>
                        <label style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.5rem',display:'block'}}>Emoji do Produto:</label>
                        <div style={{display:'flex',gap:'1rem',alignItems:'center'}}>
                            <div style={{
                                background:'#0a0a0a',
                                border:'2px solid #d4a574',
                                borderRadius:'10px',
                                padding:'1rem',
                                fontSize:'3rem',
                                textAlign:'center',
                                width:'80px',
                                height:'80px',
                                display:'flex',
                                alignItems:'center',
                                justifyContent:'center'
                            }}>
                                {d.image}
                            </div>
                            <button 
                                onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                style={{
                                    flex:1,
                                    padding:'1rem',
                                    background:'#d4a574',
                                    border:'none',
                                    borderRadius:'10px',
                                    color:'#000',
                                    fontWeight:'800',
                                    cursor:'pointer'
                                }}
                            >
                                {showEmojiPicker ? '‚ñ≤ FECHAR' : '‚ñº ESCOLHER EMOJI'}
                            </button>
                        </div>
                        
                        {showEmojiPicker && (
                            <div style={{
                                marginTop:'1rem',
                                padding:'1.5rem',
                                background:'#0a0a0a',
                                borderRadius:'10px',
                                border:'1px solid #333'
                            }}>
                                <h4 style={{color:'#d4a574',marginBottom:'1rem'}}>
                                    {d.category === 'Bebidas' ? 'üç∫ Bebidas' : 'üçó Comidas'}
                                </h4>
                                <div style={{
                                    display:'grid',
                                    gridTemplateColumns:'repeat(auto-fill,minmax(50px,1fr))',
                                    gap:'0.5rem',
                                    maxHeight:'200px',
                                    overflowY:'auto'
                                }}>
                                    {emojis[d.category].map((emoji, i) => (
                                        <button
                                            key={i}
                                            onClick={() => {
                                                setD({...d, image: emoji});
                                                setShowEmojiPicker(false);
                                            }}
                                            style={{
                                                padding:'0.8rem',
                                                background: d.image === emoji ? '#d4a574' : '#1a1a1a',
                                                border:'2px solid #333',
                                                borderRadius:'8px',
                                                fontSize:'2rem',
                                                cursor:'pointer',
                                                transition:'all 0.2s'
                                            }}
                                            onMouseEnter={e => e.currentTarget.style.transform = 'scale(1.1)'}
                                            onMouseLeave={e => e.currentTarget.style.transform = 'scale(1)'}
                                        >
                                            {emoji}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
                <div style={{display:'flex',gap:'1rem',marginTop:'2rem'}}>
                    {edit && <button onClick={del} style={{padding:'1rem',background:'#e74c3c',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>DELETAR</button>}
                    <button onClick={onClose} style={{flex:1,padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                    <button onClick={save} style={{flex:1,padding:'1rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SALVAR</button>
                </div>
            </div>
        </div>
    );
}

function WaiterModal({edit, onClose}) {
    const [d, setD] = useState(edit || {id: Date.now(), name: '', pin: '', active: true, sales: 0});
    const save = () => {db.ref(`waiters/${d.id}`).set(d); alert('‚úÖ Salvo!'); onClose();};
    const del = () => {if (confirm('Deletar?')) {db.ref(`waiters/${d.id}`).remove(); onClose();}};
    
    return (
        <div onClick={onClose} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999}}>
            <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'450px',width:'100%',border:'2px solid #d4a574'}}>
                <h3 style={{color:'#d4a574',fontSize:'1.8rem',marginBottom:'2rem'}}>{edit ? 'Editar' : 'Novo'} Gar√ßom</h3>
                <div style={{display:'grid',gap:'1rem'}}>
                    <input placeholder="Nome" value={d.name} onChange={e => setD({...d, name: e.target.value})} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff'}} />
                    <PasswordInput placeholder="PIN" value={d.pin} onChange={e => setD({...d, pin: e.target.value})} maxLength={4} style={{width:'100%',padding:'1rem',background:'#0a0a0a',border:'1px solid #333',borderRadius:'10px',color:'#fff',fontSize:'1.5rem',textAlign:'center'}} />
                </div>
                <div style={{display:'flex',gap:'1rem',marginTop:'2rem'}}>
                    {edit && <button onClick={del} style={{padding:'1rem',background:'#e74c3c',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>DELETAR</button>}
                    <button onClick={onClose} style={{flex:1,padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                    <button onClick={save} style={{flex:1,padding:'1rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SALVAR</button>
                </div>
            </div>
        </div>
    );
}


function Admin({tables, waiters, products, config, sales, setView}) {
    const [tab, setTab] = useState('mesas');
    const [selW, setSelW] = useState(null);
    const [qrModal, setQrModal] = useState(null);
    
    const openTable = (id, wId) => {db.ref(`tables/${id}`).update({status: 'ocupada', waiter: wId}); alert('Mesa aberta!');};
    const closeTable = (id) => {
        const table = tables.find(t => t.id === id);
        if (!table) {
            alert('‚ùå Mesa n√£o encontrada!');
            return;
        }
        
        // Verificar se h√° pedidos pendentes
        if (table.pending && table.pending.length > 0) {
            alert('‚ùå N√£o √© poss√≠vel fechar a conta! Ainda h√° pedidos pendentes. Confirme ou cancele os pedidos primeiro.');
            return;
        }
        
        // CORRE√á√ÉO: Garantir valores num√©ricos seguros
        const subtotal = parseFloat(table.subtotal) || 0;
        let tip = parseFloat(table.tip) || 0;
        const total = parseFloat(table.total) || 0;
        
        // PERGUNTAR SOBRE GORJETA SE AINDA N√ÉO FOI ADICIONADA
        if (!tip || tip === 0) {
            const wantTip = confirm('üíù Deseja adicionar gorjeta antes de fechar a conta?');
            
            if (wantTip) {
                const tipOptions = [
                    `10% (${config.currency} ${(total * 0.10).toFixed(2)})`,
                    `15% (${config.currency} ${(total * 0.15).toFixed(2)})`,
                    `20% (${config.currency} ${(total * 0.20).toFixed(2)})`,
                    'Valor Personalizado'
                ];
                
                const choice = prompt(
                    `Escolha a gorjeta:\n\n1 - ${tipOptions[0]}\n2 - ${tipOptions[1]}\n3 - ${tipOptions[2]}\n4 - ${tipOptions[3]}\n\nDigite o n√∫mero da op√ß√£o:`
                );
                
                if (choice === '1') {
                    tip = total * 0.10;
                } else if (choice === '2') {
                    tip = total * 0.15;
                } else if (choice === '3') {
                    tip = total * 0.20;
                } else if (choice === '4') {
                    const customTip = parseFloat(prompt('Digite o valor da gorjeta:'));
                    if (customTip && customTip > 0) {
                        tip = customTip;
                    }
                }
                
                // Salvar gorjeta se foi adicionada
                if (tip > 0) {
                    db.ref(`tables/${id}/tip`).set(tip);
                }
            }
        }
        
        const totalWithTip = total + tip;
        
        // Confirmar fechamento
        let confirmMsg = `Fechar conta da Mesa ${id}?\n\nSubtotal: ${config.currency} ${subtotal.toFixed(2)}`;
        if (tip > 0) {
            confirmMsg += `\nGorjeta: ${config.currency} ${tip.toFixed(2)}`;
        }
        confirmMsg += `\n\nTOTAL: ${config.currency} ${totalWithTip.toFixed(2)}`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        if (totalWithTip > 0) {
            // Salvar venda no hist√≥rico
            const sale = {
                id: Date.now(),
                tableId: id,
                waiter: table.waiter || null,
                waiterName: table.waiter ? waiters.find(w => w.id === table.waiter)?.name || 'Sem gar√ßom' : 'Cliente direto',
                customerName: table.customerName || 'Cliente',
                subtotal: subtotal,
                tip: tip,
                total: totalWithTip,
                orders: table.orders || [],
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            db.ref(`sales/${sale.id}`).set(sale).catch(error => {
                console.error('Erro ao salvar venda:', error);
                alert('‚ö†Ô∏è Aviso: Erro ao salvar no hist√≥rico, mas a mesa ser√° fechada.');
            });
        }
        
        // Resetar mesa
        db.ref(`tables/${id}`).set({
            id: id,
            status: 'livre',
            waiter: null,
            customerName: null,
            customerPin: null,
            total: 0,
            subtotal: 0,
            tip: 0,
            orders: [],
            pending: [],
            callWaiter: false
        }).then(() => {
            alert('‚úÖ Mesa fechada com sucesso!');
        }).catch(error => {
            console.error('Erro ao fechar mesa:', error);
            alert('‚ùå Erro ao fechar mesa! Verifique a conex√£o e tente novamente.');
        });
    };
    
    const showQRCode = (tableId) => {
        setQrModal(tableId);
        
        // Gerar QR Code ap√≥s modal abrir
        setTimeout(() => {
            const canvas = document.getElementById(`qr-canvas-${tableId}`);
            if (!canvas) {
                console.error('Canvas n√£o encontrado');
                return;
            }
            
            const url = `${window.location.href.split('?')[0]}?mesa=${tableId}`;
            
            if (window.QRCode) {
                window.QRCode.toCanvas(canvas, url, {
                    width: 300,
                    margin: 2,
                    color: {dark: '#000000', light: '#ffffff'}
                }, (error) => {
                    if (error) {
                        console.error('Erro ao gerar QR Code:', error);
                        alert('‚ùå Erro ao gerar QR Code!');
                    } else {
                        console.log('‚úÖ QR Code gerado com sucesso!');
                    }
                });
            } else {
                console.error('Biblioteca QRCode n√£o carregada');
                alert('‚ùå Erro: Biblioteca QRCode n√£o carregada!');
            }
        }, 200);
    };
    
    const confirmOrder = (id, idx) => {
        const t = tables.find(x => x.id === id);
        const o = t.pending[idx];
        const newO = [...t.orders, o];
        const newP = t.pending.filter((_, i) => i !== idx);
        const newS = t.subtotal + (o.price * o.quantity);
        const newT = newS + (newS * config.serviceCharge / 100);
        db.ref(`tables/${id}`).update({orders: newO, pending: newP, subtotal: newS, total: newT});
        alert('Confirmado!');
    };
    
    return (
        <div style={{minHeight:'100vh',background:'#0a0a0a'}}>
            <header style={{background:'#1a1a1a',padding:'1.5rem',borderBottom:'2px solid #333',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{display:'flex',alignItems:'center',gap:'1rem'}}>
                    {config.logo && <img src={config.logo} alt={config.barName} style={{maxWidth:'150px',height:'100px'}} />}
                    <h1 style={{color:'#4a9d4e',fontSize:'1.8rem',fontWeight:'900'}}>üë®‚Äçüíº ADMIN</h1>
                </div>
                <button onClick={() => setView('login')} style={{padding:'0.8rem 1.5rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SAIR</button>
            </header>
            
            <nav style={{background:'#0f0f0f',borderBottom:'2px solid #222',display:'flex'}}>
                <button onClick={() => setTab('mesas')} style={{padding:'1.2rem 2rem',background:tab==='mesas'?'#1a1a1a':'transparent',border:'none',color:tab==='mesas'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer'}}>üìã MESAS</button>
                <button onClick={() => setTab('pedidos')} style={{padding:'1.2rem 2rem',background:tab==='pedidos'?'#1a1a1a':'transparent',border:'none',color:tab==='pedidos'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer'}}>üîî PEDIDOS</button>
                <button onClick={() => setTab('chamadas')} style={{padding:'1.2rem 2rem',background:tab==='chamadas'?'#1a1a1a':'transparent',border:'none',color:tab==='chamadas'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer',position:'relative'}}>
                    üìû CHAMADAS
                    {tables.filter(t => t.callWaiter).length > 0 && (
                        <span style={{position:'absolute',top:'0.5rem',right:'0.5rem',background:'#e74c3c',color:'#fff',fontSize:'0.7rem',fontWeight:'900',padding:'0.2rem 0.5rem',borderRadius:'50%',minWidth:'1.2rem',height:'1.2rem',display:'flex',alignItems:'center',justifyContent:'center'}}>
                            {tables.filter(t => t.callWaiter).length}
                        </span>
                    )}
                </button>
                <button onClick={() => setTab('relatorios')} style={{padding:'1.2rem 2rem',background:tab==='relatorios'?'#1a1a1a':'transparent',border:'none',color:tab==='relatorios'?'#4a9d4e':'#888',fontWeight:'800',cursor:'pointer'}}>üìä RELAT√ìRIOS</button>
            </nav>
            
            <main style={{padding:'2rem',maxWidth:'1400px',margin:'0 auto'}}>
                {tab === 'mesas' && (
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'1.5rem'}}>
                        {tables.map(t => (
                            <div key={t.id} style={{
                                background:'#1a1a1a',
                                padding:'1.5rem',
                                borderRadius:'12px',
                                border:`3px solid ${t.callWaiter ? '#e74c3c' : t.status==='livre'?'#4a9d4e':'#d4a017'}`,
                                position:'relative',
                                animation: t.callWaiter ? 'blink 1.5s infinite' : 'none'
                            }}>
                                {t.callWaiter && (
                                    <div style={{position:'absolute',top:'-10px',right:'-10px',background:'#e74c3c',color:'#fff',fontSize:'1.5rem',width:'40px',height:'40px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',animation:'pulse 1s infinite',boxShadow:'0 0 20px rgba(231,76,60,0.8)'}}>
                                        üîî
                                    </div>
                                )}
                                <div style={{fontSize:'1.5rem',fontWeight:'800',marginBottom:'0.5rem'}}>Mesa {t.id}</div>
                                <div style={{fontSize:'0.85rem',padding:'0.3rem 0.8rem',borderRadius:'20px',display:'inline-block',background:t.status==='livre'?'#4a9d4e':'#d4a017',color:'#fff',fontWeight:'800',marginBottom:'0.5rem'}}>
                                    {t.status.toUpperCase()}
                                </div>
                                {t.status === 'ocupada' ? (
                                    <>
                                        <div style={{color:'#ccc',fontSize:'0.9rem',marginTop:'0.5rem'}}>
                                            {t.waiter ? waiters.find(w => w.id === t.waiter)?.name : t.customerName}
                                        </div>
                                        <div style={{fontSize:'1.3rem',fontWeight:'800',color:'#d4a574',marginTop:'0.5rem'}}>{config.currency} {t.total.toFixed(2)}</div>
                                        {t.tip && t.tip > 0 && (
                                            <div style={{fontSize:'0.85rem',color:'#f39c12',marginTop:'0.3rem',fontWeight:'800'}}>
                                                üíù Gorjeta: {config.currency} {t.tip.toFixed(2)}
                                            </div>
                                        )}
                                        {t.callWaiter && (
                                            <button 
                                                onClick={() => db.ref(`tables/${t.id}/callWaiter`).set(false)}
                                                style={{width:'100%',padding:'0.6rem',background:'#e74c3c',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem',marginTop:'0.5rem'}}
                                            >
                                                ‚úì ATENDER CHAMADA
                                            </button>
                                        )}
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem',marginTop:'1rem'}}>
                                            <button onClick={() => showQRCode(t.id)} style={{padding:'0.6rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>üì± QR</button>
                                            <button onClick={() => closeTable(t.id)} style={{padding:'0.6rem',background:'#e67e22',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>FECHAR</button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <button onClick={() => setSelW(t.id)} style={{width:'100%',marginTop:'1rem',padding:'0.8rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>ABRIR</button>
                                        <button onClick={() => showQRCode(t.id)} style={{width:'100%',marginTop:'0.5rem',padding:'0.6rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}>üì± VER QR CODE</button>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                )}
                
                {tab === 'pedidos' && (
                    <div>
                        {tables.filter(t => t.pending && t.pending.length > 0).length === 0 ? (
                            <div style={{textAlign:'center',padding:'4rem',color:'#888'}}>
                                <div style={{fontSize:'4rem',marginBottom:'1rem'}}>‚úì</div>
                                <p style={{fontSize:'1.2rem'}}>Nenhum pedido pendente no momento</p>
                            </div>
                        ) : (
                            tables.filter(t => t.pending && t.pending.length > 0).map(t => (
                                <div key={t.id} style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1.5rem'}}>
                                    <h3 style={{color:'#d4a574',marginBottom:'1rem'}}>Mesa {t.id}</h3>
                                    {t.pending.map((o, i) => (
                                        <div key={i} style={{background:'#0a0a0a',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}>
                                            <div style={{display:'flex',gap:'1rem',marginBottom:'1rem'}}>
                                                <span style={{fontSize:'2rem'}}>{o.image}</span>
                                                <div style={{flex:1}}>
                                                    <div style={{fontWeight:'800'}}>{o.name}</div>
                                                    <div style={{color:'#888'}}>Qtd: {o.quantity} ‚Ä¢ {config.currency} {(o.price * o.quantity).toFixed(2)}</div>
                                                </div>
                                            </div>
                                            <button onClick={() => confirmOrder(t.id, i)} style={{width:'100%',padding:'0.8rem',background:'#4a9d4e',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>‚úì CONFIRMAR</button>
                                        </div>
                                    ))}
                                </div>
                            ))
                        )}
                    </div>
                )}
                
                {tab === 'chamadas' && (
                    <div>
                        <h2 style={{color:'#e74c3c',fontSize:'2rem',marginBottom:'2rem',fontWeight:'900'}}>üìû Chamadas de Gar√ßom</h2>
                        
                        {tables.filter(t => t.callWaiter).length === 0 ? (
                            <div style={{textAlign:'center',padding:'4rem',color:'#888'}}>
                                <div style={{fontSize:'4rem',marginBottom:'1rem'}}>‚úì</div>
                                <p style={{fontSize:'1.2rem'}}>Nenhuma chamada de gar√ßom no momento</p>
                            </div>
                        ) : (
                            <div style={{display:'grid',gap:'1.5rem'}}>
                                {tables.filter(t => t.callWaiter).map(t => (
                                    <div key={t.id} style={{
                                        background:'#1a1a1a',
                                        padding:'2rem',
                                        borderRadius:'16px',
                                        border:'3px solid #e74c3c',
                                        animation:'blink 1.5s infinite',
                                        display:'flex',
                                        alignItems:'center',
                                        gap:'2rem'
                                    }}>
                                        <div style={{fontSize:'4rem',animation:'pulse 1s infinite'}}>üîî</div>
                                        <div style={{flex:1}}>
                                            <h3 style={{fontSize:'2rem',fontWeight:'900',color:'#e74c3c',marginBottom:'0.5rem'}}>Mesa {t.id}</h3>
                                            <div style={{color:'#ccc',fontSize:'1.1rem',marginBottom:'0.3rem'}}>
                                                {t.waiter ? `Gar√ßom: ${waiters.find(w => w.id === t.waiter)?.name}` : `Cliente: ${t.customerName}`}
                                            </div>
                                            <div style={{color:'#888',fontSize:'0.9rem'}}>
                                                Conta atual: {config.currency} {t.total.toFixed(2)}
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => {
                                                db.ref(`tables/${t.id}/callWaiter`).set(false);
                                                playSound();
                                                alert('‚úÖ Chamada atendida!');
                                            }}
                                            style={{
                                                padding:'1.5rem 2.5rem',
                                                background:'#4a9d4e',
                                                border:'none',
                                                borderRadius:'12px',
                                                color:'#fff',
                                                fontWeight:'900',
                                                cursor:'pointer',
                                                fontSize:'1.2rem',
                                                whiteSpace:'nowrap'
                                            }}
                                        >
                                            ‚úì ATENDER
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
                
                {tab === 'relatorios' && (
                    <div>
                        <h2 style={{color:'#4a9d4e',fontSize:'2rem',marginBottom:'2rem',fontWeight:'900'}}>üìä Relat√≥rios</h2>
                        
                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(250px,1fr))',gap:'1.5rem',marginBottom:'3rem'}}>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #4a9d4e',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üí∞</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Faturamento Atual</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#4a9d4e'}}>
                                    {config.currency} {tables.reduce((sum, t) => sum + (t.total || 0), 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #d4a574',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üìà</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Total Vendido Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#d4a574'}}>
                                    {config.currency} {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).reduce((sum, s) => sum + s.total, 0).toFixed(2)}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #3498db',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üçΩÔ∏è</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Mesas Ativas</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#3498db'}}>
                                    {tables.filter(t => t.status === 'ocupada').length}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #e67e22',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üßæ</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Vendas Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#e67e22'}}>
                                    {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).length}
                                </div>
                            </div>
                            <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',border:'3px solid #f39c12',textAlign:'center'}}>
                                <div style={{fontSize:'3rem'}}>üíù</div>
                                <div style={{color:'#888',fontSize:'0.9rem'}}>Gorjetas Hoje</div>
                                <div style={{fontSize:'2.5rem',fontWeight:'900',color:'#f39c12'}}>
                                    {config.currency} {(sales || []).filter(s => {
                                        const saleDate = new Date(s.date);
                                        const today = new Date();
                                        return saleDate.toDateString() === today.toDateString();
                                    }).reduce((sum, s) => sum + (s.tip || 0), 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#4a9d4e',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üë®‚Äçüç≥ Vendas e Gorjetas por Gar√ßom (Hoje)</h3>
                            {waiters.filter(w => w.active).map(waiter => {
                                const todaySales = (sales || []).filter(s => {
                                    const saleDate = new Date(s.date);
                                    const today = new Date();
                                    return s.waiter === waiter.id && saleDate.toDateString() === today.toDateString();
                                });
                                const totalSales = todaySales.reduce((s, sale) => s + sale.total, 0);
                                const totalTips = todaySales.reduce((s, sale) => s + (sale.tip || 0), 0);
                                const salesWithTips = todaySales.filter(s => s.tip && s.tip > 0).length;
                                
                                return (
                                    <div key={waiter.id} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
                                            <div>
                                                <div style={{fontWeight:'800',fontSize:'1.2rem',marginBottom:'0.3rem'}}>{waiter.name}</div>
                                                <div style={{color:'#888',fontSize:'0.9rem'}}>{todaySales.length} vendas hoje</div>
                                            </div>
                                            <div style={{textAlign:'right'}}>
                                                <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#4a9d4e'}}>
                                                    {config.currency} {totalSales.toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                        {totalTips > 0 && (
                                            <div style={{borderTop:'1px solid #333',paddingTop:'1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                                <div style={{color:'#f39c12',fontSize:'0.95rem'}}>
                                                    üíù Gorjetas recebidas ({salesWithTips} {salesWithTips === 1 ? 'venda' : 'vendas'})
                                                </div>
                                                <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#f39c12'}}>
                                                    {config.currency} {totalTips.toFixed(2)}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div style={{background:'#1a1a1a',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                            <h3 style={{color:'#4a9d4e',fontSize:'1.5rem',marginBottom:'1.5rem'}}>üïê √öltimas 10 Vendas</h3>
                            {(sales || []).slice(0, 10).map((sale, i) => (
                                <div key={sale.id} style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'1rem'}}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.5rem'}}>
                                        <div>
                                            <span style={{fontWeight:'800'}}>Mesa {sale.tableId}</span>
                                            <span style={{color:'#888',marginLeft:'1rem'}}>
                                                {new Date(sale.date).toLocaleString('pt-BR')}
                                            </span>
                                        </div>
                                        <div style={{textAlign:'right'}}>
                                            <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#4a9d4e'}}>
                                                {config.currency} {sale.total.toFixed(2)}
                                            </div>
                                            {sale.tip && sale.tip > 0 && (
                                                <div style={{fontSize:'0.9rem',color:'#f39c12',marginTop:'0.2rem'}}>
                                                    üíù + {config.currency} {sale.tip.toFixed(2)}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div style={{color:'#888',fontSize:'0.9rem'}}>
                                        {sale.waiterName ? `Gar√ßom: ${sale.waiterName}` : `Cliente: ${sale.customerName}`} ‚Ä¢ {sale.orders.length} itens
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </main>
            
            {selW && (
                <div onClick={() => setSelW(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'400px',width:'100%',border:'2px solid #4a9d4e'}}>
                        <h2 style={{color:'#4a9d4e',marginBottom:'2rem',fontSize:'1.8rem'}}>Abrir Mesa {selW}</h2>
                        {waiters.filter(w => w.active).map(w => (
                            <button key={w.id} onClick={() => {openTable(selW, w.id); setSelW(null);}} style={{width:'100%',padding:'1.2rem',background:'#0a0a0a',border:'2px solid #333',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',marginBottom:'1rem'}}>üë®‚Äçüç≥ {w.name}</button>
                        ))}
                        <button onClick={() => setSelW(null)} style={{width:'100%',padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'12px',color:'#888',fontWeight:'800',cursor:'pointer',marginTop:'1rem'}}>CANCELAR</button>
                    </div>
                </div>
            )}
            
            {qrModal && (
                <div onClick={() => setQrModal(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000,padding:'1rem'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#fff',padding:'3rem',borderRadius:'20px',maxWidth:'500px',width:'100%',textAlign:'center'}}>
                        <h2 style={{color:'#000',marginBottom:'0.5rem',fontSize:'2rem',fontWeight:'900'}}>üçΩÔ∏è Mesa {qrModal}</h2>
                        <p style={{color:'#666',marginBottom:'2rem',fontSize:'0.95rem'}}>Escaneie o QR Code para acessar o card√°pio</p>
                        
                        <div style={{background:'#f5f5f5',padding:'2rem',borderRadius:'12px',marginBottom:'1.5rem',display:'flex',justifyContent:'center',alignItems:'center',minHeight:'340px'}}>
                            <canvas id={`qr-canvas-${qrModal}`}></canvas>
                        </div>
                        
                        <div style={{background:'#f0f0f0',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
                            <p style={{color:'#666',fontSize:'0.75rem',marginBottom:'0.3rem'}}>Link direto:</p>
                            <p style={{color:'#333',fontSize:'0.85rem',fontWeight:'600',wordBreak:'break-all',margin:0}}>
                                {window.location.href.split('?')[0]}?mesa={qrModal}
                            </p>
                        </div>
                        
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                            <button 
                                onClick={() => {
                                    const canvas = document.getElementById(`qr-canvas-${qrModal}`);
                                    if (canvas) {
                                        const link = document.createElement('a');
                                        link.download = `qrcode-mesa-${qrModal}.png`;
                                        link.href = canvas.toDataURL();
                                        link.click();
                                    }
                                }}
                                style={{padding:'1.2rem',background:'#3498db',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}
                            >
                                üíæ BAIXAR
                            </button>
                            <button onClick={() => setQrModal(null)} style={{padding:'1.2rem',background:'#4a9d4e',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}>‚úì FECHAR</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function Balcao({tables, config, waiters, setView}) {
    const [sel, setSel] = useState(null);
    const [selW, setSelW] = useState(null);
    const [qrModal, setQrModal] = useState(null);
    
    const openTable = (id, wId) => {
        db.ref(`tables/${id}`).update({status: 'ocupada', waiter: wId});
        alert('‚úÖ Mesa aberta!');
        setSelW(null);
    };
    
    const closeTable = (tableId) => {
        const t = tables.find(x => x.id === tableId);
        if (!t) {
            alert('‚ùå Mesa n√£o encontrada!');
            return;
        }
        
        // Verificar se h√° pedidos pendentes
        if (t.pending && t.pending.length > 0) {
            alert('‚ùå N√£o √© poss√≠vel fechar a conta! Ainda h√° ' + t.pending.length + ' pedido(s) pendente(s). Confirme ou cancele os pedidos primeiro.');
            return;
        }
        
        // CORRE√á√ÉO: Garantir valores num√©ricos seguros
        const subtotal = parseFloat(t.subtotal) || 0;
        let tip = parseFloat(t.tip) || 0;
        const total = parseFloat(t.total) || 0;
        
        // PERGUNTAR SOBRE GORJETA SE AINDA N√ÉO FOI ADICIONADA
        if (!tip || tip === 0) {
            const wantTip = confirm('üíù Deseja adicionar gorjeta antes de fechar a conta?');
            
            if (wantTip) {
                const tipOptions = [
                    `10% (${config.currency} ${(total * 0.10).toFixed(2)})`,
                    `15% (${config.currency} ${(total * 0.15).toFixed(2)})`,
                    `20% (${config.currency} ${(total * 0.20).toFixed(2)})`,
                    'Valor Personalizado'
                ];
                
                const choice = prompt(
                    `Escolha a gorjeta:\n\n1 - ${tipOptions[0]}\n2 - ${tipOptions[1]}\n3 - ${tipOptions[2]}\n4 - ${tipOptions[3]}\n\nDigite o n√∫mero da op√ß√£o:`
                );
                
                if (choice === '1') {
                    tip = total * 0.10;
                } else if (choice === '2') {
                    tip = total * 0.15;
                } else if (choice === '3') {
                    tip = total * 0.20;
                } else if (choice === '4') {
                    const customTip = parseFloat(prompt('Digite o valor da gorjeta:'));
                    if (customTip && customTip > 0) {
                        tip = customTip;
                    }
                }
                
                // Salvar gorjeta se foi adicionada
                if (tip > 0) {
                    db.ref(`tables/${tableId}/tip`).set(tip);
                }
            }
        }
        
        const totalWithTip = total + tip;
        
        let confirmMsg = `Fechar conta da Mesa ${tableId}?\n\nSubtotal: ${config.currency} ${subtotal.toFixed(2)}`;
        if (tip > 0) {
            confirmMsg += `\nGorjeta: ${config.currency} ${tip.toFixed(2)}`;
        }
        confirmMsg += `\n\nTOTAL: ${config.currency} ${totalWithTip.toFixed(2)}`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        // Salvar venda no hist√≥rico
        if (totalWithTip > 0) {
            const sale = {
                id: Date.now(),
                tableId: tableId,
                waiter: t.waiter || null,
                waiterName: t.waiter ? waiters.find(w => w.id === t.waiter)?.name || 'Sem gar√ßom' : 'Cliente direto',
                customerName: t.customerName || 'Cliente',
                subtotal: subtotal,
                tip: tip,
                total: totalWithTip,
                orders: t.orders || [],
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            db.ref(`sales/${sale.id}`).set(sale).catch(error => {
                console.error('Erro ao salvar venda:', error);
                alert('‚ö†Ô∏è Erro ao salvar hist√≥rico de venda, mas a mesa ser√° fechada.');
            });
        }
        
        // Resetar mesa
        db.ref(`tables/${tableId}`).set({
            id: tableId,
            status: 'livre',
            waiter: null,
            customerName: null,
            customerPin: null,
            total: 0,
            subtotal: 0,
            tip: 0,
            orders: [],
            pending: [],
            callWaiter: false
        }).then(() => {
            alert('‚úÖ Mesa fechada com sucesso!');
            setSel(null);
        }).catch(error => {
            console.error('Erro ao fechar mesa:', error);
            alert('‚ùå Erro ao fechar mesa! Tente novamente.');
        });
    };
    
    const showQRCode = (tableId) => {
        setQrModal(tableId);
        
        setTimeout(() => {
            const canvas = document.getElementById(`qr-canvas-balcao-${tableId}`);
            if (!canvas) {
                console.error('Canvas n√£o encontrado');
                return;
            }
            
            const url = `${window.location.href.split('?')[0]}?mesa=${tableId}`;
            
            if (window.QRCode) {
                window.QRCode.toCanvas(canvas, url, {
                    width: 300,
                    margin: 2,
                    color: {dark: '#000000', light: '#ffffff'}
                }, (error) => {
                    if (error) {
                        console.error('Erro ao gerar QR Code:', error);
                        alert('‚ùå Erro ao gerar QR Code!');
                    }
                });
            } else {
                console.error('Biblioteca QRCode n√£o carregada');
                alert('‚ùå Erro: Biblioteca QRCode n√£o carregada!');
            }
        }, 200);
    };
    
    const confirmOrder = (tableId, idx) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || !t.pending[idx]) {
            alert('‚ùå Erro: Pedido n√£o encontrado!');
            return;
        }
        
        const o = t.pending[idx];
        const newOrders = [...(t.orders || []), {...o, confirmedAt: Date.now()}];
        const newPending = t.pending.filter((_, i) => i !== idx);
        const newSubtotal = (t.subtotal || 0) + (o.price * o.quantity);
        const newTotal = newSubtotal; // SEM TAXA DE SERVI√áO
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: newPending,
            subtotal: newSubtotal,
            total: newTotal
        }).then(() => {
            playSound();
            alert('‚úÖ Pedido confirmado!');
            // Atualizar o modal com a mesa atualizada
            const updatedTable = tables.find(x => x.id === tableId);
            if (updatedTable && newPending.length === 0) {
                // Se n√£o tem mais pendentes, fecha o modal
                setSel(null);
            }
        }).catch(err => {
            console.error('Erro ao confirmar pedido:', err);
            alert('‚ùå Erro ao confirmar pedido!');
        });
    };
    
    const cancelOrder = (tableId, idx) => {
        if (!confirm('Tem certeza que deseja CANCELAR este pedido?')) return;
        
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || !t.pending[idx]) {
            alert('‚ùå Erro: Pedido n√£o encontrado!');
            return;
        }
        
        const newPending = t.pending.filter((_, i) => i !== idx);
        
        db.ref(`tables/${tableId}/pending`).set(newPending).then(() => {
            alert('‚ùå Pedido cancelado!');
            if (newPending.length === 0) {
                setSel(null);
            }
        }).catch(err => {
            console.error('Erro ao cancelar pedido:', err);
            alert('‚ùå Erro ao cancelar pedido!');
        });
    };
    
    const approveAll = (tableId) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || t.pending.length === 0) {
            alert('‚ùå N√£o h√° pedidos pendentes!');
            return;
        }
        
        if (!confirm(`Aprovar TODOS os ${t.pending.length} pedidos pendentes?`)) {
            return;
        }
        
        // Adicionar todos os pendentes aos confirmados
        const newOrders = [...(t.orders || []), ...t.pending.map(p => ({...p, confirmedAt: Date.now()}))];
        
        // Calcular novo total SEM TAXA
        const pendingTotal = t.pending.reduce((sum, p) => sum + (p.price * p.quantity), 0);
        const newSubtotal = (t.subtotal || 0) + pendingTotal;
        const newTotal = newSubtotal; // SEM TAXA DE SERVI√áO
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: [],
            subtotal: newSubtotal,
            total: newTotal
        }).then(() => {
            playSound();
            alert(`‚úÖ ${t.pending.length} pedidos aprovados!`);
        }).catch(err => {
            console.error('Erro ao aprovar todos:', err);
            alert('‚ùå Erro ao aprovar pedidos!');
        });
    };
    
    const occupiedTables = tables.filter(t => t.status === 'ocupada');
    const pendingCount = tables.reduce((sum, t) => sum + (t.pending ? t.pending.length : 0), 0);
    const totalRevenue = tables.reduce((sum, t) => sum + t.total, 0);
    
    return (
        <div style={{minHeight:'100vh',background:'#0a0a0a'}}>
            <header style={{background:'#1a1a1a',padding:'1.5rem',borderBottom:'2px solid #333',position:'sticky',top:0,zIndex:100}}>
                <div style={{maxWidth:'1600px',margin:'0 auto',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div>
                        <h1 style={{fontSize:'2rem',background:'linear-gradient(135deg,#e67e22,#d35400)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',fontWeight:'900',margin:0}}>üè™ BALC√ÉO</h1>
                        <p style={{color:'#888',fontSize:'0.9rem',margin:0}}>Gest√£o de Pedidos</p>
                    </div>
                    <button onClick={() => setView('login')} style={{padding:'0.8rem 1.8rem',background:'#e67e22',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}>SAIR</button>
                </div>
            </header>
            
            {/* STATS */}
            <div style={{background:'#0f0f0f',padding:'1.5rem',borderBottom:'2px solid #222'}}>
                <div style={{maxWidth:'1600px',margin:'0 auto',display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1.5rem'}}>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üçΩÔ∏è</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Mesas Ocupadas</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:'#e67e22'}}>{occupiedTables.length}/{tables.length}</div>
                    </div>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üîî</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Pedidos Pendentes</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:pendingCount > 0 ? '#e74c3c' : '#4a9d4e'}}>{pendingCount}</div>
                        {pendingCount > 0 && <NotificationBadge count={pendingCount} />}
                    </div>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üìû</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Chamadas de Gar√ßom</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:tables.filter(t => t.callWaiter).length > 0 ? '#e74c3c' : '#4a9d4e'}}>
                            {tables.filter(t => t.callWaiter).length}
                        </div>
                        {tables.filter(t => t.callWaiter).length > 0 && <NotificationBadge count={tables.filter(t => t.callWaiter).length} />}
                    </div>
                    <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',border:'2px solid #333',textAlign:'center'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üí∞</div>
                        <div style={{color:'#888',fontSize:'0.9rem',marginBottom:'0.3rem'}}>Em Aberto</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:'#4a9d4e'}}>{config.currency} {totalRevenue.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <main style={{padding:'2rem',maxWidth:'1600px',margin:'0 auto'}}>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'2rem'}}>
                    {tables.map(t => {
                        const hasPending = t.pending && t.pending.length > 0;
                        const hasOrders = t.orders && t.orders.length > 0;
                        const isOccupied = t.status === 'ocupada';
                        const hasCall = t.callWaiter;
                        
                        return (
                            <div 
                                key={t.id}
                                onClick={() => isOccupied && setSel(t)}
                                style={{
                                    background:'#1a1a1a',
                                    padding:'2rem',
                                    borderRadius:'16px',
                                    border: hasCall ? '3px solid #e74c3c' : hasPending ? '3px solid #e74c3c' : hasOrders ? '3px solid #4a9d4e' : isOccupied ? '3px solid #d4a017' : '3px solid #4a9d4e',
                                    cursor: isOccupied ? 'pointer' : 'default',
                                    position:'relative',
                                    animation: (hasPending || hasCall) ? 'blink 1.5s infinite' : 'none',
                                    transition:'all 0.3s'
                                }}
                                onMouseEnter={e => isOccupied && (e.currentTarget.style.transform = 'scale(1.03)')}
                                onMouseLeave={e => isOccupied && (e.currentTarget.style.transform = 'scale(1)')}
                            >
                                {hasPending && <NotificationBadge count={t.pending.length} />}
                                {hasCall && !hasPending && (
                                    <div style={{position:'absolute',top:'-10px',right:'-10px',background:'#e74c3c',color:'#fff',fontSize:'1.5rem',width:'40px',height:'40px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',animation:'pulse 1s infinite',boxShadow:'0 0 20px rgba(231,76,60,0.8)'}}>
                                        üîî
                                    </div>
                                )}
                                
                                <div style={{fontSize:'3rem',textAlign:'center',marginBottom:'1rem'}}>{isOccupied ? 'üçΩÔ∏è' : '‚úÖ'}</div>
                                <div style={{fontSize:'2rem',fontWeight:'900',textAlign:'center',marginBottom:'1rem'}}>Mesa {t.id}</div>
                                <div style={{textAlign:'center',padding:'0.5rem 1rem',borderRadius:'25px',background: isOccupied ? '#d4a017' : '#4a9d4e',color: isOccupied ? '#000' : '#fff',fontWeight:'800',fontSize:'0.9rem',marginBottom:'1rem'}}>
                                    {isOccupied ? 'OCUPADA' : 'LIVRE'}
                                </div>
                                
                                {isOccupied && (
                                    <>
                                        <div style={{color:'#888',fontSize:'0.95rem',textAlign:'center',marginBottom:'1rem'}}>
                                            {t.waiter ? waiters.find(w => w.id === t.waiter)?.name : `Cliente: ${t.customerName}`}
                                        </div>
                                        <div style={{background:'#0a0a0a',padding:'1rem',borderRadius:'12px',textAlign:'center',marginBottom:'0.8rem'}}>
                                            <div style={{color:'#888',fontSize:'0.8rem',marginBottom:'0.3rem'}}>Total</div>
                                            <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#e67e22'}}>{config.currency} {t.total.toFixed(2)}</div>
                                            {t.tip && t.tip > 0 && (
                                                <div style={{fontSize:'0.85rem',color:'#f39c12',marginTop:'0.5rem',fontWeight:'800'}}>
                                                    üíù Gorjeta: {config.currency} {t.tip.toFixed(2)}
                                                </div>
                                            )}
                                        </div>
                                        {hasCall && (
                                            <div style={{background:'#e74c3c',padding:'0.8rem',borderRadius:'8px',marginBottom:'0.8rem',textAlign:'center'}}>
                                                <div style={{color:'#fff',fontWeight:'800',fontSize:'0.9rem'}}>üîî CHAMANDO GAR√áOM</div>
                                            </div>
                                        )}
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem',fontSize:'0.85rem',marginBottom:'1rem'}}>
                                            <div style={{background:'#0a0a0a',padding:'0.8rem',borderRadius:'8px',textAlign:'center'}}>
                                                <div style={{color:'#4a9d4e',fontWeight:'800'}}>{t.orders ? t.orders.length : 0}</div>
                                                <div style={{color:'#888',fontSize:'0.75rem'}}>Confirmados</div>
                                            </div>
                                            <div style={{background:'#0a0a0a',padding:'0.8rem',borderRadius:'8px',textAlign:'center'}}>
                                                <div style={{color:hasPending ? '#e74c3c' : '#888',fontWeight:'800'}}>
                                                    {t.pending ? t.pending.length : 0}
                                                </div>
                                                <div style={{color:'#888',fontSize:'0.75rem'}}>Pendentes</div>
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.8rem'}}>
                                            <button 
                                                onClick={(e) => {e.stopPropagation(); showQRCode(t.id);}}
                                                style={{padding:'0.8rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}
                                            >
                                                üì± QR
                                            </button>
                                            <button 
                                                onClick={(e) => {e.stopPropagation(); closeTable(t.id);}}
                                                style={{padding:'0.8rem',background:'#e74c3c',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}
                                            >
                                                üí∞ FECHAR
                                            </button>
                                        </div>
                                    </>
                                )}
                                
                                {!isOccupied && (
                                    <div style={{display:'grid',gap:'0.8rem',marginTop:'1rem'}}>
                                        <button 
                                            onClick={(e) => {e.stopPropagation(); setSelW(t.id);}}
                                            style={{padding:'1rem',background:'#4a9d4e',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.95rem'}}
                                        >
                                            üîì ABRIR MESA
                                        </button>
                                        <button 
                                            onClick={(e) => {e.stopPropagation(); showQRCode(t.id);}}
                                            style={{padding:'0.8rem',background:'#3498db',border:'none',borderRadius:'8px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'0.85rem'}}
                                        >
                                            üì± VER QR CODE
                                        </button>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </main>
            
            {sel && (
                <div onClick={() => setSel(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999,padding:'2rem',overflowY:'auto'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'3rem',borderRadius:'24px',maxWidth:'700px',width:'100%',border:'3px solid #e67e22',maxHeight:'90vh',overflowY:'auto'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                            <h2 style={{fontSize:'2.5rem',color:'#e67e22',fontWeight:'900',margin:0}}>Mesa {sel.id}</h2>
                            <button onClick={() => setSel(null)} style={{background:'#2a2a2a',border:'none',width:'40px',height:'40px',borderRadius:'50%',color:'#888',fontSize:'1.5rem',cursor:'pointer',fontWeight:'800'}}>√ó</button>
                        </div>
                        
                        {/* INFO */}
                        <div style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px',marginBottom:'2rem'}}>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                                <div>
                                    <div style={{color:'#888',fontSize:'0.9rem'}}>Atendente</div>
                                    <div style={{fontWeight:'800',fontSize:'1.1rem'}}>
                                        {sel.waiter ? waiters.find(w => w.id === sel.waiter)?.name : sel.customerName}
                                    </div>
                                </div>
                            </div>
                            <div style={{borderTop:'1px solid #333',paddingTop:'1rem',marginTop:'1rem',textAlign:'center'}}>
                                <div style={{fontSize:'3rem',fontWeight:'900',color:'#e67e22'}}>{config.currency} {sel.total.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        {/* PEDIDOS PENDENTES */}
                        {sel.pending && sel.pending.length > 0 && (
                            <div style={{marginBottom:'2rem'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',gap:'1rem'}}>
                                    <h3 style={{color:'#e74c3c',fontSize:'1.5rem',margin:0}}>
                                        üîî Pendentes ({sel.pending.length})
                                    </h3>
                                    <div style={{display:'flex',gap:'0.8rem'}}>
                                        <button 
                                            onClick={() => {
                                                if (!confirm(`Cancelar TODOS os ${sel.pending.length} pedidos pendentes?`)) return;
                                                db.ref(`tables/${sel.id}/pending`).set([]).then(() => {
                                                    alert('‚ùå Todos os pedidos foram cancelados!');
                                                    setSel(null);
                                                }).catch(err => {
                                                    console.error('Erro ao cancelar pedidos:', err);
                                                    alert('‚ùå Erro ao cancelar pedidos!');
                                                });
                                            }}
                                            style={{
                                                padding:'0.8rem 1.5rem',
                                                background:'linear-gradient(135deg,#e74c3c,#c0392b)',
                                                border:'none',
                                                borderRadius:'10px',
                                                color:'#fff',
                                                fontWeight:'800',
                                                cursor:'pointer',
                                                fontSize:'0.9rem',
                                                boxShadow:'0 2px 10px rgba(231,76,60,0.3)'
                                            }}
                                        >
                                            ‚úó CANCELAR TODOS
                                        </button>
                                        <button 
                                            onClick={() => approveAll(sel.id)}
                                            style={{
                                                padding:'0.8rem 1.5rem',
                                                background:'linear-gradient(135deg,#4a9d4e,#45a049)',
                                                border:'none',
                                                borderRadius:'10px',
                                                color:'#fff',
                                                fontWeight:'800',
                                                cursor:'pointer',
                                                fontSize:'0.9rem',
                                                boxShadow:'0 2px 10px rgba(74,157,78,0.3)'
                                            }}
                                        >
                                            ‚úì APROVAR TODOS
                                        </button>
                                    </div>
                                </div>
                                {sel.pending.map((o, i) => (
                                    <div key={i} style={{
                                        background:'rgba(231,76,60,0.1)',
                                        border:'2px solid #e74c3c',
                                        padding:'1.5rem',
                                        borderRadius:'12px',
                                        marginBottom:'1rem'
                                    }}>
                                        <div style={{display:'flex',gap:'1.5rem',alignItems:'center',marginBottom:'1rem'}}>
                                            <span style={{fontSize:'3rem'}}>{o.image}</span>
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:'800',fontSize:'1.2rem',marginBottom:'0.3rem'}}>{o.name}</div>
                                                <div style={{color:'#888'}}>Qtd: {o.quantity} ‚Ä¢ {config.currency} {o.price.toFixed(2)} cada</div>
                                            </div>
                                            <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#e67e22'}}>
                                                {config.currency} {(o.price * o.quantity).toFixed(2)}
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'1fr 2fr',gap:'1rem'}}>
                                            <button 
                                                onClick={() => cancelOrder(sel.id, i)}
                                                style={{
                                                    width:'100%',
                                                    padding:'1rem',
                                                    background:'#e74c3c',
                                                    border:'none',
                                                    borderRadius:'10px',
                                                    color:'#fff',
                                                    fontWeight:'800',
                                                    cursor:'pointer',
                                                    fontSize:'1rem'
                                                }}
                                            >
                                                ‚úó CANCELAR
                                            </button>
                                            <button 
                                                onClick={() => confirmOrder(sel.id, i)}
                                                style={{
                                                    width:'100%',
                                                    padding:'1rem',
                                                    background:'#4a9d4e',
                                                    border:'none',
                                                    borderRadius:'10px',
                                                    color:'#fff',
                                                    fontWeight:'800',
                                                    cursor:'pointer',
                                                    fontSize:'1rem'
                                                }}
                                            >
                                                ‚úì CONFIRMAR PEDIDO
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* PEDIDOS CONFIRMADOS */}
                        {sel.orders && sel.orders.length > 0 && (
                            <div style={{marginBottom:'2rem'}}>
                                <h3 style={{color:'#4a9d4e',fontSize:'1.5rem',marginBottom:'1rem'}}>‚úì Confirmados ({sel.orders.length})</h3>
                                <div style={{background:'#0a0a0a',padding:'1.5rem',borderRadius:'12px'}}>
                                    {sel.orders.map((o, i) => (
                                        <div key={i} style={{
                                            display:'flex',
                                            gap:'1.5rem',
                                            alignItems:'center',
                                            padding:'1rem',
                                            borderBottom: i < sel.orders.length - 1 ? '1px solid #333' : 'none'
                                        }}>
                                            <span style={{fontSize:'2rem'}}>{o.image}</span>
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:'800',fontSize:'1.1rem'}}>{o.name}</div>
                                                <div style={{color:'#888',fontSize:'0.85rem'}}>Qtd: {o.quantity}</div>
                                            </div>
                                            <div style={{fontWeight:'800',color:'#4a9d4e',fontSize:'1.2rem'}}>
                                                {config.currency} {(o.price * o.quantity).toFixed(2)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* BOT√ÉO FECHAR CONTA */}
                        {sel.orders && sel.orders.length > 0 && (
                            <button 
                                onClick={() => closeTable(sel.id)}
                                style={{
                                    width:'100%',
                                    padding:'1.5rem',
                                    background:'linear-gradient(135deg,#e74c3c,#c0392b)',
                                    border:'none',
                                    borderRadius:'12px',
                                    color:'#fff',
                                    fontWeight:'900',
                                    cursor:'pointer',
                                    fontSize:'1.2rem',
                                    boxShadow:'0 4px 15px rgba(231,76,60,0.4)',
                                    marginTop:'1rem'
                                }}
                            >
                                üí∞ FECHAR CONTA - {config.currency} {sel.total.toFixed(2)}
                            </button>
                        )}
                    </div>
                </div>
            )}
            
            {/* MODAL SELECIONAR GAR√áOM */}
            {selW && (
                <div onClick={() => setSelW(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.9)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10000}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#1a1a1a',padding:'2.5rem',borderRadius:'20px',maxWidth:'450px',width:'100%',border:'3px solid #e67e22'}}>
                        <h2 style={{color:'#e67e22',marginBottom:'0.5rem',fontSize:'1.8rem',fontWeight:'900'}}>Abrir Mesa {selW}</h2>
                        <p style={{color:'#888',marginBottom:'1.5rem',fontSize:'0.95rem'}}>Selecione o gar√ßom respons√°vel:</p>
                        {waiters.filter(w => w.active).map(w => (
                            <button 
                                key={w.id} 
                                onClick={() => {openTable(selW, w.id); setSelW(null);}} 
                                style={{
                                    width:'100%',
                                    padding:'1.2rem',
                                    background:'#0a0a0a',
                                    border:'2px solid #333',
                                    borderRadius:'12px',
                                    color:'#fff',
                                    fontWeight:'800',
                                    cursor:'pointer',
                                    marginBottom:'1rem',
                                    fontSize:'1.1rem',
                                    transition:'all 0.3s'
                                }}
                                onMouseEnter={e => {
                                    e.currentTarget.style.background = '#4a9d4e';
                                    e.currentTarget.style.borderColor = '#4a9d4e';
                                }}
                                onMouseLeave={e => {
                                    e.currentTarget.style.background = '#0a0a0a';
                                    e.currentTarget.style.borderColor = '#333';
                                }}
                            >
                                üë®‚Äçüç≥ {w.name}
                            </button>
                        ))}
                        <button 
                            onClick={() => {openTable(selW, null); setSelW(null);}}
                            style={{
                                width:'100%',
                                padding:'1.2rem',
                                background:'#0a0a0a',
                                border:'2px solid #333',
                                borderRadius:'12px',
                                color:'#fff',
                                fontWeight:'800',
                                cursor:'pointer',
                                marginBottom:'1rem',
                                fontSize:'1.1rem',
                                transition:'all 0.3s'
                            }}
                            onMouseEnter={e => {
                                e.currentTarget.style.background = '#6c757d';
                                e.currentTarget.style.borderColor = '#6c757d';
                            }}
                            onMouseLeave={e => {
                                e.currentTarget.style.background = '#0a0a0a';
                                e.currentTarget.style.borderColor = '#333';
                            }}
                        >
                            ü§∑ Sem Gar√ßom
                        </button>
                        <button onClick={() => setSelW(null)} style={{width:'100%',padding:'1rem',background:'#2a2a2a',border:'none',borderRadius:'12px',color:'#888',fontWeight:'800',cursor:'pointer',marginTop:'0.5rem'}}>CANCELAR</button>
                    </div>
                </div>
            )}
            
            {/* MODAL QR CODE */}
            {qrModal && (
                <div onClick={() => setQrModal(null)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.95)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10001,padding:'1rem'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#fff',padding:'3rem',borderRadius:'20px',maxWidth:'500px',width:'100%',textAlign:'center'}}>
                        <h2 style={{color:'#000',marginBottom:'0.5rem',fontSize:'2rem',fontWeight:'900'}}>üçΩÔ∏è Mesa {qrModal}</h2>
                        <p style={{color:'#666',marginBottom:'2rem',fontSize:'0.95rem'}}>Escaneie o QR Code para acessar o card√°pio</p>
                        
                        <div style={{background:'#f5f5f5',padding:'2rem',borderRadius:'12px',marginBottom:'1.5rem',display:'flex',justifyContent:'center',alignItems:'center',minHeight:'340px'}}>
                            <canvas id={`qr-canvas-balcao-${qrModal}`}></canvas>
                        </div>
                        
                        <div style={{background:'#f0f0f0',padding:'1rem',borderRadius:'8px',marginBottom:'1.5rem'}}>
                            <p style={{color:'#666',fontSize:'0.75rem',marginBottom:'0.3rem'}}>Link direto:</p>
                            <p style={{color:'#333',fontSize:'0.85rem',fontWeight:'600',wordBreak:'break-all',margin:0}}>
                                {window.location.href.split('?')[0]}?mesa={qrModal}
                            </p>
                        </div>
                        
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'}}>
                            <button 
                                onClick={() => {
                                    const canvas = document.getElementById(`qr-canvas-balcao-${qrModal}`);
                                    if (canvas) {
                                        const link = document.createElement('a');
                                        link.download = `qrcode-mesa-${qrModal}.png`;
                                        link.href = canvas.toDataURL();
                                        link.click();
                                    }
                                }}
                                style={{padding:'1.2rem',background:'#3498db',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}
                            >
                                üíæ BAIXAR
                            </button>
                            <button onClick={() => setQrModal(null)} style={{padding:'1.2rem',background:'#e67e22',border:'none',borderRadius:'12px',color:'#fff',fontWeight:'800',cursor:'pointer',fontSize:'1rem'}}>‚úì FECHAR</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function NotificationBadge({count}) {
    if (!count || count === 0) return null;
    return (
        <div style={{
            position:'absolute',
            top:'-8px',
            right:'-8px',
            background:'#e74c3c',
            color:'#fff',
            minWidth:'24px',
            height:'24px',
            borderRadius:'12px',
            display:'flex',
            alignItems:'center',
            justifyContent:'center',
            fontSize:'0.75rem',
            fontWeight:'900',
            padding:'0 6px',
            boxShadow:'0 2px 8px rgba(231,76,60,0.5)',
            animation:'pulse 1.5s infinite'
        }}>
            {count}
        </div>
    );
}

function Waiter({tables, products, config, user, setView}) {
    const [cart, setCart] = useState([]);
    const [orderingFor, setOrderingFor] = useState(null);
    const [showChat, setShowChat] = useState(false);
    const [selectedTable, setSelectedTable] = useState(null);
    const [chatMessage, setChatMessage] = useState('');
    
    const myTables = tables.filter(t => t.waiter === user.waiterId && t.status === 'ocupada');
    const pendingCount = myTables.reduce((s, t) => s + (t.pending ? t.pending.length : 0), 0);
    const totalSales = myTables.reduce((s, t) => s + t.total, 0);
    const callingCount = myTables.filter(t => t.callWaiter).length;
    
    // Contar mensagens n√£o lidas de todas as mesas
    const unreadMessagesCount = myTables.reduce((total, table) => {
        if (table.messages) {
            return total + table.messages.filter(m => m.from === 'customer' && !m.read).length;
        }
        return total;
    }, 0);
    
    const sendOrder = () => {
        if (!orderingFor || cart.length === 0) return;
        
        const newItems = cart.map(i => ({
            ...i, 
            addedBy: user.name, 
            addedAt: Date.now(),
            orderId: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
        }));
        
        const pendingRef = db.ref(`tables/${orderingFor.id}/pending`);
        pendingRef.once('value').then(snapshot => {
            const currentPending = snapshot.val() || [];
            const updatedPending = [...currentPending, ...newItems];
            pendingRef.set(updatedPending);
        });
        
        setCart([]);
        setOrderingFor(null);
        alert(`‚úÖ ${newItems.length} ${newItems.length === 1 ? 'pedido enviado' : 'pedidos enviados'}!`);
        playSound();
    };
    
    const confirmPending = (tableId, idx) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || !t.pending[idx]) return;
        
        const item = t.pending[idx];
        const newOrders = [...(t.orders || []), {...item, confirmedAt: Date.now()}];
        const newPending = t.pending.filter((_, i) => i !== idx);
        
        const itemTotal = item.price * item.quantity;
        const newSubtotal = (t.subtotal || 0) + itemTotal;
        const newTotal = newSubtotal;
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: newPending,
            subtotal: newSubtotal,
            total: newTotal
        }).then(() => {
            playSound();
        });
    };
    
    const confirmAllPending = (tableId) => {
        const t = tables.find(x => x.id === tableId);
        if (!t || !t.pending || t.pending.length === 0) return;
        
        if (!confirm(`Confirmar TODOS os ${t.pending.length} pedidos?`)) return;
        
        const newOrders = [...(t.orders || []), ...t.pending.map(p => ({...p, confirmedAt: Date.now()}))];
        const pendingTotal = t.pending.reduce((sum, p) => sum + (p.price * p.quantity), 0);
        const newSubtotal = (t.subtotal || 0) + pendingTotal;
        
        db.ref(`tables/${tableId}`).update({
            orders: newOrders,
            pending: [],
            subtotal: newSubtotal,
            total: newSubtotal
        }).then(() => {
            playSound();
            alert('‚úÖ Todos os pedidos confirmados!');
        });
    };
    
    const sendChatMessage = () => {
        if (!chatMessage.trim() || !selectedTable) return;
        
        const newMessage = {
            text: chatMessage,
            from: 'waiter',
            senderName: user.name,
            timestamp: Date.now(),
            read: false
        };
        
        const messages = selectedTable.messages || [];
        db.ref(`tables/${selectedTable.id}/messages`).set([...messages, newMessage]);
        
        setChatMessage('');
        playSound();
    };
    
    const grouped = products.filter(p => p.active).reduce((acc, p) => {
        if (!acc[p.category]) acc[p.category] = [];
        acc[p.category].push(p);
        return acc;
    }, {});
    
    return (
        <div className="fade-in" style={{minHeight:'100vh',background:'linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)'}}>
            {/* Header Moderno */}
            <header className="glass" style={{
                padding:'1.5rem',
                borderBottom:'1px solid rgba(255,255,255,0.1)',
                position:'sticky',
                top:0,
                zIndex:100,
                backdropFilter:'blur(20px)'
            }}>
                <div style={{maxWidth:'1400px',margin:'0 auto',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <div>
                        <h1 className="gradient-text" style={{fontSize:'2rem',fontWeight:'900',margin:0,letterSpacing:'-0.5px'}}>
                            üë®‚Äçüç≥ {user.name}
                        </h1>
                        <p style={{color:'var(--text-secondary)',fontSize:'0.9rem',margin:0,fontWeight:'500'}}>Gar√ßom</p>
                    </div>
                    <button 
                        onClick={() => setView('login')} 
                        className="btn btn-primary"
                        style={{padding:'0.8rem 1.8rem'}}
                    >
                        SAIR
                    </button>
                </div>
            </header>
            
            {/* Dashboard de Estat√≠sticas */}
            <div style={{padding:'2rem',borderBottom:'1px solid rgba(255,255,255,0.05)'}}>
                <div style={{maxWidth:'1400px',margin:'0 auto',display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1.5rem'}}>
                    <div className="card" style={{textAlign:'center',background:'linear-gradient(135deg, rgba(52,152,219,0.1), rgba(41,128,185,0.05))'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üçΩÔ∏è</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Minhas Mesas</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:'var(--info)'}}>{myTables.length}</div>
                    </div>
                    <div className="card" style={{textAlign:'center',background:callingCount > 0 ? 'linear-gradient(135deg, rgba(243,156,18,0.1), rgba(230,126,34,0.05))' : 'rgba(255,255,255,0.02)',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üîî</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Chamadas</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:callingCount > 0 ? 'var(--warning)' : 'var(--text-secondary)'}}>{callingCount}</div>
                        {callingCount > 0 && <NotificationBadge count={callingCount} />}
                    </div>
                    <div className="card" style={{textAlign:'center',background:pendingCount > 0 ? 'linear-gradient(135deg, rgba(231,76,60,0.1), rgba(192,57,43,0.05))' : 'rgba(255,255,255,0.02)',position:'relative'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üìã</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Pendentes</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:pendingCount > 0 ? 'var(--danger)' : 'var(--accent)'}}>{pendingCount}</div>
                        {pendingCount > 0 && <NotificationBadge count={pendingCount} />}
                    </div>
                    <div className="card" style={{textAlign:'center',background:'linear-gradient(135deg, rgba(74,157,78,0.1), rgba(69,160,73,0.05))'}}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üí∞</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Vendas</div>
                        <div style={{fontSize:'2rem',fontWeight:'900',color:'var(--accent)'}}>{config.currency} {totalSales.toFixed(2)}</div>
                    </div>
                    <div className="card" style={{textAlign:'center',background:unreadMessagesCount > 0 ? 'linear-gradient(135deg, rgba(52,152,219,0.1), rgba(41,128,185,0.05))' : 'rgba(255,255,255,0.02)',position:'relative',cursor:'pointer'}} onClick={() => {
                        const tableWithMessages = myTables.find(t => t.messages && t.messages.some(m => m.from === 'customer' && !m.read));
                        if (tableWithMessages) {
                            setSelectedTable(tableWithMessages);
                            setShowChat(true);
                        }
                    }}>
                        <div style={{fontSize:'2.5rem',marginBottom:'0.5rem'}}>üí¨</div>
                        <div style={{color:'var(--text-secondary)',fontSize:'0.9rem',marginBottom:'0.3rem',fontWeight:'600'}}>Mensagens</div>
                        <div style={{fontSize:'2.5rem',fontWeight:'900',color:unreadMessagesCount > 0 ? 'var(--info)' : 'var(--text-secondary)'}}>{unreadMessagesCount}</div>
                        {unreadMessagesCount > 0 && <NotificationBadge count={unreadMessagesCount} />}
                    </div>
                </div>
            </div>
            
            {/* √Årea Principal - Mesas */}
            <main style={{padding:'2rem',maxWidth:'1400px',margin:'0 auto',paddingBottom:'150px'}}>
                {!orderingFor ? (
                    <div>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'2rem'}}>
                            <h2 className="gradient-text" style={{fontSize:'2rem',fontWeight:'900',margin:0}}>Minhas Mesas</h2>
                            {myTables.length > 0 && (
                                <div style={{color:'var(--text-secondary)',fontSize:'0.95rem',fontWeight:'600'}}>
                                    {myTables.length} {myTables.length === 1 ? 'mesa' : 'mesas'} ativa{myTables.length === 1 ? '' : 's'}
                                </div>
                            )}
                        </div>
                        
                        {myTables.length === 0 ? (
                            <div className="card" style={{textAlign:'center',padding:'4rem',marginTop:'3rem'}}>
                                <div style={{fontSize:'5rem',marginBottom:'1.5rem',opacity:0.5}}>üçΩÔ∏è</div>
                                <h3 style={{fontSize:'1.8rem',marginBottom:'0.8rem',fontWeight:'700'}}>Nenhuma mesa atribu√≠da</h3>
                                <p style={{color:'var(--text-secondary)',fontSize:'1rem'}}>Aguarde o admin abrir mesas para voc√™</p>
                            </div>
                        ) : (
                            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(300px,1fr))',gap:'1.5rem'}}>
                                {myTables.map(t => {
                                    const hasPending = t.pending && t.pending.length > 0;
                                    const hasOrders = t.orders && t.orders.length > 0;
                                    const isCallingWaiter = t.callWaiter;
                                    const hasMessages = t.messages && t.messages.some(m => m.from === 'customer' && !m.read);
                                    const unreadCount = hasMessages ? t.messages.filter(m => m.from === 'customer' && !m.read).length : 0;
                                    
                                    let borderColor = 'var(--info)';
                                    if (isCallingWaiter) borderColor = 'var(--warning)';
                                    else if (hasPending) borderColor = 'var(--danger)';
                                    else if (hasOrders) borderColor = 'var(--accent)';
                                    
                                    return (
                                        <div 
                                            key={t.id} 
                                            className="card" 
                                            style={{
                                                position:'relative',
                                                border:`2px solid ${borderColor}`,
                                                animation: (hasPending || isCallingWaiter) ? 'pulse 2s infinite' : 'none',
                                                cursor:'pointer',
                                                transition:'all 0.3s ease'
                                            }}
                                            onClick={() => setOrderingFor(t)}
                                        >
                                            {/* Badges de Notifica√ß√£o */}
                                            {hasPending && (
                                                <div style={{
                                                    position:'absolute',
                                                    top:'-10px',
                                                    right:'-10px',
                                                    background:'var(--danger)',
                                                    color:'#fff',
                                                    borderRadius:'50%',
                                                    width:'32px',
                                                    height:'32px',
                                                    display:'flex',
                                                    alignItems:'center',
                                                    justifyContent:'center',
                                                    fontWeight:'900',
                                                    fontSize:'0.9rem',
                                                    boxShadow:'0 4px 12px rgba(231,76,60,0.5)',
                                                    zIndex:10
                                                }}>
                                                    {t.pending.length}
                                                </div>
                                            )}
                                            
                                            {isCallingWaiter && (
                                                <div style={{
                                                    position:'absolute',
                                                    top:'-12px',
                                                    left:'50%',
                                                    transform:'translateX(-50%)',
                                                    background:'var(--warning)',
                                                    color:'#000',
                                                    padding:'0.5rem 1.2rem',
                                                    borderRadius:'20px',
                                                    fontWeight:'900',
                                                    fontSize:'0.85rem',
                                                    boxShadow:'0 4px 15px rgba(243,156,18,0.6)',
                                                    animation:'pulse 1s infinite',
                                                    whiteSpace:'nowrap'
                                                }}>
                                                    üîî CHAMANDO VOC√ä!
                                                </div>
                                            )}
                                            
                                            {/* √çcone e N√∫mero da Mesa */}
                                            <div style={{textAlign:'center',marginTop: isCallingWaiter ? '1.5rem' : '0'}}>
                                                <div style={{fontSize:'3.5rem',marginBottom:'0.5rem'}}>üçΩÔ∏è</div>
                                                <div style={{
                                                    fontSize:'2.5rem',
                                                    fontWeight:'900',
                                                    color:borderColor,
                                                    marginBottom:'0.5rem',
                                                    letterSpacing:'-1px'
                                                }}>
                                                    Mesa {t.id}
                                                </div>
                                                {t.customerName && (
                                                    <div style={{
                                                        color:'var(--text-secondary)',
                                                        fontSize:'0.95rem',
                                                        fontWeight:'600',
                                                        marginBottom:'1rem'
                                                    }}>
                                                        üë§ {t.customerName}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Total */}
                                            <div style={{
                                                background:'rgba(212,165,116,0.1)',
                                                padding:'1.2rem',
                                                borderRadius:'12px',
                                                textAlign:'center',
                                                marginBottom:'1rem',
                                                border:'1px solid rgba(212,165,116,0.2)'
                                            }}>
                                                <div style={{color:'var(--text-secondary)',fontSize:'0.85rem',fontWeight:'600',marginBottom:'0.3rem'}}>TOTAL</div>
                                                <div style={{fontSize:'2rem',fontWeight:'900',color:'var(--primary)'}}>{config.currency} {t.total.toFixed(2)}</div>
                                            </div>
                                            
                                            {/* Estat√≠sticas */}
                                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.8rem',marginBottom:'1.2rem'}}>
                                                <div style={{
                                                    background:'rgba(74,157,78,0.1)',
                                                    padding:'0.8rem 0.5rem',
                                                    borderRadius:'10px',
                                                    textAlign:'center',
                                                    border:'1px solid rgba(74,157,78,0.2)'
                                                }}>
                                                    <div style={{color:'var(--accent)',fontWeight:'900',fontSize:'1.3rem'}}>{t.orders ? t.orders.length : 0}</div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.7rem',fontWeight:'600'}}>Confirmados</div>
                                                </div>
                                                <div style={{
                                                    background: hasPending ? 'rgba(231,76,60,0.1)' : 'rgba(255,255,255,0.03)',
                                                    padding:'0.8rem 0.5rem',
                                                    borderRadius:'10px',
                                                    textAlign:'center',
                                                    border: hasPending ? '1px solid rgba(231,76,60,0.2)' : '1px solid rgba(255,255,255,0.05)'
                                                }}>
                                                    <div style={{color:hasPending?'var(--danger)':'var(--text-secondary)',fontWeight:'900',fontSize:'1.3rem'}}>{t.pending ? t.pending.length : 0}</div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.7rem',fontWeight:'600'}}>Pendentes</div>
                                                </div>
                                                <div 
                                                    style={{
                                                        background: hasMessages ? 'rgba(52,152,219,0.1)' : 'rgba(255,255,255,0.03)',
                                                        padding:'0.8rem 0.5rem',
                                                        borderRadius:'10px',
                                                        textAlign:'center',
                                                        border: hasMessages ? '1px solid rgba(52,152,219,0.2)' : '1px solid rgba(255,255,255,0.05)',
                                                        cursor: hasMessages ? 'pointer' : 'default'
                                                    }}
                                                    onClick={(e) => {
                                                        if (hasMessages) {
                                                            e.stopPropagation();
                                                            setSelectedTable(t);
                                                            setShowChat(true);
                                                        }
                                                    }}
                                                >
                                                    <div style={{color:hasMessages?'var(--info)':'var(--text-secondary)',fontWeight:'900',fontSize:'1.3rem'}}>
                                                        {hasMessages ? unreadCount : 'üí¨'}
                                                    </div>
                                                    <div style={{color:'var(--text-secondary)',fontSize:'0.7rem',fontWeight:'600'}}>Mensagens</div>
                                                </div>
                                            </div>
                                            
                                            {/* Bot√µes de A√ß√£o */}
                                            <div style={{display:'grid',gap:'0.8rem'}}>
                                                {isCallingWaiter && (
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            db.ref(`tables/${t.id}/callWaiter`).set(false);
                                                            playSound();
                                                            alert('‚úÖ Chamado atendido!');
                                                        }} 
                                                        className="btn"
                                                        style={{
                                                            background:'linear-gradient(135deg, var(--warning), #e67e22)',
                                                            color:'#000',
                                                            boxShadow:'0 4px 15px rgba(243,156,18,0.4)'
                                                        }}
                                                    >
                                                        ‚úì ATENDER CHAMADO
                                                    </button>
                                                )}
                                                
                                                {hasPending && (
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            confirmAllPending(t.id);
                                                        }} 
                                                        className="btn btn-success"
                                                    >
                                                        ‚úì CONFIRMAR TODOS ({t.pending.length})
                                                    </button>
                                                )}
                                                
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setOrderingFor(t);
                                                    }}
                                                    className="btn"
                                                    style={{
                                                        background:'linear-gradient(135deg, var(--info), #2980b9)',
                                                        color:'#fff',
                                                        boxShadow:'0 4px 15px rgba(52,152,219,0.3)'
                                                    }}
                                                >
                                                    + FAZER PEDIDO
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                ) : (
                    <div>
                        <div style={{background:'#1a1a1a',padding:'1.5rem',borderRadius:'12px',marginBottom:'2rem',display:'flex',justifyContent:'space-between'}}>
                            <h2 style={{color:'#3498db',margin:0}}>Mesa {orderingFor.id} - Fazer Pedido</h2>
                            <button onClick={() => {setOrderingFor(null); setCart([]);}} style={{padding:'0.8rem 1.5rem',background:'#2a2a2a',border:'none',borderRadius:'10px',color:'#888',fontWeight:'800',cursor:'pointer'}}>CANCELAR</button>
                        </div>
                        {Object.entries(grouped).map(([cat, items]) => (
                            <div key={cat} style={{marginBottom:'2rem'}}>
                                <h3 style={{fontSize:'1.3rem',marginBottom:'1rem',color:'#d4a574'}}>{cat}</h3>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(150px,1fr))',gap:'1rem'}}>
                                    {items.map(p => (
                                        <div key={p.id} onClick={() => {
                                            const ex = cart.find(i => i.id === p.id);
                                            if (ex) setCart(cart.map(i => i.id === p.id ? {...i, quantity: i.quantity + 1} : i));
                                            else setCart([...cart, {...p, quantity: 1}]);
                                        }} style={{background:'#1a1a1a',border:'2px solid #333',borderRadius:'12px',padding:'1rem',textAlign:'center',cursor:'pointer'}}>
                                            <div style={{fontSize:'3rem',marginBottom:'0.5rem'}}>{p.image}</div>
                                            <div style={{fontWeight:'800',fontSize:'0.9rem',marginBottom:'0.3rem'}}>{p.name}</div>
                                            <div style={{color:'#3498db',fontWeight:'900'}}>{config.currency} {p.price.toFixed(2)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        {cart.length > 0 && (
                            <div style={{position:'fixed',bottom:'20px',right:'20px',background:'#1a1a1a',border:'3px solid #3498db',borderRadius:'16px',padding:'1.5rem',minWidth:'300px',maxHeight:'60vh',overflowY:'auto',boxShadow:'0 8px 32px rgba(0,0,0,0.5)',zIndex:1000}}>
                                <h3 style={{color:'#3498db',marginBottom:'1rem'}}>üõí Carrinho ({cart.length})</h3>
                                {cart.map(i => (
                                    <div key={i.id} style={{background:'#0a0a0a',borderRadius:'8px',padding:'0.8rem',marginBottom:'0.8rem',display:'flex',alignItems:'center',gap:'0.8rem'}}>
                                        <span style={{fontSize:'1.5rem'}}>{i.image}</span>
                                        <div style={{flex:1}}>
                                            <div style={{fontWeight:'800',fontSize:'0.9rem'}}>{i.name}</div>
                                            <div style={{color:'#3498db',fontSize:'0.85rem'}}>{config.currency} {(i.price * i.quantity).toFixed(2)}</div>
                                        </div>
                                        <div style={{display:'flex',gap:'0.3rem',alignItems:'center'}}>
                                            <button onClick={() => setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity - 1} : x).filter(x => x.quantity > 0))} style={{background:'#e74c3c',border:'none',width:'24px',height:'24px',borderRadius:'50%',color:'#fff',cursor:'pointer',fontWeight:'900'}}>‚àí</button>
                                            <span style={{fontWeight:'900',minWidth:'20px',textAlign:'center'}}>{i.quantity}</span>
                                            <button onClick={() => setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity + 1} : x))} style={{background:'#4a9d4e',border:'none',width:'24px',height:'24px',borderRadius:'50%',color:'#fff',cursor:'pointer',fontWeight:'900'}}>+</button>
                                        </div>
                                    </div>
                                ))}
                                <div style={{borderTop:'2px solid #333',paddingTop:'1rem',marginTop:'1rem'}}>
                                    <div style={{marginBottom:'1rem',textAlign:'right'}}>
                                        <span style={{color:'#888'}}>Total: </span>
                                        <span style={{color:'#3498db',fontSize:'1.3rem',fontWeight:'900'}}>{config.currency} {cart.reduce((s, i) => s + i.price * i.quantity, 0).toFixed(2)}</span>
                                    </div>
                                    <button onClick={sendOrder} style={{width:'100%',padding:'1rem',background:'linear-gradient(135deg,#4a9d4e,#45a049)',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'900',cursor:'pointer'}}>üì§ ENVIAR PEDIDO</button>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </main>
        </div>
    );
}

function Customer({tables, products, config, waiters, setView}) {
    const tableId = parseInt(sessionStorage.getItem('tableId'));
    const [table, setTable] = useState(null);
    const [cart, setCart] = useState([]);
    const [show, setShow] = useState(false);
    const [tab, setTab] = useState('menu');
    const [chatMessage, setChatMessage] = useState('');
    const [showChat, setShowChat] = useState(false);
    const [unreadMessages, setUnreadMessages] = useState(0);
    const chatEndRef = useRef(null);
    
    // Scroll autom√°tico para √∫ltima mensagem
    useEffect(() => {
        if (showChat && chatEndRef.current) {
            chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }
    }, [table?.messages, showChat]);
    
    // Contar mensagens n√£o lidas
    useEffect(() => {
        if (table?.messages) {
            const unread = table.messages.filter(m => m.from !== 'customer' && !m.read).length;
            setUnreadMessages(unread);
        }
    }, [table?.messages]);
    
    // Marcar mensagens como lidas quando abrir chat
    useEffect(() => {
        if (showChat && table?.messages && unreadMessages > 0) {
            const updatedMessages = table.messages.map(m => 
                m.from !== 'customer' ? {...m, read: true} : m
            );
            db.ref(`tables/${tableId}/messages`).set(updatedMessages);
            setUnreadMessages(0);
        }
    }, [showChat]);
    
    const sendMessage = () => {
        if (!chatMessage.trim()) return;
        
        const newMessage = {
            text: chatMessage,
            from: 'customer',
            customerName: table.customerName || 'Cliente',
            timestamp: Date.now(),
            read: false
        };
        
        const messages = table.messages || [];
        db.ref(`tables/${tableId}/messages`).set([...messages, newMessage]);
        
        setChatMessage('');
        playSound();
    };
    
    const callWaiter = () => {
        if (!confirm('Deseja chamar o gar√ßom?')) return;
        
        db.ref(`tables/${tableId}/callWaiter`).set(true).then(() => {
            playSound();
            alert('‚úÖ Gar√ßom chamado! Aguarde, ele j√° vem atend√™-lo.');
        });
    };
    
    useEffect(() => {
        if (!tableId) {setView('login'); return;}
        db.ref(`tables/${tableId}`).on('value', s => {if (s.val()) setTable(s.val());});
        return () => db.ref(`tables/${tableId}`).off();
    }, [tableId]);
    
    const addOrder = () => {
        if (cart.length === 0) {
            alert('‚ùå Carrinho vazio!');
            return;
        }
        
        // Usar push para adicionar novos itens sem sobrescrever
        const newItems = cart.map(i => ({
            ...i, 
            addedAt: Date.now(),
            orderId: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
        }));
        
        // Adicionar cada item individualmente
        const pendingRef = db.ref(`tables/${tableId}/pending`);
        pendingRef.once('value').then(snapshot => {
            const currentPending = snapshot.val() || [];
            const updatedPending = [...currentPending, ...newItems];
            pendingRef.set(updatedPending);
        });
        
        setCart([]);
        setShow(false);
        setTab('bill');
        alert(`‚úÖ ${newItems.length} ${newItems.length === 1 ? 'pedido enviado' : 'pedidos enviados'}!`);
        playSound();
    };
    
    if (!table) return <div style={{padding:'2rem',textAlign:'center'}}>Carregando...</div>;
    
    const grouped = products.filter(p => p.active).reduce((a, p) => {
        if (!a[p.category]) a[p.category] = [];
        a[p.category].push(p);
        return a;
    }, {});
    
    return (
        <div style={{minHeight:'100vh',background:'#fff',color:'#000'}}>
            <header style={{background:'#1a1a1a',padding:'1.5rem',textAlign:'center',color:'#fff'}}>
                {config.logo && (
                    <div style={{marginBottom:'1rem'}}>
                        <img src={config.logo} alt={config.barName} style={{maxWidth:'300px',height:'200px'}} />
                    </div>
                )}
                <div style={{background:'#d4a574',padding:'0.5rem 1.5rem',borderRadius:'25px',display:'inline-block',marginBottom:'1rem',color:'#000',fontWeight:'800'}}>MESA {table.id}</div>
                {!config.logo && <h1 style={{fontSize:'2rem',marginBottom:'0.5rem'}}>{config.barName}</h1>}
            </header>
            
            <nav style={{display:'flex',background:'#f5f5f5',borderBottom:'2px solid #e0e0e0',position:'sticky',top:0,zIndex:100}}>
                <button onClick={() => setTab('menu')} style={{flex:1,padding:'1.2rem',background:tab==='menu'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='menu'?'#d4a574':'#666',cursor:'pointer'}}>üìã CARD√ÅPIO</button>
                <button onClick={() => setTab('bill')} style={{flex:1,padding:'1.2rem',background:tab==='bill'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='bill'?'#d4a574':'#666',cursor:'pointer'}}>üßæ CONTA</button>
                <button onClick={() => {setTab('chat'); setShowChat(true);}} style={{flex:1,padding:'1.2rem',background:tab==='chat'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='chat'?'#3498db':'#666',cursor:'pointer',position:'relative'}}>
                    üí¨ CHAT
                    {unreadMessages > 0 && (
                        <span style={{
                            position:'absolute',
                            top:'8px',
                            right:'8px',
                            background:'#e74c3c',
                            color:'#fff',
                            borderRadius:'50%',
                            width:'20px',
                            height:'20px',
                            fontSize:'0.7rem',
                            display:'flex',
                            alignItems:'center',
                            justifyContent:'center',
                            fontWeight:'900'
                        }}>{unreadMessages}</span>
                    )}
                </button>
                <button onClick={() => setTab('call')} style={{flex:1,padding:'1.2rem',background:tab==='call'?'#fff':'transparent',border:'none',fontWeight:'800',color:tab==='call'?'#f39c12':'#666',cursor:'pointer'}}>üîî CHAMAR</button>
            </nav>
            
            <main style={{padding:'2rem',paddingBottom:'150px'}}>
                {tab === 'menu' && (
                    <div>
                        {Object.entries(grouped).map(([cat, items]) => (
                            <div key={cat} style={{marginBottom:'2.5rem'}}>
                                <h2 style={{fontSize:'1.8rem',fontWeight:'900',marginBottom:'1.5rem'}}>{cat === 'Bebidas' ? 'üç∫' : 'üçó'} {cat}</h2>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(160px,1fr))',gap:'1.5rem'}}>
                                    {items.map(p => (
                                        <div key={p.id} onClick={() => {
                                            const ex = cart.find(i => i.id === p.id);
                                            if (ex) setCart(cart.map(i => i.id === p.id ? {...i, quantity: i.quantity + 1} : i));
                                            else setCart([...cart, {...p, quantity: 1}]);
                                        }} style={{background:'#fff',border:'2px solid #e0e0e0',borderRadius:'16px',padding:'1.5rem',textAlign:'center',cursor:'pointer'}}>
                                            <span style={{fontSize:'3.5rem',display:'block',marginBottom:'0.8rem'}}>{p.image}</span>
                                            <div style={{fontWeight:'800',marginBottom:'0.5rem',fontSize:'0.95rem'}}>{p.name}</div>
                                            <div style={{color:'#d4a574',fontSize:'1.2rem',fontWeight:'900'}}>{config.currency} {p.price.toFixed(2)}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {tab === 'bill' && (
                    <div style={{background:'#fff',borderRadius:'20px',padding:'2rem'}}>
                        <div style={{textAlign:'center',paddingBottom:'1.5rem',borderBottom:'2px solid #e0e0e0',marginBottom:'1.5rem'}}>
                            <h2 style={{fontSize:'1.8rem',marginBottom:'1rem'}}>Sua Conta</h2>
                            <div style={{fontSize:'3rem',fontWeight:'900',color:'#d4a574'}}>{config.currency} {table.total.toFixed(2)}</div>
                            {table.tip && table.tip > 0 && (
                                <div style={{marginTop:'1rem',padding:'1rem',background:'#fff3cd',borderRadius:'10px'}}>
                                    <div style={{color:'#856404',fontSize:'0.9rem'}}>üíù Gorjeta para o gar√ßom</div>
                                    <div style={{fontSize:'1.5rem',fontWeight:'900',color:'#f39c12'}}>+ {config.currency} {table.tip.toFixed(2)}</div>
                                    <div style={{fontSize:'1.8rem',fontWeight:'900',color:'#d4a574',marginTop:'0.5rem',paddingTop:'0.5rem',borderTop:'2px solid #f39c12'}}>
                                        Total com gorjeta: {config.currency} {(table.total + table.tip).toFixed(2)}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* BOT√ïES DE GORJETA */}
                        {!table.tip && table.orders && table.orders.length > 0 && (
                            <div style={{marginBottom:'2rem',padding:'1.5rem',background:'#f8f9fa',borderRadius:'12px'}}>
                                <h3 style={{textAlign:'center',marginBottom:'1rem',color:'#f39c12',fontSize:'1.3rem'}}>üíù Gostou do atendimento?</h3>
                                <p style={{textAlign:'center',color:'#666',marginBottom:'1rem',fontSize:'0.9rem'}}>Deixe uma gorjeta para o gar√ßom</p>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'1rem'}}>
                                    {[10, 15, 20].map(percent => {
                                        const tipValue = (table.total * percent) / 100;
                                        return (
                                            <button 
                                                key={percent}
                                                onClick={() => {
                                                    if (confirm(`Adicionar gorjeta de ${percent}% (${config.currency} ${tipValue.toFixed(2)})?`)) {
                                                        db.ref(`tables/${tableId}/tip`).set(tipValue);
                                                        alert(`‚úÖ Gorjeta de ${config.currency} ${tipValue.toFixed(2)} adicionada! Obrigado! üíù`);
                                                    }
                                                }}
                                                style={{
                                                    padding:'1.2rem',
                                                    background:'linear-gradient(135deg,#f39c12,#e67e22)',
                                                    border:'none',
                                                    borderRadius:'12px',
                                                    color:'#fff',
                                                    fontWeight:'900',
                                                    cursor:'pointer',
                                                    fontSize:'1rem',
                                                    boxShadow:'0 4px 12px rgba(243,156,18,0.3)'
                                                }}
                                            >
                                                <div style={{fontSize:'1.5rem',marginBottom:'0.3rem'}}>{percent}%</div>
                                                <div style={{fontSize:'0.85rem'}}>{config.currency} {tipValue.toFixed(2)}</div>
                                            </button>
                                        );
                                    })}
                                </div>
                                <button 
                                    onClick={() => {
                                        const customTip = parseFloat(prompt('Digite o valor da gorjeta:'));
                                        if (customTip && customTip > 0) {
                                            db.ref(`tables/${tableId}/tip`).set(customTip);
                                            alert(`‚úÖ Gorjeta de ${config.currency} ${customTip.toFixed(2)} adicionada! Obrigado! üíù`);
                                        }
                                    }}
                                    style={{
                                        width:'100%',
                                        marginTop:'1rem',
                                        padding:'1rem',
                                        background:'#6c757d',
                                        border:'none',
                                        borderRadius:'10px',
                                        color:'#fff',
                                        fontWeight:'800',
                                        cursor:'pointer'
                                    }}
                                >
                                    üí∞ Outro Valor
                                </button>
                            </div>
                        )}
                        
                        {table.orders && table.orders.length > 0 && (
                            <>
                                <h3 style={{marginBottom:'1rem',color:'#4a9d4e'}}>‚úì Confirmados</h3>
                                {table.orders.map((o, i) => (
                                    <div key={i} style={{background:'#f9f9f9',borderRadius:'12px',padding:'1rem',marginBottom:'1rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                                        <span style={{fontSize:'2rem'}}>{o.image}</span>
                                        <div style={{flex:1}}>
                                            <div style={{fontWeight:'800'}}>{o.name}</div>
                                            <div style={{color:'#666'}}>Qtd: {o.quantity}</div>
                                        </div>
                                        <div style={{fontWeight:'800',color:'#d4a574'}}>{config.currency} {(o.price * o.quantity).toFixed(2)}</div>
                                    </div>
                                ))}
                                
                                {/* BOT√ÉO SOLICITAR FECHAMENTO */}
                                <button
                                    onClick={() => {
                                        if (table.pending && table.pending.length > 0) {
                                            alert('‚ö†Ô∏è Voc√™ ainda tem pedidos pendentes de confirma√ß√£o. Aguarde a confirma√ß√£o antes de solicitar o fechamento da conta.');
                                            return;
                                        }
                                        
                                        const wantToPay = confirm('üí∞ Deseja solicitar o fechamento da conta agora?');
                                        if (!wantToPay) return;
                                        
                                        // Chamar gar√ßom para fechar a conta
                                        db.ref(`tables/${tableId}/callWaiter`).set(true);
                                        playSound();
                                        alert('‚úÖ Solicita√ß√£o enviada! O gar√ßom vir√° fechar sua conta em breve.\n\nüíù Dica: Voc√™ pode adicionar gorjeta acima antes de chamar!');
                                        setTab('call');
                                    }}
                                    style={{
                                        width:'100%',
                                        padding:'1.5rem',
                                        marginTop:'2rem',
                                        background:'linear-gradient(135deg,#4a9d4e,#45a049)',
                                        border:'none',
                                        borderRadius:'16px',
                                        color:'#fff',
                                        fontWeight:'900',
                                        fontSize:'1.2rem',
                                        cursor:'pointer',
                                        boxShadow:'0 6px 20px rgba(74,157,78,0.4)',
                                        transition:'all 0.3s'
                                    }}
                                    onMouseDown={e => e.currentTarget.style.transform = 'scale(0.97)'}
                                    onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                                >
                                    üí∞ SOLICITAR FECHAMENTO DA CONTA
                                </button>
                            </>
                        )}
                    </div>
                )}
                
                {tab === 'call' && (
                    <div style={{textAlign:'center',paddingTop:'3rem'}}>
                        <div style={{fontSize:'6rem',marginBottom:'2rem'}}>üîî</div>
                        <h2 style={{fontSize:'2rem',fontWeight:'900',marginBottom:'1rem'}}>Precisa de Ajuda?</h2>
                        <p style={{color:'#666',fontSize:'1.1rem',marginBottom:'3rem'}}>Chame o gar√ßom que ele vir√° atend√™-lo</p>
                        
                        {table.callWaiter ? (
                            <div style={{background:'#fff3cd',border:'2px solid #f39c12',padding:'2rem',borderRadius:'16px',marginBottom:'2rem'}}>
                                <div style={{fontSize:'3rem',marginBottom:'1rem'}}>‚è≥</div>
                                <h3 style={{color:'#f39c12',fontSize:'1.5rem',fontWeight:'900',marginBottom:'0.5rem'}}>Gar√ßom Chamado!</h3>
                                <p style={{color:'#856404'}}>Aguarde, ele j√° vem atend√™-lo.</p>
                                <button 
                                    onClick={() => db.ref(`tables/${tableId}/callWaiter`).set(false)}
                                    style={{marginTop:'1.5rem',padding:'1rem 2rem',background:'#6c757d',border:'none',borderRadius:'10px',color:'#fff',fontWeight:'800',cursor:'pointer'}}
                                >
                                    CANCELAR CHAMADA
                                </button>
                            </div>
                        ) : (
                            <button 
                                onClick={callWaiter}
                                style={{
                                    background:'linear-gradient(135deg,#f39c12,#e67e22)',
                                    border:'none',
                                    padding:'2rem 3rem',
                                    borderRadius:'20px',
                                    color:'#fff',
                                    fontWeight:'900',
                                    fontSize:'1.5rem',
                                    cursor:'pointer',
                                    boxShadow:'0 8px 20px rgba(243,156,18,0.4)',
                                    transition:'all 0.3s'
                                }}
                                onMouseDown={e => e.currentTarget.style.transform = 'scale(0.95)'}
                                onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                üîî CHAMAR GAR√áOM
                            </button>
                        )}
                    </div>
                )}
                
                {tab === 'chat' && (
                    <div style={{maxWidth:'600px',margin:'0 auto'}}>
                        <div style={{textAlign:'center',padding:'2rem 0 1rem'}}>
                            <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üí¨</div>
                            <h2 style={{fontSize:'1.8rem',fontWeight:'900',marginBottom:'0.5rem',color:'#3498db'}}>Chat com o Balc√£o</h2>
                            <p style={{color:'#666',fontSize:'0.9rem'}}>Envie mensagens diretas para o atendimento</p>
                        </div>
                        
                        {/* √Årea de Mensagens */}
                        <div style={{
                            background:'#f5f5f5',
                            borderRadius:'20px',
                            padding:'1.5rem',
                            minHeight:'400px',
                            maxHeight:'500px',
                            overflowY:'auto',
                            marginBottom:'1.5rem',
                            border:'2px solid #e0e0e0'
                        }}>
                            {(!table.messages || table.messages.length === 0) ? (
                                <div style={{textAlign:'center',padding:'3rem',color:'#999'}}>
                                    <div style={{fontSize:'3rem',marginBottom:'1rem'}}>üì≠</div>
                                    <p>Nenhuma mensagem ainda</p>
                                    <p style={{fontSize:'0.9rem',marginTop:'0.5rem'}}>Envie uma mensagem para come√ßar!</p>
                                </div>
                            ) : (
                                <div>
                                    {table.messages.map((msg, idx) => (
                                        <div 
                                            key={idx}
                                            style={{
                                                display:'flex',
                                                justifyContent: msg.from === 'customer' ? 'flex-end' : 'flex-start',
                                                marginBottom:'1rem'
                                            }}
                                        >
                                            <div style={{
                                                maxWidth:'70%',
                                                padding:'1rem 1.2rem',
                                                borderRadius: msg.from === 'customer' ? '20px 20px 5px 20px' : '20px 20px 20px 5px',
                                                background: msg.from === 'customer' ? 'linear-gradient(135deg, #3498db, #2980b9)' : '#fff',
                                                color: msg.from === 'customer' ? '#fff' : '#000',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                                wordBreak:'break-word'
                                            }}>
                                                {msg.from !== 'customer' && (
                                                    <div style={{fontSize:'0.75rem',fontWeight:'700',marginBottom:'0.3rem',opacity:0.8}}>
                                                        {msg.senderName || 'Balc√£o'}
                                                    </div>
                                                )}
                                                <div style={{fontSize:'0.95rem',marginBottom:'0.3rem'}}>
                                                    {msg.text}
                                                </div>
                                                <div style={{
                                                    fontSize:'0.7rem',
                                                    opacity:0.7,
                                                    textAlign:'right'
                                                }}>
                                                    {new Date(msg.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={chatEndRef} />
                                </div>
                            )}
                        </div>
                        
                        {/* Input de Mensagem */}
                        <div style={{
                            display:'flex',
                            gap:'0.8rem',
                            background:'#fff',
                            padding:'1rem',
                            borderRadius:'20px',
                            border:'2px solid #e0e0e0',
                            position:'sticky',
                            bottom:'20px'
                        }}>
                            <input 
                                type="text"
                                value={chatMessage}
                                onChange={e => setChatMessage(e.target.value)}
                                onKeyPress={e => {if (e.key === 'Enter') sendMessage();}}
                                placeholder="Digite sua mensagem..."
                                style={{
                                    flex:1,
                                    padding:'1rem 1.2rem',
                                    border:'none',
                                    background:'#f5f5f5',
                                    borderRadius:'15px',
                                    fontSize:'1rem',
                                    outline:'none'
                                }}
                            />
                            <button 
                                onClick={sendMessage}
                                disabled={!chatMessage.trim()}
                                style={{
                                    padding:'1rem 1.5rem',
                                    background: chatMessage.trim() ? 'linear-gradient(135deg, #3498db, #2980b9)' : '#ccc',
                                    border:'none',
                                    borderRadius:'15px',
                                    color:'#fff',
                                    fontSize:'1.3rem',
                                    cursor: chatMessage.trim() ? 'pointer' : 'not-allowed',
                                    transition:'all 0.3s',
                                    boxShadow: chatMessage.trim() ? '0 4px 15px rgba(52,152,219,0.3)' : 'none'
                                }}
                            >
                                üì§
                            </button>
                        </div>
                    </div>
                )}
            </main>
            
            {cart.length > 0 && (
                <div style={{position:'fixed',bottom:'20px',left:'20px',right:'20px',maxWidth:'500px',margin:'0 auto',zIndex:1000}}>
                    <button onClick={() => setShow(true)} style={{width:'100%',background:'linear-gradient(135deg,#d4a574,#8B4513)',border:'none',padding:'1.5rem',borderRadius:'50px',color:'#fff',fontWeight:'900',cursor:'pointer',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:'1.1rem'}}>
                        <span>üõí CARRINHO</span>
                        <span style={{background:'#fff',color:'#d4a574',width:'35px',height:'35px',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center'}}>{cart.length}</span>
                    </button>
                </div>
            )}
            
            {show && (
                <div onClick={() => setShow(false)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.8)',zIndex:2000,display:'flex',alignItems:'flex-end'}}>
                    <div onClick={e => e.stopPropagation()} style={{background:'#fff',borderRadius:'28px 28px 0 0',width:'100%',maxHeight:'85vh',overflow:'auto'}}>
                        <div style={{position:'sticky',top:0,background:'#fff',padding:'2rem',borderBottom:'2px solid #e0e0e0',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                            <h3 style={{fontSize:'1.5rem',fontWeight:'900'}}>Carrinho</h3>
                            <button onClick={() => setShow(false)} style={{background:'#f5f5f5',border:'none',width:'40px',height:'40px',borderRadius:'50%',cursor:'pointer',fontSize:'1.5rem'}}>√ó</button>
                        </div>
                        <div style={{padding:'2rem'}}>
                            {cart.map(i => (
                                <div key={i.id} style={{background:'#f9f9f9',borderRadius:'16px',padding:'1.2rem',marginBottom:'1rem',display:'flex',alignItems:'center',gap:'1rem'}}>
                                    <span style={{fontSize:'2.5rem'}}>{i.image}</span>
                                    <div style={{flex:1}}>
                                        <div style={{fontWeight:'800'}}>{i.name}</div>
                                        <div style={{color:'#d4a574',fontWeight:'800'}}>{config.currency} {(i.price * i.quantity).toFixed(2)}</div>
                                    </div>
                                    <div style={{display:'flex',alignItems:'center',gap:'1rem',background:'#fff',padding:'0.5rem 1rem',borderRadius:'25px'}}>
                                        <button onClick={() => {
                                            if (i.quantity > 1) setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity - 1} : x));
                                            else setCart(cart.filter(x => x.id !== i.id));
                                        }} style={{background:'#d4a574',border:'none',width:'32px',height:'32px',borderRadius:'50%',color:'#fff',fontSize:'1.2rem',cursor:'pointer'}}>‚àí</button>
                                        <span style={{fontWeight:'900',minWidth:'30px',textAlign:'center'}}>{i.quantity}</span>
                                        <button onClick={() => setCart(cart.map(x => x.id === i.id ? {...x, quantity: x.quantity + 1} : x))} style={{background:'#d4a574',border:'none',width:'32px',height:'32px',borderRadius:'50%',color:'#fff',fontSize:'1.2rem',cursor:'pointer'}}>+</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div style={{position:'sticky',bottom:0,background:'#fff',padding:'2rem',borderTop:'2px solid #e0e0e0'}}>
                            <button onClick={addOrder} style={{width:'100%',background:'linear-gradient(135deg,#4a9d4e,#45a049)',border:'none',padding:'1.2rem',borderRadius:'12px',color:'#fff',fontWeight:'900',fontSize:'1.1rem',cursor:'pointer'}}>ENVIAR PEDIDO</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
<style>
@keyframes blink {
    0%, 100% { border-color: #e74c3c; box-shadow: 0 0 20px rgba(231,76,60,0.5); }
    50% { border-color: #c0392b; box-shadow: 0 0 40px rgba(231,76,60,0.8); }
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>
</body>
</html>
